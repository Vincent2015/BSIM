function SNSBaseList(){this._list;this._size=0}SNSBaseList.prototype.size=function(){return this._size};SNSBaseList.prototype._get=function(a){return this.get(a)};SNSBaseList.prototype._add=function(a,c){return this.add(a,c)};SNSBaseList.prototype._update=function(a,c){this.update(a,c)};SNSBaseList.prototype._remove=function(a){return this.remove(a)};SNSBaseList.prototype._contains=function(a){return this.contains(a)};
SNSBaseList.prototype.add=function(a,c){if(this._contains(a))return this._list[a]=c,!1;this._size++;this._list&&null!=this._list||(this._list={});this._list[a]=c;return!0};SNSBaseList.prototype.update=function(a,c){if(!this._contains(a))return this.add(a,c),!0;this._list[a]=c};SNSBaseList.prototype.contains=function(a){return void 0!=this._list&&void 0!=this._list[a]};SNSBaseList.prototype.get=function(a){if(this._list&&null!=this._list)return this._list[a]};
SNSBaseList.prototype.remove=function(a){if(this._contains(a))return delete this._list[a],this._size--,!0};SNSBaseList.prototype.removeAll=function(a){this._list={};this._size=0};SNSBaseList.prototype.toArray=function(){var a=[],c;for(c in this._list)this._list[c]&&"function"!=typeof this._list[c]&&a.push(this._list[c]);return a};
(function(){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(c,d){var e=[],f;d=d||a.length;if(c)for(f=0;f<c;f++)e[f]=a[0|Math.random()*d];else{var g;e[8]=e[13]=e[18]=e[23]="-";e[14]="4";for(f=0;36>f;f++)e[f]||(g=0|16*Math.random(),e[f]=a[19==f?g&3|8:g])}return e.join("")};Math.uuidFast=function(){for(var c=Array(36),d=0,e,f=0;36>f;f++)8==f||13==f||18==f||23==f?c[f]="-":14==f?c[f]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),e=d&15,d>>=4,c[f]=
a[19==f?e&3|8:e]);return c.join("")};Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var d=16*Math.random()|0;return("x"==a?d:d&3|8).toString(16)})}})();String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")};String.prototype.ltrim=function(){return this.replace(/(^\s*)/g,"")};String.prototype.rtrim=function(){return this.replace(/(\s*$)/g,"")};String.prototype.notEmpty=function(){return null!=this&&""!=this.trim()};
String.prototype.isEmpty=function(){return!this.notEmpty()};String.prototype.endWith=function(a){return null==a||""==a||0==this.length||a.length>this.length?!1:this.substring(this.length-a.length)==a?!0:!1};String.prototype.startWith=function(a){return null==a||""==a||0==this.length||a.length>this.length?!1:this.substr(0,a.length)==a?!0:!1};Object.clone=function(a){if("object"!==typeof a)return a;var c={};a.constructor==Array&&(c=[]);for(var d in a)c[d]=a[d]?Object.clone(a[d]):null;return c};
Date.now||(Date.now=function(){return(new Date).getTime()});
Date.prototype.format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var d in c)(new RegExp("("+d+")")).test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?c[d]:("00"+c[d]).substr((""+c[d]).length)));return a};
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var c=Array.prototype.slice.call(arguments,1),d=this,e=function(){},f=function(){return d.apply(this instanceof e&&a?this:a,c.concat(Array.prototype.slice.call(arguments)))};e.prototype=this.prototype;f.prototype=new e;return f});
var SNSStroageItem=function(a){this.user=YYIMChat.getUserNode();this.id=SNSStorage.id;this.timestamp=(new Date).getTime();this.val=a},SNSStorage={TYPE:{SESSION:"session",LOCAL:"local"}};SNSStorage.id=Math.uuid();SNSStorage.setLocal=function(a,c){this._set(this.TYPE.LOCAL,a,c)};SNSStorage.appendLocal=function(a,c){this._append(this.TYPE.LOCAL,a,c)};SNSStorage.deleteLocalItem=function(a,c){this._deleteItem(this.TYPE.LOCAL,a,c)};SNSStorage.getLocal=function(a,c){return this._get(this.TYPE.LOCAL,a,c)};
SNSStorage.getLocalVal=function(a,c){var d=this.getLocal(a,c);if(d)return d.val?d.val:"string"==typeof d?d:c};SNSStorage.removeLocal=function(a){this._remove(this.TYPE.LOCAL,a)};SNSStorage.clearLocal=function(){this._clear(this.TYPE.LOCAL)};SNSStorage.setSession=function(a,c){this._set(this.TYPE.SESSION,a,c)};SNSStorage.getSession=function(a,c){return this._get(this.TYPE.SESSION,a,c)};SNSStorage.removeSession=function(a){this._remove(this.TYPE.SESSION,a)};SNSStorage.clearSession=function(){this._clear(this.TYPE.SESSION)};
SNSStorage._set=function(a,c,d){switch(a){case this.TYPE.LOCAL:store.set(c,JSON.stringify(new SNSStroageItem(d)));break;case this.TYPE.SESSION:sessionStorage.setItem(c,JSON.stringify(new SNSStroageItem(d)));break;default:YYIMChat.log("invalid storage type",0,a)}};
SNSStorage._append=function(a,c,d){YYIMChat.log("append storage",3,c,d);if("string"!=typeof d)YYIMChat.log("append storage: invalid val",3,d);else{var e=this._get(a,c);e?(e=e.val,-1==e.indexOf(d)&&this._set(a,c,e+"|"+d)):this._set(a,c,"|"+d);return this._get(a,c)}};SNSStorage._deleteItem=function(a,c,d){if("string"!=typeof d)YYIMChat.log("_deleteItem storage: invalid val",3,d);else{var e=this._get(a,c).val;e&&this._set(a,c,e.replace("|"+d,""));return this._get(a,c)}};
SNSStorage._get=function(a,c,d){var e;switch(a){case this.TYPE.LOCAL:e=JSON.parse(store.get(c));break;case this.TYPE.SESSION:e=JSON.parse(sessionStorage.getItem(c));break;default:YYIMChat.log("invalid storage type",0,a)}return null==e?d:e};SNSStorage._remove=function(a,c){try{switch(a){case this.TYPE.LOCAL:store.remove(c);break;case this.TYPE.SESSION:sessionStorage.removeItem(c);break;default:YYIMChat.log("invalid storage type",0,a)}}catch(d){YYIMChat.log("Storage remove error : "+d,1,a)}};
SNSStorage._clear=function(a){YYIMChat.log("clear storage",1,a);switch(a){case this.TYPE.LOCAL:store.clear();break;case this.TYPE.SESSION:sessionStorage.clear();break;default:YYIMChat.log("invalid storage type",0,a)}};"object"!==typeof JSON&&(JSON={});
(function(){function a(a){return 10>a?"0"+a:a}function c(a){f.lastIndex=0;return f.test(a)?'"'+a.replace(f,function(a){var c=r[a];return"string"===typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function d(a,e){var f,r,w,x,u=g,B,q=e[a];q&&"object"===typeof q&&"function"===typeof q.toJSON&&(q=q.toJSON(a));"function"===typeof l&&(q=l.call(e,a,q));switch(typeof q){case "string":return c(q);case "number":return isFinite(q)?String(q):"null";case "boolean":case "null":return String(q);
case "object":if(!q)return"null";g+=h;B=[];if("[object Array]"===Object.prototype.toString.apply(q)){x=q.length;for(f=0;f<x;f+=1)B[f]=d(f,q)||"null";w=0===B.length?"[]":g?"[\n"+g+B.join(",\n"+g)+"\n"+u+"]":"["+B.join(",")+"]";g=u;return w}if(l&&"object"===typeof l)for(x=l.length,f=0;f<x;f+=1)"string"===typeof l[f]&&(r=l[f],(w=d(r,q))&&B.push(c(r)+(g?": ":":")+w));else for(r in q)Object.prototype.hasOwnProperty.call(q,r)&&(w=d(r,q))&&B.push(c(r)+(g?": ":":")+w);w=0===B.length?"{}":g?"{\n"+g+B.join(",\n"+
g)+"\n"+u+"}":"{"+B.join(",")+"}";g=u;return w}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var e,f,g,h,r,l;"function"!==typeof JSON.stringify&&(f=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
r={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},JSON.stringify=function(a,c,e){var f;h=g="";if("number"===typeof e)for(f=0;f<e;f+=1)h+=" ";else"string"===typeof e&&(h=e);if((l=c)&&"function"!==typeof c&&("object"!==typeof c||"number"!==typeof c.length))throw Error("JSON.stringify");return d("",{"":a})});"function"!==typeof JSON.parse&&(e=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,JSON.parse=function(a,
c){function d(a,e){var f,g,h=a[e];if(h&&"object"===typeof h)for(f in h)Object.prototype.hasOwnProperty.call(h,f)&&(g=d(h,f),void 0!==g?h[f]=g:delete h[f]);return c.call(a,e,h)}var f;a=String(a);e.lastIndex=0;e.test(a)&&(a=a.replace(e,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return f=
eval("("+a+")"),"function"===typeof c?d({"":f},""):f;throw new SyntaxError("JSON.parse");})})();
var store=function(){var a={},c=window,d=c.document,e;a.set=function(a,c){};a.get=function(a){};a.remove=function(a){};a.clear=function(){};if("localStorage"in c&&c.localStorage)e=c.localStorage,a.set=function(a,c){e.setItem(a,c)},a.get=function(a){return e.getItem(a)},a.remove=function(a){e.removeItem(a)},a.clear=function(){e.clear()};else if("globalStorage"in c&&c.globalStorage)e=c.globalStorage[c.location.hostname],a.set=function(a,c){e[a]=c},a.get=function(a){return e[a]&&e[a].value},a.remove=
function(a){delete e[a]},a.clear=function(){for(var a in e)delete e[a]};else if(d.documentElement.addBehavior){var f=function(){if(e)return e;e=d.body.appendChild(d.createElement("div"));e.style.display="none";e.addBehavior("#default#userData");e.load("localStorage");return e};a.set=function(a,c){var d=f();d.setAttribute(a,c);d.save("localStorage")};a.get=function(a){return f().getAttribute(a)};a.remove=function(a){var c=f();c.removeAttribute(a);c.save("localStorage")};a.clear=function(){var a=f(),
c=a.XMLDocument.documentElement.attributes;a.load("localStorage");for(var d=0,e;e=c[d];d++)a.removeAttribute(e.name);a.save("localStorage")}}return a}(),YYIMCommonUtil={isFunction:function(a){return"function"==typeof a},isStringAndNotEmpty:function(a){return"string"==typeof a?a.notEmpty():!1},chatNumInString:function(a,c){if("string"==typeof a&&"string"==typeof c){var d=a.match(new RegExp("\\"+c,"gi"));if(d)return d.length}return 0},isNumber:function(a){return"[object Number]"===Object.prototype.toString.call(a)}},
SNSCommonUtil={isFunction:YYIMCommonUtil.isFunction,isStringAndNotEmpty:YYIMCommonUtil.isStringAndNotEmpty,chatNumInString:YYIMCommonUtil.chatNumInString,isNumber:YYIMCommonUtil.isNumber},YYIMArrayUtil={contains:function(a,c){if("[object Array]"===Object.prototype.toString.call(a))for(var d=0;d<a.length;d++)if(a[d]===c)return!0;return!1},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},unique:function(a){a.sort();for(var c=[a[0]],d=1;d<a.length;d++)a[d]!==c[c.length-
1]&&c.push(a[d]);return c},insert:function(a,c,d){a.splice(c,0,d)}},SNSArrayUtil={contains:YYIMArrayUtil.contains,isArray:YYIMArrayUtil.isArray,unique:YYIMArrayUtil.unique,insert:YYIMArrayUtil.insert},YYIMCookieUtil={getcookie:function(a){for(var c=document.cookie.split(";"),d=c.length,e=0;e<d;e++){var f=c[e].split("=");if(f[0].replace(/(^\s+)|(\s+$)/g,"")==a)return unescape(f[1])}return null},setcookie:function(a,c,d,e,f,g){a=a+"="+escape(c);d&&(d=new Date((new Date).getTime()+6E4*d),a+=";expires="+
d.toGMTString());e&&(a+=";path="+e);f&&(a+=";domain="+f);g&&(a+=";secure");document.cookie=a},delcookie:function(a,c,d){get_cookie(a)&&(a+="=;expires=Fri, 02-Jan-1970 00:00:00 GMT",c&&(a+=";path="+c),d&&(a+=";domain="+d),document.cookie=a)},createComparisonFunction:function(a){return function(c,d){return c[a]-d[a]}}},YYIMRegularUtil={mobile:/^[1][358][0-9]{9}$/,phone:/((\d{11})|^((\d{7,8})|(\d{4}|\d{3})-(\d{7,8})|(\d{4}|\d{3})-(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1}))$)/};
function XmlHttp(){}XmlHttp.create=function(){try{if(window.XMLHttpRequest){var a=new XMLHttpRequest;null===a.readyState&&(a.readyState=1,a.addEventListener("load",function(){a.readyState=4;if("function"==typeof a.onreadystatechange)a.onreadystatechange()},!1));return a}if(window.ActiveXObject)return new ActiveXObject(XmlHttp.getPrefix()+".XmlHttp")}catch(c){}throw Error("Your browser does not support XmlHttp objects");};
XmlHttp.getPrefix=function(){if(XmlHttp.prefix)return XmlHttp.prefix;for(var a=["MSXML2","Microsoft","MSXML","MSXML3"],c=0;c<a.length;c++)try{return new ActiveXObject(a[c]+".XmlHttp"),XmlHttp.prefix=a[c]}catch(d){}throw Error("Could not find an installed XML parser");};function XmlDocument(){}
XmlDocument.create=function(a,c){a=a||"foo";c=c||"";try{var d;document.implementation&&document.implementation.createDocument?(d=document.implementation.createDocument(c,a,null),null===d.readyState&&(d.readyState=1,d.addEventListener("load",function(){d.readyState=4;if("function"==typeof d.onreadystatechange)d.onreadystatechange()},!1))):window.ActiveXObject&&(d=new ActiveXObject(XmlDocument.getPrefix()+".DomDocument"));if(!d.documentElement||d.documentElement.tagName!=a||d.documentElement.namespaceURI&&
d.documentElement.namespaceURI!=c)try{""!==c?d.appendChild(d.createElement(a)).setAttribute("xmlns",c):d.appendChild(d.createElement(a))}catch(e){d=document.implementation.createDocument(c,a,null),null===d.documentElement&&d.appendChild(d.createElement(a)),""!==c&&d.documentElement.getAttribute("xmlns")!=c&&d.documentElement.setAttribute("xmlns",c)}return d}catch(f){}throw Error("Your browser does not support XmlDocument objects");};
XmlDocument.getPrefix=function(){if(XmlDocument.prefix)return XmlDocument.prefix;for(var a=["MSXML2","Microsoft","MSXML","MSXML3"],c=0;c<a.length;c++)try{return new ActiveXObject(a[c]+".DomDocument"),XmlDocument.prefix=a[c]}catch(d){}throw Error("Could not find an installed XML parser");};
"undefined"!=typeof Document&&window.DOMParser&&(Document.prototype.loadXML=function(a){for(a=(new DOMParser).parseFromString(a,"text/xml");this.hasChildNodes();)this.removeChild(this.lastChild);for(var c=0;c<a.childNodes.length;c++)this.appendChild(this.importNode(a.childNodes[c],!0))});
window.XMLSerializer&&window.Node&&Node.prototype&&Node.prototype.__defineGetter__&&(XMLDocument.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Document.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Node.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}));
var JSJaC={Version:"1.4",bind:function(a,c,d){return function(e){return a.apply(c,[e,d])}}},JSJaCBuilder={buildNode:function(a,c,d,e,f){if(d)if(JSJaCBuilder._isStringOrNumber(d)||d instanceof Array)c=this._createElement(a,c,f),JSJaCBuilder._children(a,c,d);else{f=d.xmlns||f;c=this._createElement(a,c,f);for(var g in d)d.hasOwnProperty(g)&&"xmlns"!=g&&c.setAttribute(g,d[g])}else c=this._createElement(a,c,f);e&&JSJaCBuilder._children(a,c,e,f);return c},_createElement:function(a,c,d){try{if(d)return a.createElementNS(d,
c)}catch(e){}a=a.createElement(c);d&&a.setAttribute("xmlns",d);return a},_text:function(a,c){return a.createTextNode(c)},_children:function(a,c,d,e){if("object"==typeof d)for(var f in d){if(d.hasOwnProperty(f)){var g=d[f];"object"==typeof g?(g instanceof Array&&(g=JSJaCBuilder.buildNode(a,g[0],g[1],g[2],e)),c.appendChild(g)):JSJaCBuilder._isStringOrNumber(g)&&c.appendChild(JSJaCBuilder._text(a,g))}}else JSJaCBuilder._isStringOrNumber(d)&&c.appendChild(JSJaCBuilder._text(a,d))},_attributes:function(a){var c=
[],d;for(d in a)a.hasOwnProperty(d)&&c.push(d+'="'+a[d].toString().htmlEnc()+'"');return c.join(" ")},_isStringOrNumber:function(a){return"string"==typeof a||"number"==typeof a}};JSJAC_HAVEKEYS=!0;JSJAC_NKEYS=16;JSJAC_INACTIVITY=300;JSJAC_ERR_COUNT=10;JSJAC_ALLOW_PLAIN=!0;JSJAC_ALLOW_SCRAM=!1;JSJAC_CHECKINQUEUEINTERVAL=JSJAC_CHECKQUEUEINTERVAL=100;JSJAC_TIMERVAL=2E3;JSJAC_RETRYDELAY=5E3;JSJAC_REGID_TIMEOUT=2E4;JSJACHBC_MAX_HOLD=1;JSJACHBC_MAX_WAIT=300;JSJACHBC_BOSH_VERSION="1.10";
JSJACHBC_USE_BOSH_VER=!0;JSJACHBC_MAXPAUSE=120;
function JSJaCConnection(a){a&&a.httpbase&&(this._httpbase=a.httpbase);this.oDbg=a&&a.oDbg&&a.oDbg.log?a.oDbg:{log:function(){}};a&&a.timerval?this.setPollInterval(a.timerval):this.setPollInterval(JSJAC_TIMERVAL);this._cookie_prefix=a&&a.cookie_prefix?a.cookie_prefix:"";this._connected=!1;this._events=[];this._keys=null;this._ID=0;this._IDPrefix="jump"+(new Date).format("yyMMdd")+"_";this._inQ=[];this._pQueue=[];this._regIDs=[];this._req=[];this._status="intialized";this._errcnt=0;this._inactivity=
JSJAC_INACTIVITY;this._sendRawCallbacks=[]}
JSJaCConnection.prototype.connect=function(a){this._setStatus("connecting");this.domain=a.domain||"localhost";this.username=a.username;this.resource=a.resource;this.pass=a.password||a.pass;this.authzid=a.authzid||"";this.register=a.register;this.authhost=a.authhost||a.host||a.domain;this.authtype=a.authtype||"sasl";this._xmllang=a.xmllang&&""!==a.xmllang?a.xmllang:"en";this._allow_plain=a.allow_plain?a.allow_plain:JSJAC_ALLOW_PLAIN;this._allow_scram=a.allow_scram?a.allow_scram:JSJAC_ALLOW_SCRAM;this.host=
a.host;this.port=a.port||5222;this.jid=this.username+"@"+this.domain;this.fulljid=this.jid+"/"+this.resource;this._rid=Math.round(100000.5+799999.99999*Math.random());var c=this._getFreeSlot();this._req[c]=this._setupRequest(!0);a=this._getInitialRequestString();this.oDbg.log(a,4);this._req[c].r.onreadystatechange=JSJaC.bind(function(){var a=this._req[c].r;4==a.readyState&&(this.oDbg.log("async recv: "+a.responseText,4),this._handleInitialResponse(a))},this);"undefined"!=typeof this._req[c].r.onerror&&
(this._req[c].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this));this._req[c].r.send(a)};JSJaCConnection.prototype.connected=function(){return this._connected};
JSJaCConnection.prototype.disconnect=function(){this._setStatus("disconnecting");if(this.connected()){this._connected=!1;clearInterval(this._interval);clearInterval(this._inQto);this._timeout&&clearTimeout(this._timeout);var a=this._getFreeSlot();this._req[a]=this._setupRequest(!1);var c=this._getRequestString(!1,!0);this.oDbg.log("Disconnecting: "+c,4);try{this._req[a].r.send(c)}catch(d){}this.oDbg.log("disconnected");try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(e){}this._handleEvent("ondisconnect")}};
JSJaCConnection.prototype.getPollInterval=function(){return this._timerval};
JSJaCConnection.prototype.registerHandler=function(a,c,d,e){a=a.toLowerCase();var f={handler:arguments[arguments.length-1],ns:"*",type:"*"};2<arguments.length&&(f.ns=arguments[1]);3<arguments.length&&(f.type=arguments[2]);this._events[a]=this._events[a]?this._events[a].concat(f):[f];this._events[a]=this._events[a].sort(function(a,c){var d=0,e=0;"*"==a.type&&d++;"*"==a.ns&&d++;d++;"*"==c.type&&e++;"*"==c.ns&&e++;return d>e?1:d<e?-1:0});this.oDbg.log("registered handler for event '"+a+"'",2);return this};
JSJaCConnection.prototype.unregisterHandler=function(a,c){a=a.toLowerCase();if(!this._events[a])return this;for(var d=this._events[a],e=[],f=0;f<d.length;f++)d[f].handler!=c&&e.push(d[f]);d.length!=e.length&&(this._events[a]=e,this.oDbg.log("unregistered handler for event '"+a+"'",2));return this};JSJaCConnection.prototype.registerIQGet=function(a,c,d){return this.registerHandler("iq",a,c,"get",d)};
JSJaCConnection.prototype.registerIQSet=function(a,c,d){return this.registerHandler("iq",a,c,"set",d)};JSJaCConnection.prototype.resume=function(){try{var a=JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").getValue();this.oDbg.log("read cookie: "+a,2);JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase();return this.resumeFromData(JSJaCJSON.parse(a))}catch(c){}return!1};
JSJaCConnection.prototype.resumeFromData=function(a){try{for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);if(this._keys){this._keys2=new JSJaCKeys;var d=this._keys2._getSuspendVars();for(a=0;a<d.length;a++)this._keys2[d[a]]=this._keys[d[a]];this._keys=this._keys2}this._connected?(this._setStatus("resuming"),this._handleEvent("onresume"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval()),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=
setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL)):this._setStatus("terminated");return!0===this._connected}catch(e){return e.message?this.oDbg.log("Resume failed: "+e.message,1):this.oDbg.log("Resume failed: "+e,1),!1}};
JSJaCConnection.prototype.sendJumpPacket=function(a,c,d){if(!this.connected())return!1;if(!a||!a.opcode)return this.oDbg.log("no jumpPacket: "+a,1),!1;if(c&&this._validateCallbackable(a)){if(!a.content)throw Error("packet content cannot be null when send a Message or IQ packet.");a.content.id||(a.content.id=this._IDPrefix+this._ID++);this._registerPID(a,c,d)}this._pQueue=this._pQueue.concat(a);this._handleEvent("packet_out",a);return!0};JSJaCConnection.prototype.send=function(a,c,d){};
JSJaCConnection.prototype.sendIQ=function(a,c,d){if(!a||"iq"!=a.pType())return!1;c=c||{};var e=c.error_handler||JSJaC.bind(function(a){this.oDbg.log(a.xml(),1)},this),f=c.result_handler||JSJaC.bind(function(a){this.oDbg.log(a.xml(),2)},this);return this.send(a,function(a,c){switch(a.getType()){case "error":e(a);break;case "result":f(a,c)}},d)};JSJaCConnection.prototype.setPollInterval=function(a){a&&!isNaN(a)&&(this._timerval=a);return this._timerval};JSJaCConnection.prototype.status=function(){return this._status};
JSJaCConnection.prototype.suspend=function(){var a=this.suspendToData();try{var c=new JSJaCCookie(this._cookie_prefix+"JSJaC_State",JSJaCJSON.toString(a));this.oDbg.log("writing cookie: "+c.getValue()+"\n(length:"+c.getValue().length+")",2);c.write();var d=JSJaCCookie.get(this._cookie_prefix+"JSJaC_State");return c.getValue()!=d?(this.oDbg.log("Suspend failed writing cookie.\nread: "+d,1),c.erase(),!1):!0}catch(e){this.oDbg.log("Failed creating cookie '"+this._cookie_prefix+"JSJaC_State': "+e.message,
1)}return!1};
JSJaCConnection.prototype.suspendToData=function(){clearTimeout(this._timeout);clearInterval(this._interval);clearInterval(this._inQto);this._suspend();for(var a="_connected _keys _ID _xmllang _inQ _pQueue _regIDs _errcnt _inactivity domain username resource jid fulljid _sid _httpbase _timerval _is_polling".split(" "),a=a.concat(this._getSuspendVars()),c={},d=0;d<a.length;d++)if(this[a[d]]){var e={};if(this[a[d]]._getSuspendVars)for(var f=this[a[d]]._getSuspendVars(),g=0;g<f.length;g++)e[f[g]]=this[a[d]][f[g]];
else e=this[a[d]];c[a[d]]=e}this._connected=!1;this._setStatus("suspending");return c};JSJaCConnection.prototype._abort=function(){clearTimeout(this._timeout);clearInterval(this._inQto);clearInterval(this._interval);this._connected=!1;this._setStatus("aborted");this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");this._handleEvent("onerror",JSJaCError("500","cancel","service-unavailable"))};
JSJaCConnection.prototype._checkInQ=function(){for(var a=0;a<this._inQ.length&&10>a;a++){var c=this._inQ[0],d=c.body,c=c.event;this._inQ=this._inQ.slice(1,this._inQ.length);if(!d){this._handleEvent("packet_in");this._handleEvent(c);break}this._handlePID(d)||(this._handleEvent("packet_in",d),this._handleEvent(c,d))}};JSJaCConnection.prototype._checkQueue=function(){0<this._pQueue.length&&this._process();return!0};
JSJaCConnection.prototype._doAuth=function(){this._sendJumpPacket(this._getAuthPacket(),function(a){a.event==OPCODE.AUTH.KEY&&(a=a.body,200!=a.code?this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")):(this._handleEvent("packet_in",a),this._handleEvent(OPCODE.AUTH.KEY,a),this._handleEvent("onconnect")))});return!0};
JSJaCConnection.prototype._doInBandReg=function(){if("saslanon"!=this.authtype&&"anonymous"!=this.authtype){var a=new JSJaCIQ;a.setType("set");a.setID("reg1");a.appendNode("query",{xmlns:NS_REGISTER},[["username",this.username],["password",this.pass]]);this.send(a,this._doInBandRegDone)}};
JSJaCConnection.prototype._doInBandRegDone=function(a){a&&"error"==a.getType()?(this.oDbg.log("registration failed for "+this.username,0),this._handleEvent("onerror",a.getChild("error"))):(this.oDbg.log(this.username+" registered succesfully",0),this._doAuth())};
JSJaCConnection.prototype._doLegacyAuth=function(){if("nonsasl"!=this.authtype&&"anonymous"!=this.authtype)return!1;var a=new JSJaCIQ;a.setIQ(null,"get","auth1");a.appendNode("query",{xmlns:NS_AUTH},[["username",this.username]]);this.send(a,this._doLegacyAuth2);return!0};
JSJaCConnection.prototype._doLegacyAuth2=function(a){if(a&&"result"==a.getType()){a=null!==a.getChild("digest");var c=new JSJaCIQ;c.setIQ(null,"set","auth2");var d=c.appendNode("query",{xmlns:NS_AUTH},[["username",this.username],["resource",this.resource]]);if(a)d.appendChild(c.buildNode("digest",{xmlns:NS_AUTH},hex_sha1(this.streamid+this.pass)));else if(this._allow_plain)d.appendChild(c.buildNode("password",{xmlns:NS_AUTH},this.pass));else{this.oDbg.log("no valid login mechanism found",1);this.disconnect();
return}this.send(c,this._doLegacyAuthDone)}else a&&"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),this.disconnect()};JSJaCConnection.prototype._doLegacyAuthDone=function(a){"result"!=a.getType()?("error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),this.disconnect()):this._handleEvent("onconnect")};
JSJaCConnection.prototype._doSASLAuth=function(){if("nonsasl"==this.authtype||"anonymous"==this.authtype)return!1;if("undefined"!=typeof this.username&&null!=this.username&&""!=this.username||"saslanon"!=this.authtype){if(this._allow_scram&&this.mechs["SCRAM-SHA-1"]){this.oDbg.log("SASL using mechanism 'SCRAM-SHA-1'",2);this._clientFirstMessageBare="n="+this.username.replace(/=/g,"=3D").replace(/,/g,"=2C")+",r="+JSJaCUtils.cnonce(16);var a;a=this.authzid?"n,a="+this.authzid.replace(/=/g,"=3D").replace(/,/g,
"=2C")+",":"n,,";return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='SCRAM-SHA-1'>"+b64encode(a+this._clientFirstMessageBare)+"</auth>",this._doSASLAuthScramSha1S1)}if(this._allow_plain&&this.mechs.PLAIN)return this.oDbg.log("SASL using mechanism 'PLAIN'",2),a=this.authzid+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass,this.oDbg.log("authenticating with '"+a+"'",2),a=b64encode(a),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>"+
a+"</auth>",this._doSASLAuthDone);this.oDbg.log("No SASL mechanism applied",1);this.authtype="nonsasl"}else{if(this.mechs.ANONYMOUS)return this.oDbg.log("SASL using mechanism 'ANONYMOUS'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>",this._doSASLAuthDone);this.oDbg.log("SASL ANONYMOUS requested but not supported",1)}return!1};
JSJaCConnection.prototype._doSASLAuthScramSha1S1=function(a){if("challenge"!=a.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{a=b64decode(a.firstChild.nodeValue);this.oDbg.log("got challenge: "+a,2);var c={},d=a.split(","),e;for(e in d){var f=d[e].substring(2);c[d[e].substring(0,1)]=f}e=str2rstr_utf8(this.pass);for(var d=b64decode_bin(c.s)+"\x00\x00\x00\u0001",g,f=parseInt(c.i,10),h=0;h<f;h++)d=rstr_hmac_sha1(e,
d),g=JSJaCUtils.xor(g,d);e=this.authzid?"n,a="+this.authzid.replace(/=/g,"=3D").replace(/,/g,"=2C")+",":"n,,";c="c="+b64encode(e)+",r="+c.r;this._saltedPassword=g;g=rstr_hmac_sha1(this._saltedPassword,"Client Key");e=rstr_sha1(g);this._authMessage=this._clientFirstMessageBare+","+a+","+c;a=rstr_hmac_sha1(e,str2rstr_utf8(this._authMessage));a=JSJaCUtils.xor(g,a);a=c+",p="+rstr2b64(a);this.oDbg.log("response: "+a,2);this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(a)+"</response>",
this._doSASLAuthScramSha1S2)}};
JSJaCConnection.prototype._doSASLAuthScramSha1S2=function(a){if("success"!=a.nodeName)this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var c=b64decode(a.firstChild.nodeValue);this.oDbg.log("got success: "+c,2);a={};var c=c.split(","),d;for(d in c){var e=c[d].substring(2);a[c[d].substring(0,1)]=e}d=rstr_hmac_sha1(this._saltedPassword,"Server Key");d=rstr_hmac_sha1(d,str2rstr_utf8(this._authMessage));a=b64decode_bin(a.v);d!==
a?(this.oDbg.log("server auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))}};
JSJaCConnection.prototype._doSASLAuthDigestMd5S1=function(a){if("challenge"!=a.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{a=b64decode(a.firstChild.nodeValue);var c;this.oDbg.log("got challenge: "+a,2);c=a.indexOf('nonce="');-1!==c?(this._nonce=a.substring(c+7),this._nonce=this._nonce.substring(0,this._nonce.indexOf('"')),this.oDbg.log("nonce: "+this._nonce,2),c=a.indexOf('realm="'),-1!==c&&(this._realm=
a.substring(c+7),this._realm=this._realm.substring(0,this._realm.indexOf('"'))),this._realm=this._realm||this.domain,this.oDbg.log("realm: "+this._realm,2),this._digest_uri="xmpp/"+this.domain,this._cnonce=JSJaCUtils.cnonce(14),this._nc="00000001",a=rstr_md5(str2rstr_utf8(this.username+":"+this._realm+":"+this.pass))+":"+this._nonce+":"+this._cnonce,this.authzid&&(a=a+":"+this.authzid),a=rstr2hex(rstr_md5(a)),c=hex_md5("AUTHENTICATE:"+this._digest_uri),a=hex_md5(a+":"+this._nonce+":"+this._nc+":"+
this._cnonce+":auth:"+c),a='username="'+this.username+'",realm="'+this._realm+'",nonce="'+this._nonce+'",cnonce="'+this._cnonce+'",nc='+this._nc+',qop=auth,digest-uri="'+this._digest_uri+'",response='+a+",charset=utf-8",this.authzid&&(a='authzid="'+this.authzid+'",'+a),this.oDbg.log("response: "+a,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(a)+"</response>",this._doSASLAuthDigestMd5S2)):(this.oDbg.log("no valid nonce found, aborting",1),this.disconnect())}};
JSJaCConnection.prototype._doSASLAuthDigestMd5S2=function(a){if("failure"==a.nodeName)a.xml?this.oDbg.log("auth error: "+a.xml,1):this.oDbg.log("auth error",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var c=b64decode(a.firstChild.nodeValue);this.oDbg.log("response: "+c,2);c=c.substring(c.indexOf("rspauth=")+8);this.oDbg.log("rspauth: "+c,2);var d=rstr_md5(str2rstr_utf8(this.username+":"+this._realm+":"+this.pass))+":"+this._nonce+":"+this._cnonce;
this.authzid&&(d=d+":"+this.authzid);var d=rstr2hex(rstr_md5(d)),e=hex_md5(":"+this._digest_uri),d=hex_md5(d+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+e);this.oDbg.log("rsptest: "+d,2);d!=c?(this.oDbg.log("SASL Digest-MD5: server repsonse with wrong rspauth",1),this.disconnect()):"success"==a.nodeName?this._reInitStream(JSJaC.bind(this._doStreamBind,this)):this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>",this._doSASLAuthDone)}};
JSJaCConnection.prototype._doSASLAuthDone=function(a){"success"!=a.nodeName?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))};JSJaCConnection.prototype._doStreamBind=function(){var a=new JSJaCIQ;a.setIQ(null,"set","bind_1");a.appendNode("bind",{xmlns:NS_BIND},[["resource",this.resource]]);this.oDbg.log(a.xml());this.send(a,this._doXMPPSess)};
JSJaCConnection.prototype._doXMPPSess=function(a){"result"!=a.getType()||"error"==a.getType()?(this.disconnect(),"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error"))):(this.fulljid=a.getChildVal("jid"),this.jid=this.fulljid.substring(0,this.fulljid.lastIndexOf("/")),a=new JSJaCIQ,a.setIQ(null,"set","sess_1"),a.appendNode("session",{xmlns:NS_SESSION},[]),this.oDbg.log(a.xml()),this.send(a,this._doXMPPSessDone))};
JSJaCConnection.prototype._doXMPPSessDone=function(a){"result"!=a.getType()||"error"==a.getType()?(this.disconnect(),"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error"))):this._handleEvent("onconnect")};
JSJaCConnection.prototype._handleEvent=function(a,c){a=a.toLowerCase();this.oDbg.log("incoming event '"+a+"'",3);if(this._events[a]){this.oDbg.log("handling event '"+a+"'",2);for(var d=0;d<this._events[a].length;d++){var e=this._events[a][d];if("function"==typeof e.handler)if(c){if("*"==e.ns||c.ns==e.ns)if("*"==e.type||c.type==e.type)if(this.oDbg.log(e.ns+"/"+e.type+" => match for handler "+e.handler,3),e.handler(c))break}else if(e.handler())break}}};
JSJaCConnection.prototype._handlePID=function(a){if(!a.id)return!1;var c=this.jid,d=a.id;if(this._regIDs[c]&&this._regIDs[c][d]){this.oDbg.log("handling id "+d,3);var e=this._regIDs[c][d];if(!1===e.cb.call(this,a,e.arg))return!1;delete this._regIDs[c][d];return!0}this.oDbg.log("not handling id '"+d+"' from jid "+c,1);return!1};
JSJaCConnection.prototype._handleResponse=function(a){if(a=this._parseResponse(a)){if(this._sendRawCallbacks.length){var c=this._sendRawCallbacks[0];this._sendRawCallbacks=this._sendRawCallbacks.slice(1,this._sendRawCallbacks.length);c.fn.call(this,a,c.arg)}this._inQ=this._inQ.concat(a)}};
JSJaCConnection.prototype._parseStreamFeatures=function(a){if(!a)return this.oDbg.log("nothing to parse ... aborting",1),!1;var c,d;if(a.getElementsByTagNameNS)c=a.getElementsByTagNameNS(NS_STREAM,"error").item(0);else{var e=a.getElementsByTagName("error");for(d=0;d<e.length;d++)if(e.item(d).namespaceURI==NS_STREAM||e.item(d).getAttribute("xmlns")==NS_STREAM){c=e.item(d);break}}if(c)return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),
this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),!1;this.mechs={};a=a.getElementsByTagName("mechanisms");if(!a.length)return!1;this.has_sasl=!1;for(d=0;d<a.length;d++)if(a.item(d).getAttribute("xmlns")==NS_SASL){this.has_sasl=!0;d=a.item(d).getElementsByTagName("mechanism");for(a=0;a<d.length;a++)this.mechs[d.item(a).firstChild.nodeValue]=!0;break}this.has_sasl?this.oDbg.log("SASL detected",
2):this.oDbg.log("No support for SASL detected",2);return!0};
JSJaCConnection.prototype._process=function(a){if(this.connected()){this.setPollInterval(a);this._timeout&&clearTimeout(this._timeout);var c=this._getFreeSlot();if(!(0>c))if("undefined"!=typeof this._req[c]&&"undefined"!=typeof this._req[c].r&&4!=this._req[c].r.readyState)this.oDbg.log("Slot "+c+" is not ready");else if(!this.isPolling()&&0===this._pQueue.length&&this._req[(c+1)%2]&&4!=this._req[(c+1)%2].r.readyState)this.oDbg.log("all slots busy, standby ...",2);else{this.isPolling()||this.oDbg.log("Found working slot at "+
c,2);a=this._getRequestPacket();this._req[c]=a instanceof JumpPacket?this._setupJumpRequest(!0):this._setupRequest(!0);this._req[c].r.onreadystatechange=JSJaC.bind(function(){this.connected()&&4==this._req[c].r.readyState&&(this.oDbg.log("async recv: "+this._req[c].r.responseText,4),this._handleResponse(this._req[c]),this._setStatus("processing"),this._pQueue.length?this._timeout=setTimeout(JSJaC.bind(this._process,this),100):(this.oDbg.log("scheduling next poll in "+this.getPollInterval()+" msec",
4),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())))},this);try{this._req[c].r.onerror=JSJaC.bind(function(){this.connected()&&(this._errcnt++,this.oDbg.log("XmlHttpRequest error ("+this._errcnt+")",1),this._errcnt>JSJAC_ERR_COUNT?this._abort():(this._setStatus("onerror_fallback"),setTimeout(JSJaC.bind(this._repeat,this),JSJAC_RETRYDELAY)))},this)}catch(d){}"undefined"!=typeof this._rid&&(this._req[c].rid=this._rid);a instanceof JumpPacket?this._buildAndSend(a,this._req[c].r):
this._req[c].r.send(a&&a.xml?a.xml:this._getRequestString())}}else this.oDbg.log("Connection lost ...",1),this._interval&&clearInterval(this._interval)};
JSJaCConnection.prototype._registerPID=function(a,c,d){this.oDbg.log("registering id for packet "+JSON.stringify(a.content),3);a=a.content.id;if(!a)return this.oDbg.log("id missing",1),!1;if("function"!=typeof c)return this.oDbg.log("callback is not a function",1),!1;var e=this.jid;this._regIDs[e]||(this._regIDs[e]={});if(null!=this._regIDs[e][a])return this.oDbg.log("id already registered: "+a,1),!1;this._regIDs[e][a]={cb:c,arg:d,ts:JSJaCUtils.now()};this.oDbg.log("registered id "+a,3);this._cleanupRegisteredPIDs();
return!0};JSJaCConnection.prototype._cleanupRegisteredPIDs=function(){var a=Date.now(),c;for(c in this._regIDs)if(this._regIDs.hasOwnProperty(c))for(var d in this._regIDs[c])this._regIDs[c].hasOwnProperty(d)&&this._regIDs[c][d].ts+JSJAC_REGID_TIMEOUT<a&&(this.oDbg.log("deleting registered id '"+d+"' due to timeout",1),delete this._regIDs[c][d])};JSJaCConnection.prototype._prepSendEmpty=function(a,c){return function(){c._sendEmpty(JSJaC.bind(a,c))}};
JSJaCConnection.prototype._sendEmpty=function(a){var c=this._getFreeSlot();this._req[c]=this._setupRequest(!0);this._req[c].r.onreadystatechange=JSJaC.bind(function(){4==this._req[c].r.readyState&&(this.oDbg.log("async recv: "+this._req[c].r.responseText,4),a(this._req[c].r))},this);"undefined"!=typeof this._req[c].r.onerror&&(this._req[c].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this));var d=this._getRequestString();this.oDbg.log("sending: "+d,4);this._req[c].r.send(d)};
JSJaCConnection.prototype._sendJumpPacket=function(a,c,d){c&&this._sendRawCallbacks.push({fn:c,arg:d});this._pQueue.push(a);this._process();return!0};JSJaCConnection.prototype._sendRaw=function(a,c,d){c&&this._sendRawCallbacks.push({fn:c,arg:d});this._pQueue.push(a);this._process();return!0};JSJaCConnection.prototype._setStatus=function(a){a&&""!==a&&a!=this._status&&(this._status=a,this._handleEvent("onstatuschanged",a),this._handleEvent("status_changed",a))};
JSJaCConnection.prototype._buildAndSend=function(a,c){var d=null,e=null==a.content||"undefined"==typeof a.content,d=JSON.stringify(a.content),d=this._stringToBytes(d),f=new Uint8Array(PACKET_HEADER_SIZE);f.set(this._numToBytes(a.sFrame,PACKET_STRUCT.CONSOLE_FRAME.SIZE),PACKET_STRUCT.CONSOLE_FRAME.START);f.set(this._numToBytes(a.opcode,PACKET_STRUCT.OPCODE.SIZE),PACKET_STRUCT.OPCODE.START);e?f.set(this._numToBytes(0,PACKET_STRUCT.PACKET_LEN.SIZE),PACKET_STRUCT.PACKET_LEN.START):f.set(this._numToBytes(d.length,
PACKET_STRUCT.PACKET_LEN.SIZE),PACKET_STRUCT.PACKET_LEN.START);f.set(this._numToBytes(a.version,PACKET_STRUCT.VERSION.SIZE),PACKET_STRUCT.VERSION.START);f.set(this._numToBytes(a.seqId,PACKET_STRUCT.SEQ_ID.SIZE),PACKET_STRUCT.SEQ_ID.START);e=e?f:this._concatUint8Array(f,new Uint8Array(d));e=e.subarray(0,e.byteLength);e=arr2b64(e);c.send(e)};JSJaCConnection.prototype._validateCallbackable=function(a){return this._isIQPacket(a.opcode)||this._isMessagePacket(a.opcode)||this._isPresencePacket(a.opcode)};
JSJaCConnection.prototype._isMessagePacket=function(a){return a>=OPCODE.MESSAGE_RANGE.START&&a<OPCODE.MESSAGE_RANGE.END};JSJaCConnection.prototype._isIQPacket=function(a){return a>=OPCODE.IQ_RANGE.START&&a<OPCODE.IQ_RANGE.END};JSJaCConnection.prototype._isPresencePacket=function(a){return a>=OPCODE.PRESENCE_RANGE.START&&a<OPCODE.PRESENCE_RANGE.END};JSJaCConnection.prototype._concatUint8Array=function(a,c){var d=new Uint8Array(a.length+c.length);d.set(a,0);d.set(c,a.length);return d};
JSJaCConnection.prototype._numToBytes=function(a,c){var d=new Uint8Array(c),e=c;do d[--e]=a&255,a>>=8;while(e);return d};JSJaCConnection.prototype._uint8ArrayToString=function(a){var c,d,e,f,g,h;c="";e=a.length;for(d=0;d<e;)switch(f=a[d++],f>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:c+=String.fromCharCode(f);break;case 12:case 13:g=a[d++];c+=String.fromCharCode((f&31)<<6|g&63);break;case 14:g=a[d++],h=a[d++],c+=String.fromCharCode((f&15)<<12|(g&63)<<6|(h&63)<<0)}return c};
JSJaCConnection.prototype._bytesToInteger=function(a){for(var c=0,d=0;d<a.length;++d)c+=a[d],d<a.length-1&&(c<<=8);return c};JSJaCConnection.prototype._stringToBytes=function(a){for(var c=[],d=0;d<a.length;d++){var e=a.charCodeAt(d);128>e?c.push(e):2048>e?c.push(192|e>>6,128|e&63):55296>e||57344<=e?c.push(224|e>>12,128|e>>6&63,128|e&63):(d++,e=65536+((e&1023)<<10|a.charCodeAt(d)&1023),c.push(240|e>>18,128|e>>12&63,128|e>>6&63,128|e&63))}return c};
JSJaCConnection.prototype._getAuthPacket=function(){return new JumpPacket({usr:this.username,atk:this.pass,br:this.resource},OPCODE.AUTH.SEND)};
function JSJaCConsoleLogger(a){this.level=a||4;this.start=function(){};this.log=function(a,d){d=d||0;if(!(d>this.level)&&"undefined"!=typeof console)try{switch(d){case 0:console.warn(a);break;case 1:console.error(a);break;case 2:console.info(a);break;case 4:console.debug(a);break;default:console.log(a)}}catch(e){try{console.log(a)}catch(f){}}};this.setLevel=function(a){this.level=a;return this};this.getLevel=function(){return this.level}}
var NS_ORGANIZATION="http://jabber.org/protocol/org",NS_DISCO_ITEMS="http://jabber.org/protocol/disco#items",NS_DISCO_INFO="http://jabber.org/protocol/disco#info",NS_VCARD="vcard-temp",NS_VCARD_UPDATE="vcard-temp:x:update",NS_AUTH="jabber:iq:auth",NS_AUTH_ERROR="jabber:iq:auth:error",NS_REGISTER="jabber:iq:register",NS_SEARCH="jabber:iq:search",NS_ROSTER="jabber:iq:roster",NS_PUBACCOUNT="jabber:iq:pubaccount",NS_PRIVACY="jabber:iq:privacy",NS_PRIVATE="jabber:iq:private",NS_VERSION="jabber:iq:version",
NS_TIME="jabber:iq:time",NS_TIME_NEW="urn:xmpp:time",NS_LAST="jabber:iq:last",NS_XDATA="jabber:x:data",NS_IQDATA="jabber:iq:data",NS_DELAY="jabber:x:delay",NS_DELAY_NEW="urn:xmpp:delay",NS_RECEIPTS="urn:xmpp:receipts",NS_EXPIRE="jabber:x:expire",NS_EVENT="jabber:x:event",NS_XCONFERENCE="jabber:x:conference",NS_PING="urn:xmpp:ping",NS_BOOKSMARKS="storage:bookmarks",NS_FORWARD_0="urn:xmpp:forward:0",NS_CARBONS_2="urn:xmpp:carbons:2",NS_CHAT_STATES="http://jabber.org/protocol/chatstates",NS_STATS="http://jabber.org/protocol/stats",
NS_MUC="http://jabber.org/protocol/muc",NS_MUC_USER="http://jabber.org/protocol/muc#user",NS_MUC_ADMIN="http://jabber.org/protocol/muc#admin",NS_MUC_OWNER="http://jabber.org/protocol/muc#owner",NS_PUBSUB="http://jabber.org/protocol/pubsub",NS_PUBSUB_EVENT="http://jabber.org/protocol/pubsub#event",NS_PUBSUB_OWNER="http://jabber.org/protocol/pubsub#owner",NS_PUBSUB_ERRORS="http://jabber.org/protocol/pubsub#errors",NS_PUBSUB_NMI="http://jabber.org/protocol/pubsub#node-meta-info",NS_COMMANDS="http://jabber.org/protocol/commands",
NS_CAPS="http://jabber.org/protocol/caps",NS_STREAM="http://etherx.jabber.org/streams",NS_CLIENT="jabber:client",NS_BOSH="http://jabber.org/protocol/httpbind",NS_XBOSH="urn:xmpp:xbosh",NS_STANZAS="urn:ietf:params:xml:ns:xmpp-stanzas",NS_STREAMS="urn:ietf:params:xml:ns:xmpp-streams",NS_TLS="urn:ietf:params:xml:ns:xmpp-tls",NS_SASL="urn:ietf:params:xml:ns:xmpp-sasl",NS_SESSION="urn:ietf:params:xml:ns:xmpp-session",NS_BIND="urn:ietf:params:xml:ns:xmpp-bind",NS_FEATURE_IQAUTH="http://jabber.org/features/iq-auth",
NS_FEATURE_IQREGISTER="http://jabber.org/features/iq-register",NS_FEATURE_COMPRESS="http://jabber.org/features/compress",NS_COMPRESS="http://jabber.org/protocol/compress";function STANZA_ERROR(a,c,d){if(window==this)return new STANZA_ERROR(a,c,d);this.code=a;this.type=c;this.cond=d}
var ERR_BAD_REQUEST=STANZA_ERROR("400","modify","bad-request"),ERR_CONFLICT=STANZA_ERROR("409","cancel","conflict"),ERR_FEATURE_NOT_IMPLEMENTED=STANZA_ERROR("501","cancel","feature-not-implemented"),ERR_FORBIDDEN=STANZA_ERROR("403","auth","forbidden"),ERR_GONE=STANZA_ERROR("302","modify","gone"),ERR_INTERNAL_SERVER_ERROR=STANZA_ERROR("500","wait","internal-server-error"),ERR_ITEM_NOT_FOUND=STANZA_ERROR("404","cancel","item-not-found"),ERR_JID_MALFORMED=STANZA_ERROR("400","modify","jid-malformed"),
ERR_NOT_ACCEPTABLE=STANZA_ERROR("406","modify","not-acceptable"),ERR_NOT_ALLOWED=STANZA_ERROR("405","cancel","not-allowed"),ERR_NOT_AUTHORIZED=STANZA_ERROR("401","auth","not-authorized"),ERR_PAYMENT_REQUIRED=STANZA_ERROR("402","auth","payment-required"),ERR_RECIPIENT_UNAVAILABLE=STANZA_ERROR("404","wait","recipient-unavailable"),ERR_REDIRECT=STANZA_ERROR("302","modify","redirect"),ERR_REGISTRATION_REQUIRED=STANZA_ERROR("407","auth","registration-required"),ERR_REMOTE_SERVER_NOT_FOUND=STANZA_ERROR("404",
"cancel","remote-server-not-found"),ERR_REMOTE_SERVER_TIMEOUT=STANZA_ERROR("504","wait","remote-server-timeout"),ERR_RESOURCE_CONSTRAINT=STANZA_ERROR("500","wait","resource-constraint"),ERR_SERVICE_UNAVAILABLE=STANZA_ERROR("503","cancel","service-unavailable"),ERR_SUBSCRIPTION_REQUIRED=STANZA_ERROR("407","auth","subscription-required"),ERR_UNEXPECTED_REQUEST=STANZA_ERROR("400","wait","unexpected-request");function JSJaCCookieException(a){this.message=a;this.name="CookieException"}
function JSJaCCookie(a,c,d,e,f){if(window==this)return new JSJaCCookie(a,c,d,e,f);this.name=a;this.value=c;this.secs=d;this.domain=e;this.path=f;this.write=function(){var a;this.secs?(a=new Date,a.setTime(a.getTime()+1E3*this.secs),a="; expires="+a.toGMTString()):a="";var c=this.domain?"; domain="+this.domain:"",d=this.path?"; path="+this.path:"; path=/";document.cookie=this.getName()+"="+JSJaCCookie._escape(this.getValue())+a+c+d};this.erase=function(){(new JSJaCCookie(this.getName(),"",-1)).write()};
this.getName=function(){return this.name};this.setName=function(a){this.name=a;return this};this.getValue=function(){return this.value};this.setValue=function(a){this.value=a;return this};this.setDomain=function(a){this.domain=a;return this};this.setPath=function(a){this.path=a;return this}}
JSJaCCookie.read=function(a){for(var c=a+"=",d=document.cookie.split(";"),e=0;e<d.length;e++){for(var f=d[e];" "==f.charAt(0);)f=f.substring(1,f.length);if(0===f.indexOf(c))return new JSJaCCookie(a,JSJaCCookie._unescape(f.substring(c.length,f.length)))}throw new JSJaCCookieException("Cookie not found");};JSJaCCookie.get=function(a){return JSJaCCookie.read(a).getValue()};JSJaCCookie.remove=function(a){JSJaCCookie.read(a).erase()};JSJaCCookie._escape=function(a){return a.replace(/;/g,"%3AB")};
JSJaCCookie._unescape=function(a){return a.replace(/%3AB/g,";")};function JSJaCDebugger(){}JSJaCDebugger.prototype.log=function(a,c){};function JSJaCError(a,c,d){var e=XmlDocument.create("error","jsjac");e.documentElement.setAttribute("code",a);e.documentElement.setAttribute("type",c);d&&e.documentElement.appendChild(e.createElement(d)).setAttribute("xmlns",NS_STANZAS);return e.documentElement}
function JSJaCHttpBindingConnection(a){this.base=JSJaCConnection;this.base(a);this._hold=JSJACHBC_MAX_HOLD;this._inactivity=0;this._last_requests={};this._pause=this._min_polling=this._last_rid=0;this._wait=a.wait||JSJACHBC_MAX_WAIT;(function(){function a(c,d){return this.slice(c,d)}function d(a,c){2>arguments.length&&(c=0);for(var d=0,e=a.length;d<e;++d,++c)this[c]=a[d]&255}function e(e){var f;if("number"===typeof e){f=Array(e);for(var r=0;r<e;++r)f[r]=0}else f=e.slice(0);f.subarray=a;f.buffer=f;
f.byteLength=f.length;f.set=d;"object"===typeof e&&e.buffer&&(f.buffer=e.buffer);return f}try{new Uint8Array(1);return}catch(f){}window.Uint8Array=e;window.Uint32Array=e;window.Int32Array=e})()}JSJaCHttpBindingConnection.prototype=new JSJaCConnection;
JSJaCHttpBindingConnection.prototype.inherit=function(a){if(a.jid){var c=new JSJaCJID(a.jid);this.domain=c.getDomain();this.username=c.getNode();this.resource=c.getResource()}else this.domain=a.domain||"localhost",this.username=a.username,this.resource=a.resource;this._sid=a.sid;this._rid=a.rid;this._min_polling=a.polling;this._inactivity=a.inactivity;this._setHold(a.requests-1);this.setPollInterval(this._timerval);a.wait&&(this._wait=a.wait);this._connected=!0;this._handleEvent("onconnect");this._interval=
setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL);this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL);this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())};JSJaCHttpBindingConnection.prototype.setPollInterval=function(a){a&&!isNaN(a)&&(this.isPolling()?this._timerval=this._min_polling&&a<1E3*this._min_polling?1E3*this._min_polling:this._inactivity&&a>1E3*this._inactivity?1E3*this._inactivity:a:this._timerval=100);return this._timerval};
JSJaCHttpBindingConnection.prototype.isPolling=function(){return 0===this._hold};JSJaCHttpBindingConnection.prototype._getFreeSlot=function(){for(var a=0;a<this._hold+1;a++)if("undefined"==typeof this._req[a]||"undefined"==typeof this._req[a].r||4==this._req[a].r.readyState)return a;return-1};JSJaCHttpBindingConnection.prototype._getHold=function(){return this._hold};
JSJaCHttpBindingConnection.prototype._getRequestPacket=function(a,c){var d;if(this._rid<this._last_rid&&"undefined"!=typeof this._last_requests[this._rid])d=this._last_requests[this._rid];else{this._pQueue.length&&(d=this._pQueue[0],this._pQueue=this._pQueue.slice(1,this._pQueue.length));this._last_requests[this._rid]={};this._last_requests[this._rid]=d;this._last_rid=this._rid;for(var e in this._last_requests)this._last_requests.hasOwnProperty(e)&&e<this._rid-this._hold&&delete this._last_requests[e]}return d};
JSJaCHttpBindingConnection.prototype._getRequestString=function(a,c){a=a||"";var d="";if(this._rid<=this._last_rid&&"undefined"!=typeof this._last_requests[this._rid])d=this._last_requests[this._rid].xml;else{for(var e="";this._pQueue.length;)e+=this._pQueue[0],this._pQueue=this._pQueue.slice(1,this._pQueue.length);d="<body rid='"+this._rid+"' sid='"+this._sid+"' xmlns='http://jabber.org/protocol/httpbind'";JSJAC_HAVEKEYS&&(d+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,
this.oDbg),d+=" newkey='"+this._keys.getKey()+"'"));c?d+=" type='terminate'":this._reinit&&(JSJACHBC_USE_BOSH_VER&&(d+=" xml:lang='"+this._xmllang+"' xmpp:restart='true' xmlns:xmpp='urn:xmpp:xbosh' to='"+this.domain+"'"),this._reinit=!1);d=""!==e||""!==a?d+(">"+a+e+"</body>"):d+"/>";this._last_requests[this._rid]={};this._last_requests[this._rid].xml=d;this._last_rid=this._rid;for(var f in this._last_requests)this._last_requests.hasOwnProperty(f)&&f<this._rid-this._hold&&delete this._last_requests[f]}return d};
JSJaCHttpBindingConnection.prototype._getInitialRequestString=function(){var a="<body content='text/xml; charset=utf-8' hold='"+this._hold+"' xmlns='http://jabber.org/protocol/httpbind' to='"+this.authhost+"' wait='"+this._wait+"' rid='"+this._rid+"'";this.host&&this.port&&(a+=" route='xmpp:"+this.host+":"+this.port+"'");if(JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);var c=this._keys.getKey(),a=a+(" newkey='"+c+"'")}a+=" xml:lang='"+this._xmllang+"'";JSJACHBC_USE_BOSH_VER&&(a+=" ver='"+
JSJACHBC_BOSH_VERSION+"'",a+=" xmlns:xmpp='urn:xmpp:xbosh'","sasl"==this.authtype||"saslanon"==this.authtype)&&(a+=" xmpp:version='1.0'");return a+"/>"};
JSJaCHttpBindingConnection.prototype._getStreamID=function(a){this.oDbg.log(a.responseText,4);a.responseXML&&a.responseXML.documentElement?(a=a.responseXML.documentElement,"terminate"==a.getAttribute("type")?this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(a.getAttribute("authid")&&(this.streamid=a.getAttribute("authid"),this.oDbg.log("got streamid: "+this.streamid,2)),this._parseStreamFeatures(a)?(this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval()),
this.register?this._doInBandReg():this._doAuth()):this._sendEmpty(JSJaC.bind(this._getStreamID,this)))):this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))};JSJaCHttpBindingConnection.prototype._getSuspendVars=function(){return"host port _rid _last_rid _wait _min_polling _inactivity _hold _last_requests _pause".split(" ")};
JSJaCHttpBindingConnection.prototype._handleInitialResponse=function(a){try{this.oDbg.log(a.getAllResponseHeaders(),4),this.oDbg.log(a.responseText,4)}catch(c){this.oDbg.log("No response",4)}if(200==a.status&&a.responseXML){var d=a.responseXML.documentElement;d&&"body"==d.tagName&&d.namespaceURI==NS_BOSH?"terminate"==d.getAttribute("type")?(this.oDbg.log("invalid response:\n"+a.responseText,1),clearTimeout(this._timeout),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),
this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))):(this._sid=d.getAttribute("sid"),this.oDbg.log("got sid: "+this._sid,2),d.getAttribute("polling")&&(this._min_polling=d.getAttribute("polling")),d.getAttribute("inactivity")&&(this._inactivity=d.getAttribute("inactivity")),d.getAttribute("requests")&&this._setHold(d.getAttribute("requests")-1),this.oDbg.log("set hold to "+this._getHold(),2),d.getAttribute("ver")&&(this._bosh_version=d.getAttribute("ver")),d.getAttribute("maxpause")&&
(this._pause=Number.min(d.getAttribute("maxpause"),JSJACHBC_MAXPAUSE)),this.setPollInterval(this._timerval),this._connected=!0,this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._getStreamID(a)):(this.oDbg.log("no body element or incorrect body in initial response",1),this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error")))}else this.oDbg.log("initial response broken (status: "+
a.status+")",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))};
JSJaCHttpBindingConnection.prototype._parseResponse=function(a){if(!this.connected()||!a)return null;var c=a.r;try{if(404==c.status||403==c.status)return this._abort(),null;if(200!=c.status||!c.responseText&&""!=c.responseText){this._errcnt++;var d="invalid response ("+c.status+"):\n"+c.getAllResponseHeaders()+"\n"+c.responseText;c.responseXML||(d+="\nResponse failed to parse!");this.oDbg.log(d,1);if(this._errcnt>JSJAC_ERR_COUNT)return this._abort(),null;this.connected()&&(this.oDbg.log("repeating ("+
this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval()));return null}}catch(e){return this.oDbg.log("XMLHttpRequest error: status not available",1),this._errcnt++,this._errcnt>JSJAC_ERR_COUNT?this._abort():this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null}for(var c="<"==c.responseText[0]?c.responseText:
b64decode(c.responseText),d=[],f=0,g=c.length;f<PACKET_HEADER_SIZE&&PACKET_HEADER_SIZE<=g;f++)d[f]=c.charCodeAt(f);d=(new Uint8Array(d)).subarray(PACKET_STRUCT.OPCODE.START,PACKET_STRUCT.OPCODE.END);d=OPCODE_MAP.RECV.get(this._bytesToInteger(d));c=c.slice(PACKET_HEADER_SIZE);if("undefined"!=typeof a.rid&&this._last_requests[a.rid]){if(this._last_requests[a.rid].handled)return this.oDbg.log("already handled "+a.rid,2),null;this._last_requests[a.rid].handled=!0}this._errcnt=0;return d?{event:d,body:c?
JSON.parse(c):null}:null};JSJaCHttpBindingConnection.prototype._reInitStream=function(a){this._reinit=!0;this._sendEmpty(this._prepReInitStreamWait(a))};JSJaCHttpBindingConnection.prototype._prepReInitStreamWait=function(a){return JSJaC.bind(function(c){this._reInitStreamWait(c,a)},this)};
JSJaCHttpBindingConnection.prototype._reInitStreamWait=function(a,c){this.oDbg.log("checking for stream features");var d=a.responseXML.documentElement,e,f;this.oDbg.log(d);if(d.getElementsByTagNameNS)this.oDbg.log("checking with namespace"),(e=d.getElementsByTagNameNS(NS_STREAM,"features").item(0))&&(f=e.getElementsByTagNameNS(NS_BIND,"bind").item(0));else{var d=d.getElementsByTagName("stream:features"),g,h;g=0;for(h=d.length;g<h;g++)if(d.item(g).namespaceURI==NS_STREAM||d.item(g).getAttribute("xmlns")==
NS_STREAM){e=d.item(g);break}if(e)for(f=e.getElementsByTagName("bind"),g=0,h=f.length;g<h;g++)if(f.item(g).namespaceURI==NS_BIND||f.item(g).getAttribute("xmlns")==NS_BIND){f=f.item(g);break}}this.oDbg.log(e);this.oDbg.log(f);e?f?c():(this.oDbg.log("no bind feature - giving up",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this._sendEmpty(this._prepReInitStreamWait(c))};
JSJaCHttpBindingConnection.prototype._repeat=function(){this._rid>=this._last_rid&&(this._rid=this._last_rid-1);this._process()};JSJaCHttpBindingConnection.prototype._resume=function(){0===this._pause?this._repeat():this._process()};JSJaCHttpBindingConnection.prototype._setHold=function(a){!a||isNaN(a)||0>a?a=0:a>JSJACHBC_MAX_HOLD&&(a=JSJACHBC_MAX_HOLD);return this._hold=a};
JSJaCHttpBindingConnection.prototype._setupJumpRequest=function(a){var c={},d=XmlHttp.create();this._rid++;try{d.open("POST",this._httpbase+"?rid="+this._rid+"&sid="+this._sid+"&useBase64=1",a),d.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(e){this.oDbg.log(e,1)}c.r=d;c.rid=this._rid;return c};
JSJaCHttpBindingConnection.prototype._setupRequest=function(a){var c={},d=XmlHttp.create();this._rid++;try{d.open("POST",this._httpbase,a),d.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(e){this.oDbg.log(e,1)}c.r=d;c.rid=this._rid;return c};
JSJaCHttpBindingConnection.prototype._suspend=function(){if(0!==this._pause){var a=this._getFreeSlot();this._req[a]=this._setupRequest(!1);var c="<body pause='"+this._pause+"' xmlns='http://jabber.org/protocol/httpbind' sid='"+this._sid+"' rid='"+this._rid+"'";JSJAC_HAVEKEYS&&(c+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),c+=" newkey='"+this._keys.getKey()+"'"));for(c+=">";this._pQueue.length;)c+=this._pQueue[0],this._pQueue=this._pQueue.slice(1,
this._pQueue.length);c+="</body>";this.oDbg.log("Disconnecting: "+c,4);this._req[a].r.send(c)}};function JSJaCHttpPollingConnection(a){this.base=JSJaCConnection;this.base(a);JSJACPACKET_USE_XMLNS=!1}JSJaCHttpPollingConnection.prototype=new JSJaCConnection;JSJaCHttpPollingConnection.prototype.isPolling=function(){return!0};JSJaCHttpPollingConnection.prototype._getFreeSlot=function(){return"undefined"==typeof this._req[0]||"undefined"==typeof this._req[0].r||4==this._req[0].r.readyState?0:-1};
JSJaCHttpPollingConnection.prototype._getInitialRequestString=function(){var a="0";if(JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(b64_sha1,this.oDbg);var c=this._keys.getKey(),a=a+(";"+c)}c=this.domain;this.authhost&&(c=this.authhost);a+=",<stream:stream to='"+c+"' xmlns='jabber:client' xmlns:stream='http://etherx.jabber.org/streams'";if("sasl"==this.authtype||"saslanon"==this.authtype)a+=" version='1.0'";return a+">"};
JSJaCHttpPollingConnection.prototype._getRequestString=function(a,c){var d=this._sid;JSJAC_HAVEKEYS&&(d+=";"+this._keys.getKey(),this._keys.lastKey()&&(this._keys=new JSJaCKeys(b64_sha1,this.oDbg),d+=";"+this._keys.getKey()));d+=",";for(a&&(d+=a);this._pQueue.length;)d+=this._pQueue[0],this._pQueue=this._pQueue.slice(1,this._pQueue.length);c&&(d+="</stream:stream>");return d};
JSJaCHttpPollingConnection.prototype._getStreamID=function(){if(""===this._req[0].r.responseText)this.oDbg.log("waiting for stream id",2),this._timeout=setTimeout(JSJaC.bind(this._sendEmpty,this),1E3);else{this.oDbg.log(this._req[0].r.responseText,4);this._req[0].r.responseText.match(/id=[\'\"]([^\'\"]+)[\'\"]/)&&(this.streamid=RegExp.$1);this.oDbg.log("got streamid: "+this.streamid,2);var a;try{var c=this._req[0].r.responseText;c.match(/<\/stream:stream>\s*$/)||(c+="</stream:stream>");a=XmlDocument.create("doc");
a.loadXML(c);if(!this._parseStreamFeatures(a)){this.authtype="nonsasl";return}}catch(d){this.oDbg.log("loadXML: "+d.toString(),1)}this._connected=!0;this.register?this._doInBandReg():this._doAuth();this._process(this._timerval)}};JSJaCHttpPollingConnection.prototype._getSuspendVars=function(){return[]};
JSJaCHttpPollingConnection.prototype._handleInitialResponse=function(){this.oDbg.log(this._req[0].r.getAllResponseHeaders(),4);for(var a=this._req[0].r.getResponseHeader("Set-Cookie"),a=a.split(";"),c=0;c<a.length;c++){var d=a[c].split("=");"ID"==d[0]&&(this._sid=d[1])}this.oDbg.log("got sid: "+this._sid,2);this._connected=!0;this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL);this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL);this._getStreamID()};
JSJaCHttpPollingConnection.prototype._parseResponse=function(a){a=a.r;if(!this.connected())return null;if(200!=a.status)return this.oDbg.log("invalid response ("+a.status+"):"+a.responseText+"\n"+a.getAllResponseHeaders(),1),this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),
null;this.oDbg.log(a.getAllResponseHeaders(),4);var c,d=a.getResponseHeader("Set-Cookie");if(null===d)c="-1:0";else for(var d=d.split(";"),e=0;e<d.length;e++){var f=d[e].split("=");"ID"==f[0]&&(c=f[1])}if("undefined"!=typeof c&&-1!=c.indexOf(":0")){switch(c.substring(0,c.indexOf(":0"))){case "0":this.oDbg.log("invalid response:"+a.responseText,1);break;case "-1":this.oDbg.log("Internal Server Error",1);break;case "-2":this.oDbg.log("Bad Request",1);break;case "-3":this.oDbg.log("Key Sequence Error",
1)}this._setStatus("internal_server_error");clearTimeout(this._timeout);clearInterval(this._interval);clearInterval(this._inQto);this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error"));this._connected=!1;this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");return null}if(!a.responseText)return null;try{var g=a.responseText.replace(/<\?xml.+\?>/,"");g.match(/<stream:stream/)&&(g+="</stream:stream>");var h=JSJaCHttpPollingConnection._parseTree("<body>"+g+"</body>");
h&&"parsererror"!=h.tagName||(this.oDbg.log("parsererror",1),(h=JSJaCHttpPollingConnection._parseTree("<stream:stream xmlns:stream='http://etherx.jabber.org/streams'>"+a.responseText))&&"parsererror"!=h.tagName?(this.oDbg.log("stream closed",1),0<h.getElementsByTagName("conflict").length&&this._setStatus("session-terminate-conflict"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=
!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this.oDbg.log("parsererror:"+h,1));return h}catch(r){this.oDbg.log("parse error:"+r.message,1)}return null};JSJaCHttpPollingConnection.prototype._reInitStream=function(a){this._sendRaw("<stream:stream xmlns:stream='http://etherx.jabber.org/streams' xmlns='jabber:client' to='"+(this.authhost?this.authhost:this.domain)+"' version='1.0'>",a)};JSJaCHttpPollingConnection.prototype._repeat=function(){this._resume()};
JSJaCHttpPollingConnection.prototype._resume=function(){this._process(this._timerval)};JSJaCHttpPollingConnection.prototype._setupRequest=function(a){var c=XmlHttp.create();try{c.open("POST",this._httpbase,a),c.overrideMimeType&&c.overrideMimeType("text/plain; charset=utf-8"),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}catch(d){this.oDbg.log(d,1)}a={};a.r=c;return a};JSJaCHttpPollingConnection.prototype._suspend=function(){};
JSJaCHttpPollingConnection._parseTree=function(a){try{var c=XmlDocument.create("body","foo");if("undefined"!=typeof c.loadXML)return c.loadXML(a),c.documentElement;if(window.DOMParser)return(new DOMParser).parseFromString(a,"text/xml").documentElement}catch(d){}return null};function JSJaCJIDInvalidException(a){this.message=a;this.name="JSJaCJIDInvalidException"}var JSJACJID_FORBIDDEN="\" &'/:<>@".split("");
function JSJaCJID(a){this._resource=this._domain=this._node="";"string"==typeof a?(-1!=a.indexOf("@")&&(this.setNode(a.substring(0,a.indexOf("@"))),a=a.substring(a.indexOf("@")+1)),-1!=a.indexOf("/")&&(this.setResource(a.substring(a.indexOf("/")+1)),a=a.substring(0,a.indexOf("/"))),this.setDomain(a)):(this.setNode(a.node),this.setDomain(a.domain),this.setResource(a.resource))}JSJaCJID.prototype.getBareJID=function(){return this.getNode()+"@"+this.getDomain()};JSJaCJID.prototype.getNode=function(){return this._node};
JSJaCJID.prototype.getDomain=function(){return this._domain};JSJaCJID.prototype.getResource=function(){return this._resource};JSJaCJID.prototype.setNode=function(a){JSJaCJID._checkNodeName(a);this._node=a||"";return this};JSJaCJID.prototype.setDomain=function(a){if(!a||""===a)throw new JSJaCJIDInvalidException("domain name missing");JSJaCJID._checkNodeName(a);this._domain=a;return this};JSJaCJID.prototype.setResource=function(a){this._resource=a||"";return this};
JSJaCJID.prototype.toString=function(){var a="";this.getNode()&&""!==this.getNode()&&(a=this.getNode()+"@");a+=this.getDomain();this.getResource()&&""!==this.getResource()&&(a+="/"+this.getResource());return a};JSJaCJID.prototype.removeResource=function(){return this.setResource()};JSJaCJID.prototype.clone=function(){return new JSJaCJID(this.toString())};
JSJaCJID.prototype.isEntity=function(a){a="string"==typeof a?new JSJaCJID(a):a.clone();a.removeResource();return this.clone().removeResource().toString()===a.toString()};JSJaCJID._checkNodeName=function(a){if(a&&""!==a)for(var c=0;c<JSJACJID_FORBIDDEN.length;c++)if(-1!=a.indexOf(JSJACJID_FORBIDDEN[c]))throw new JSJaCJIDInvalidException("forbidden char in nodename: "+JSJACJID_FORBIDDEN[c]);};function JSJaCJSON(){}
JSJaCJSON.toString=function(a){var c={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},d={array:function(a){var c=["["],g,h,r,l=a.length,z;for(r=0;r<l;r+=1)if(z=a[r],h=d[typeof z])try{z=h(z),"string"==typeof z&&(g&&(c[c.length]=","),c[c.length]=z,g=!0)}catch(n){}c[c.length]="]";return c.join("")},"boolean":function(a){return String(a)},"null":function(){return"null"},number:function(a){return isFinite(a)?String(a):"null"},object:function(a){if(a){if(a instanceof Array)return d.array(a);
var c=[],g,h,r,l;c.push("{");for(r in a)if(a.hasOwnProperty(r)&&(l=a[r],h=d[typeof l]))try{l=h(l),"string"==typeof l&&(g&&(c[c.length]=","),c.push(d.string(r),":",l),g=!0)}catch(z){}c[c.length]="}";return c.join("")}return"null"},string:function(a){/["\\\x00-\x1f]/.test(a)&&(a=a.replace(/([\x00-\x1f\\"])/g,function(a,d){var e=c[d];if(e)return e;e=d.charCodeAt();return"\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}));return'"'+a+'"'}};switch(typeof a){case "object":return d.object(a);case "array":return d.array(a)}};
JSJaCJSON.parse=function(a){try{return!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(a.replace(/"(\\.|[^"\\])*"/g,""))&&eval("("+a+")")}catch(c){return!1}};
function JSJaCKeys(a,c){var d=Math.random();this._k=[];this._k[0]=d.toString();c?this.oDbg=c:(this.oDbg={},this.oDbg.log=function(){});if(a)for(d=1;d<JSJAC_NKEYS;d++)this._k[d]=a(this._k[d-1]),c.log(d+": "+this._k[d],4);this._indexAt=JSJAC_NKEYS-1;this.getKey=function(){return this._k[this._indexAt--]};this.lastKey=function(){return 0===this._indexAt};this.size=function(){return this._k.length};this._getSuspendVars=function(){return["_k","_indexAt"]}}var JSJACPACKET_USE_XMLNS=!0;
function JSJaCPacket(a){this.name=a;this.doc="undefined"!=typeof JSJACPACKET_USE_XMLNS&&JSJACPACKET_USE_XMLNS?XmlDocument.create(a,NS_CLIENT):XmlDocument.create(a,"")}JSJaCPacket.prototype.pType=function(){return this.name};JSJaCPacket.prototype.getDoc=function(){return this.doc};JSJaCPacket.prototype.getNode=function(){return this.getDoc()&&this.getDoc().documentElement?this.getDoc().documentElement:null};
JSJaCPacket.prototype.setTo=function(a){a?"string"==typeof a?this.getNode().setAttribute("to",a):this.getNode().setAttribute("to",a.toString()):this.getNode().removeAttribute("to");return this};JSJaCPacket.prototype.setFrom=function(a){a?"string"==typeof a?this.getNode().setAttribute("from",a):this.getNode().setAttribute("from",a.toString()):this.getNode().removeAttribute("from");return this};
JSJaCPacket.prototype.setID=function(a){a?this.getNode().setAttribute("id",a):this.getNode().removeAttribute("id");return this};JSJaCPacket.prototype.setType=function(a){a?this.getNode().setAttribute("type",a):this.getNode().removeAttribute("type");return this};JSJaCPacket.prototype.setXMLLang=function(a){a?this.getNode().setAttribute("xml:lang",a):this.getNode().removeAttribute("xml:lang");return this};JSJaCPacket.prototype.getTo=function(){return this.getNode().getAttribute("to")};
JSJaCPacket.prototype.getFrom=function(){return this.getNode().getAttribute("from")};JSJaCPacket.prototype.getToJID=function(){return new JSJaCJID(this.getTo())};JSJaCPacket.prototype.getFromJID=function(){return new JSJaCJID(this.getFrom())};JSJaCPacket.prototype.getID=function(){return this.getNode().getAttribute("id")};JSJaCPacket.prototype.getType=function(){return this.getNode().getAttribute("type")};JSJaCPacket.prototype.getXMLLang=function(){return this.getNode().getAttribute("xml:lang")};
JSJaCPacket.prototype.getXMLNS=function(){return this.getNode().namespaceURI||this.getNode().getAttribute("xmlns")};JSJaCPacket.prototype.getChild=function(a,c){if(!this.getNode())return null;a=a||"*";c=c||"*";if(this.getNode().getElementsByTagNameNS)return this.getNode().getElementsByTagNameNS(c,a).item(0);var d=this.getNode().getElementsByTagName(a);if("*"!=c)for(var e=0;e<d.length;e++){if(d.item(e).namespaceURI==c||d.item(e).getAttribute("xmlns")==c)return d.item(e)}else return d.item(0);return null};
JSJaCPacket.prototype.getChildVal=function(a,c){var d=this.getChild(a,c),e="";if(d&&d.hasChildNodes())for(var f=0;f<d.childNodes.length;f++)d.childNodes.item(f).nodeValue&&(e+=d.childNodes.item(f).nodeValue);return e};JSJaCPacket.prototype.clone=function(){return JSJaCPacket.wrapNode(this.getNode())};JSJaCPacket.prototype.isError=function(){return"error"==this.getType()};
JSJaCPacket.prototype.errorReply=function(a){var c=this.clone();c.setTo(this.getFrom());c.setFrom();c.setType("error");c.appendNode("error",{code:a.code,type:a.type},[[a.cond,{xmlns:NS_STANZAS}]]);return c};JSJaCPacket.prototype.xml="undefined"!=typeof XMLSerializer?function(){var a=(new XMLSerializer).serializeToString(this.getNode());"undefined"==typeof a&&(a=(new XMLSerializer).serializeToString(this.doc));return a}:function(){return this.getDoc().xml};JSJaCPacket.prototype._getAttribute=function(a){return this.getNode().getAttribute(a)};
document.ELEMENT_NODE||(document.ELEMENT_NODE=1,document.ATTRIBUTE_NODE=2,document.TEXT_NODE=3,document.CDATA_SECTION_NODE=4,document.ENTITY_REFERENCE_NODE=5,document.ENTITY_NODE=6,document.PROCESSING_INSTRUCTION_NODE=7,document.COMMENT_NODE=8,document.DOCUMENT_NODE=9,document.DOCUMENT_TYPE_NODE=10,document.DOCUMENT_FRAGMENT_NODE=11,document.NOTATION_NODE=12);
JSJaCPacket.prototype._importNode=function(a,c){switch(a.nodeType){case document.ELEMENT_NODE:var d;d=this.getDoc().createElementNS?this.getDoc().createElementNS(a.namespaceURI,a.nodeName):this.getDoc().createElement(a.nodeName);var e,f;if(a.attributes&&0<a.attributes.length)for(e=0,f=a.attributes.length;e<f;e++){var g=a.attributes.item(e);if("xmlns"!=g.nodeName||null===d.getAttribute("xmlns")&&!d.namespaceURI)d.setAttributeNS&&g.namespaceURI?d.setAttributeNS(g.namespaceURI,g.name,g.value):d.setAttribute(g.name,
g.value)}if(c&&a.childNodes&&0<a.childNodes.length)for(e=0,f=a.childNodes.length;e<f;e++)d.appendChild(this._importNode(a.childNodes.item(e),c));return d;case document.TEXT_NODE:case document.CDATA_SECTION_NODE:case document.COMMENT_NODE:return this.getDoc().createTextNode(a.nodeValue)}};
JSJaCPacket.prototype._setChildNode=function(a,c){var d=this.getChild(a),e=this.getDoc().createTextNode(c);if(d)try{d.replaceChild(e,d.firstChild)}catch(f){}else{try{d=this.getDoc().createElementNS(this.getNode().namespaceURI,a)}catch(g){d=this.getDoc().createElement(a)}this.getNode().appendChild(d);d.appendChild(e)}return d};JSJaCPacket.prototype.buildNode=function(a,c,d,e){return JSJaCBuilder.buildNode(this.getDoc(),a,c,d,e)};
JSJaCPacket.prototype.appendNode=function(a,c,d){"object"==typeof a?this.getNode().appendChild(a):this.getNode().appendChild(this.buildNode(a,c,d,this.getNode().namespaceURI));return this};function JSJaCPresence(){this.base=JSJaCPacket;this.base("presence")}JSJaCPresence.prototype=new JSJaCPacket;JSJaCPresence.prototype.setStatus=function(a){this._setChildNode("status",a);return this};
JSJaCPresence.prototype.setShow=function(a){"chat"!=a&&"away"!=a&&"xa"!=a&&"dnd"!=a&&"unavailable"!=a||this._setChildNode("show",a);return this};JSJaCPresence.prototype.setPriority=function(a){this._setChildNode("priority",a);return this};JSJaCPresence.prototype.setPresence=function(a,c,d){a&&this.setShow(a);c&&this.setStatus(c);d&&this.setPriority(d);return this};JSJaCPresence.prototype.getStatus=function(){return this.getChildVal("status")};JSJaCPresence.prototype.getShow=function(){return this.getChildVal("show")};
JSJaCPresence.prototype.getPriority=function(){return this.getChildVal("priority")};function JSJaCIQ(){this.base=JSJaCPacket;this.base("iq")}JSJaCIQ.prototype=new JSJaCPacket;JSJaCIQ.prototype.setIQ=function(a,c,d){a&&this.setTo(a);c&&this.setType(c);d&&this.setID(d);return this};JSJaCIQ.prototype.setQuery=function(a){var c;try{c=this.getDoc().createElementNS(a,"query")}catch(d){c=this.getDoc().createElement("query"),c.setAttribute("xmlns",a)}this.getNode().appendChild(c);return c};
JSJaCIQ.prototype.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0)};JSJaCIQ.prototype.getQueryXMLNS=function(){return this.getQuery()?this.getQuery().namespaceURI||this.getQuery().getAttribute("xmlns"):null};
JSJaCIQ.prototype.reply=function(a){var c=this.clone();c.setTo(this.getFrom());c.setFrom();c.setType("result");if(a)if("string"==typeof a)c.getChild().appendChild(c.getDoc().loadXML(a));else if(a.constructor==Array)for(var d=c.getChild(),e=0;e<a.length;e++)"string"==typeof a[e]?d.appendChild(c.getDoc().loadXML(a[e])):"object"==typeof a[e]&&d.appendChild(a[e]);else"object"==typeof a&&c.getChild().appendChild(a);return c};function JSJaCMessage(){this.base=JSJaCPacket;this.base("message")}
JSJaCMessage.prototype=new JSJaCPacket;JSJaCMessage.prototype.setBody=function(a){this._setChildNode("body",a);return this};JSJaCMessage.prototype.setSubject=function(a){this._setChildNode("subject",a);return this};JSJaCMessage.prototype.setThread=function(a){this._setChildNode("thread",a);return this};JSJaCMessage.prototype.getThread=function(){return this.getChildVal("thread")};JSJaCMessage.prototype.getBody=function(){return this.getChildVal("body")};JSJaCMessage.prototype.getSubject=function(){return this.getChildVal("subject")};
JSJaCPacket.wrapNode=function(a){var c=null;switch(a.nodeName.toLowerCase()){case "presence":c=new JSJaCPresence;break;case "message":c=new JSJaCMessage;break;case "iq":c=new JSJaCIQ}c&&(c.getDoc().replaceChild(c._importNode(a,!0),c.getNode()),null==c.getDoc().xml&&null!=a&&null!=a.xml&&(c.getDoc().xml=a.xml));return c};
var JSJaCUtils={xor:function(a,c){if(!a)return c;if(!c)return a;for(var d="",e=0;e<a.length;e++)d+=String.fromCharCode(a.charCodeAt(e)^c.charCodeAt(e));return d},cnonce:function(a){for(var c="",d=0;d<a;d++)c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.round(61*Math.random((new Date).getTime())));return c},now:function(){return Date.now&&"function"==typeof Date.now?Date.now():(new Date).getTime()}};
function JSJaCWebSocketConnection(a){this.base=JSJaCConnection;this.base(a);this._ws=null;this.registerHandler("onerror",JSJaC.bind(this._cleanupWebSocket,this))}JSJaCWebSocketConnection.prototype=new JSJaCConnection;JSJaCWebSocketConnection.prototype._cleanupWebSocket=function(){null!==this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)};
JSJaCWebSocketConnection.prototype.connect=function(a){this._setStatus("connecting");this.domain=a.domain||"localhost";this.username=a.username;this.resource=a.resource;this.pass=a.password||a.pass;this.authzid=a.authzid||"";this.register=a.register;this.authhost=a.authhost||this.domain;this.authtype=a.authtype||"sasl";this.jid=this.username+"@"+this.domain;this.fulljid=this.jid+"/"+this.resource;this._allow_plain=a.allow_plain?a.allow_plain:JSJAC_ALLOW_PLAIN;this._allow_scram=a.allow_scram?a.allow_scram:
JSJAC_ALLOW_SCRAM;this._xmllang=a.xmllang&&""!==a.xmllang?a.xmllang:"en";"undefined"===typeof WebSocket?this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(this._ws=new WebSocket(this._httpbase,"xmpp"),this._ws.onclose=JSJaC.bind(this._onclose,this),this._ws.onerror=JSJaC.bind(this._onerror,this),this._ws.onopen=JSJaC.bind(this._onopen,this))};
JSJaCWebSocketConnection.prototype._onopen=function(){var a=new JumpPacket({usr:this.username,atk:this.pass,br:this.resource},OPCODE.AUTH.SEND);this._buildAndSend(a);this._ws.onmessage=JSJaC.bind(this._onAuthMessage,this)};
JSJaCWebSocketConnection.prototype._onAuthMessage=function(a){var c=this;if(a.data instanceof Blob){a=a.data;var d=new FileReader;d.onload=function(a){if(a.target.readyState==FileReader.DONE){var d=new Uint8Array(a.target.result),g=c._bytesToInteger(d.subarray(PACKET_STRUCT.PACKET_LEN.START,PACKET_STRUCT.PACKET_LEN.END));a=d.subarray(PACKET_STRUCT.OPCODE.START,PACKET_STRUCT.OPCODE.END);d=d.subarray(PACKET_HEADER_SIZE,PACKET_HEADER_SIZE+g);c._bytesToInteger(a)==OPCODE.AUTH.RECV?(a=JSON.parse(c._uint8ArrayToString(d)),
console.log("\u3010recv\u3011\tOPCODE.AUTH.KEY\n\t"+JSON.stringify(a)),200!=a.code?c._handleEvent(OPCODE.STREAM_ERROR.KEY,{code:401,message:"not-authorized"}):(c._handleEvent("packet_in",a),c._handleEvent(OPCODE.AUTH.KEY,a),c._connected=!0,c._handleEvent("onconnect"),c._ws.onmessage=JSJaC.bind(c._onJumpMessage,c))):c._bytesToInteger(a)==OPCODE.STREAM_ERROR.RECV&&(a=JSON.parse(c._uint8ArrayToString(d)),console.log("\u3010recv\u3011\tOPCODE.AUTH.KEY\n\t"+JSON.stringify(a)),200!=a.code&&c._handleEvent(OPCODE.STREAM_ERROR.KEY,
{code:401,message:"not-authorized"}))}};d.readAsArrayBuffer(a)}};
JSJaCWebSocketConnection.prototype.sendJumpPacket=function(a,c,d){if(!this.connected())return!1;if(!a||!a.opcode){return!1;throw Error("packet and its opcode cannot be null when send a packet.");}if(c&&this._validateCallbackable(a)){if(!a.content)throw Error("packet content cannot be null when send a Message or IQ packet.");a.content.id||(a.content.id=this._IDPrefix+this._ID++);this._registerPID(a,c,d)}a instanceof JumpPacket&&console.log("\u3010send\u3011\t "+OPCODE_MAP.SEND.get(a.opcode)+"\n\t"+
JSON.stringify(a));try{this._handleEvent("packet_out",a)}catch(e){return this.oDbg.log(e.toString(),1),!1}this._buildAndSend(a);return!0};
JSJaCWebSocketConnection.prototype._buildAndSend=function(a){var c=null,d=null==a.content||"undefined"==typeof a.content,e=new Blob([JSON.stringify(a.content)],{type:"text/json"}),f=new FileReader,g=this;f.onload=function(e){e.target.readyState==FileReader.DONE&&(c=this.result,e=new Uint8Array(PACKET_HEADER_SIZE),e.set(g._numToBytes(a.sFrame,PACKET_STRUCT.CONSOLE_FRAME.SIZE),PACKET_STRUCT.CONSOLE_FRAME.START),e.set(g._numToBytes(a.opcode,PACKET_STRUCT.OPCODE.SIZE),PACKET_STRUCT.OPCODE.START),d?e.set(g._numToBytes(0,
PACKET_STRUCT.PACKET_LEN.SIZE),PACKET_STRUCT.PACKET_LEN.START):e.set(g._numToBytes(c.byteLength,PACKET_STRUCT.PACKET_LEN.SIZE),PACKET_STRUCT.PACKET_LEN.START),e.set(g._numToBytes(a.version,PACKET_STRUCT.VERSION.SIZE),PACKET_STRUCT.VERSION.START),e.set(g._numToBytes(a.seqId,PACKET_STRUCT.SEQ_ID.SIZE),PACKET_STRUCT.SEQ_ID.START),e=d?e:g._concatUint8Array(e,new Uint8Array(c)),g._ws.send(e))};f.readAsArrayBuffer(e)};
JSJaCWebSocketConnection.prototype._handleOpenStream=function(a){this.oDbg.log(a.data,4);a=a.data;a=a.substr(a.indexOf("<stream:stream"));"/>"!==a.substr(-2)&&"</stream:stream>"!==a.substr(-16)&&(a+="</stream:stream>");(a=this._parseXml(a))?(this.streamid=a.getAttribute("id"),this.oDbg.log("got streamid: "+this.streamid,2),this._ws.onmessage=JSJaC.bind(this._handleInitialResponse,this)):this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))};
JSJaCWebSocketConnection.prototype._handleInitialResponse=function(a){a=this._parseXml(a.data);this._parseStreamFeatures(a)?(this._connected=!0,this.register?this._doInBandReg():this._doAuth()):this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))};JSJaCWebSocketConnection.prototype.disconnect=function(){this._setStatus("disconnecting");this.connected()&&(this._connected=!1,this.oDbg.log("Disconnecting",4),this._cleanupWebSocket(),this.oDbg.log("Disconnected",2),this._handleEvent("ondisconnect"))};
JSJaCWebSocketConnection.prototype._onclose=function(){this.oDbg.log("websocket closed",2);"disconnecting"!==this._status&&(this._connected=!1)};JSJaCWebSocketConnection.prototype._onerror=function(){this.oDbg.log("websocket error",1);this._connected=!1;this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))};
JSJaCWebSocketConnection.prototype._onJumpMessage=function(a){var c=this;if(a.data instanceof Blob){a=a.data;var d=new FileReader;d.onload=function(a){if(a.target.readyState==FileReader.DONE){var d=new Uint8Array(a.target.result),g=c._bytesToInteger(d.subarray(PACKET_STRUCT.PACKET_LEN.START,PACKET_STRUCT.PACKET_LEN.END));a=d.subarray(PACKET_STRUCT.OPCODE.START,PACKET_STRUCT.OPCODE.END);d=d.subarray(PACKET_HEADER_SIZE,PACKET_HEADER_SIZE+g);c._parseUint8Array(a,d)}};d.readAsArrayBuffer(a)}};
JSJaCWebSocketConnection.prototype._onmessage=function(a){var c;c=a.data;this._setStatus("processing");if(c&&""!==c)if(c=this._parseXml(c),c.namespaceURI===NS_STREAM&&"error"===c.localName)0<c.getElementsByTagNameNS(NS_STREAMS,"conflict").length&&this._setStatus("session-terminate-conflict"),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","remote-stream-error"));else if(c=JSJaCPacket.wrapNode(c))this.oDbg.log("async recv: "+a.data,4),this._handleEvent("packet_in",c),c.pType&&
!this._handlePID(c)&&(this._handleEvent(c.pType()+"_in",c),this._handleEvent(c.pType(),c))};
JSJaCWebSocketConnection.prototype._parseXml=function(a){var c;this.oDbg.log("Parsing: "+a,4);try{if(c=XmlDocument.create("stream",NS_STREAM),"</stream:stream>"==a.trim()){this.oDbg.log("session terminated",1);clearTimeout(this._timeout);clearInterval(this._interval);clearInterval(this._inQto);try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(d){}this._connected=!1;this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate"));this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect")}else{if(-1===
a.indexOf("<stream:stream"))return c.loadXML("<stream:stream xmlns:stream='"+NS_STREAM+"' xmlns='jabber:client'>"+a+"</stream:stream>"),"undefined"==typeof c.documentElement.firstChild.xml&&(c.documentElement.firstChild.xml=a),c.documentElement.firstChild;c.loadXML(a);return c.documentElement}}catch(e){this.oDbg.log("Error: "+e),this._connected=!1,this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"))}return null};
JSJaCWebSocketConnection.prototype._getInitialRequestString=function(){var a;a=this.domain;this.authhost&&(a=this.authhost);a='<stream:stream to="'+a+'" xmlns="jabber:client" xmlns:stream="'+NS_STREAM+'"';if("sasl"===this.authtype||"saslanon"===this.authtype)a+=' version="1.0"';return a+">"};
JSJaCWebSocketConnection.prototype.send=function(a,c,d){this._ws.onmessage=JSJaC.bind(this._onmessage,this);if(!a||!a.pType)return this.oDbg.log("no packet: "+a,1),!1;if(!this.connected())return!1;c&&(a.getID()||a.setID("JSJaCID_"+this._ID++),this._registerPID(a,c,d));try{this._handleEvent(a.pType()+"_out",a),this._handleEvent("packet_out",a),this._ws.send(a.xml())}catch(e){return this.oDbg.log(e.toString(),1),!1}return!0};JSJaCWebSocketConnection.prototype.resume=function(){return!1};
JSJaCWebSocketConnection.prototype.suspend=function(){return!1};JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S1=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S1,this)(a)};JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S2=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S2,this)(a)};
JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S1=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S1,this)(a)};JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S2=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S2,this)(a)};JSJaCWebSocketConnection.prototype._doSASLAuthDone=function(a){a=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDone,this)(a)};
JSJaCWebSocketConnection.prototype._reInitStream=function(a){var c=this.domain;this.authhost&&(c=this.authhost);this._sendRaw('<stream:stream xmlns:stream="'+NS_STREAM+'" xmlns="jabber:client" to="'+c+'" version="1.0">',a)};JSJaCWebSocketConnection.prototype._sendRaw=function(a,c,d){if(!this._ws)return!1;c&&(this._ws.onmessage=JSJaC.bind(c,this,d));this._ws.send(a);return!0};
JSJaCWebSocketConnection.prototype._parseUint8Array=function(a,c){this._setStatus("processing");if(c){var d=OPCODE_MAP.RECV.get(this._bytesToInteger(a));console.log("\u3010recv\u3011\t"+OPCODE_MAP.RECV.get(this._bytesToInteger(a))+"\n\t"+this._uint8ArrayToString(c));if(0==c.byteLength)this._handleEvent("packet_in"),this._handleEvent(d);else try{var e=JSON.parse(this._uint8ArrayToString(c));this._handlePID(e)||(this._handleEvent("packet_in",e),this._handleEvent(d,e))}catch(f){}}};
var hexcase=0,b64pad="=";function hex_sha1(a){return rstr2hex(rstr_sha1(str2rstr_utf8(a)))}function b64_sha1(a){return rstr2b64(rstr_sha1(str2rstr_utf8(a)))}function any_sha1(a,c){return rstr2any(rstr_sha1(str2rstr_utf8(a)),c)}function hex_hmac_sha1(a,c){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(c)))}function b64_hmac_sha1(a,c){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(c)))}
function any_hmac_sha1(a,c,d){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(c)),d)}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(a){return binb2rstr(binb_sha1(rstr2binb(a),8*a.length))}
function rstr_hmac_sha1(a,c){var d=rstr2binb(a);16<d.length&&(d=binb_sha1(d,8*a.length));for(var e=Array(16),f=Array(16),g=0;16>g;g++)e[g]=d[g]^909522486,f[g]=d[g]^1549556828;d=binb_sha1(e.concat(rstr2binb(c)),512+8*c.length);return binb2rstr(binb_sha1(f.concat(d),672))}function rstr2binb(a){for(var c=Array(a.length>>2),d=0;d<c.length;d++)c[d]=0;for(d=0;d<8*a.length;d+=8)c[d>>5]|=(a.charCodeAt(d/8)&255)<<24-d%32;return c}
function binb2rstr(a){for(var c="",d=0;d<32*a.length;d+=8)c+=String.fromCharCode(a[d>>5]>>>24-d%32&255);return c}
function binb_sha1(a,c){a[c>>5]|=128<<24-c%32;a[(c+64>>9<<4)+15]=c;for(var d=Array(80),e=1732584193,f=-271733879,g=-1732584194,h=271733878,r=-1009589776,l=0;l<a.length;l+=16){for(var z=e,n=f,p=g,y=h,w=r,x=0;80>x;x++){d[x]=16>x?a[l+x]:bit_rol(d[x-3]^d[x-8]^d[x-14]^d[x-16],1);var u=safe_add(safe_add(bit_rol(e,5),sha1_ft(x,f,g,h)),safe_add(safe_add(r,d[x]),sha1_kt(x))),r=h,h=g,g=bit_rol(f,30),f=e,e=u}e=safe_add(e,z);f=safe_add(f,n);g=safe_add(g,p);h=safe_add(h,y);r=safe_add(r,w)}return[e,f,g,h,r]}
function sha1_ft(a,c,d,e){return 20>a?c&d|~c&e:40>a?c^d^e:60>a?c&d|c&e|d&e:c^d^e}function sha1_kt(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function hex_md5(a){return rstr2hex(rstr_md5(str2rstr_utf8(a)))}function b64_md5(a){return rstr2b64(rstr_md5(str2rstr_utf8(a)))}function any_md5(a,c){return rstr2any(rstr_md5(str2rstr_utf8(a)),c)}function hex_hmac_md5(a,c){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(c)))}
function b64_hmac_md5(a,c){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(c)))}function any_hmac_md5(a,c,d){return rstr2any(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(c)),d)}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc").toLowerCase()}function rstr_md5(a){return binl2rstr(binl_md5(rstr2binl(a),8*a.length))}
function rstr_hmac_md5(a,c){var d=rstr2binl(a);16<d.length&&(d=binl_md5(d,8*a.length));for(var e=Array(16),f=Array(16),g=0;16>g;g++)e[g]=d[g]^909522486,f[g]=d[g]^1549556828;d=binl_md5(e.concat(rstr2binl(c)),512+8*c.length);return binl2rstr(binl_md5(f.concat(d),640))}function rstr2hex(a){try{hexcase}catch(c){hexcase=0}for(var d=hexcase?"0123456789ABCDEF":"0123456789abcdef",e="",f,g=0;g<a.length;g++)f=a.charCodeAt(g),e+=d.charAt(f>>>4&15)+d.charAt(f&15);return e}
function rstr2b64(a){try{b64pad}catch(c){b64pad=""}for(var d="",e=a.length,f=0;f<e;f+=3)for(var g=a.charCodeAt(f)<<16|(f+1<e?a.charCodeAt(f+1)<<8:0)|(f+2<e?a.charCodeAt(f+2):0),h=0;4>h;h++)d=8*f+6*h>8*a.length?d+b64pad:d+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(g>>>6*(3-h)&63);return d}
function arr2b64(a){try{b64pad}catch(c){b64pad=""}for(var d="",e=a.length,f=0;f<e;f+=3)for(var g=a[f]<<16|(f+1<e?a[f+1]<<8:0)|(f+2<e?a[f+2]:0),h=0;4>h;h++)d=8*f+6*h>8*a.length?d+b64pad:d+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(g>>>6*(3-h)&63);return d}
function rstr2any(a,c){var d=c.length,e,f,g,h,r,l=Array(Math.ceil(a.length/2));for(e=0;e<l.length;e++)l[e]=a.charCodeAt(2*e)<<8|a.charCodeAt(2*e+1);var z=Math.ceil(8*a.length/(Math.log(c.length)/Math.log(2))),n=Array(z);for(f=0;f<z;f++){r=[];for(e=h=0;e<l.length;e++)if(h=(h<<16)+l[e],g=Math.floor(h/d),h-=g*d,0<r.length||0<g)r[r.length]=g;n[f]=h;l=r}d="";for(e=n.length-1;0<=e;e--)d+=c.charAt(n[e]);return d}
function str2rstr_utf8(a){for(var c="",d=-1,e,f;++d<a.length;)e=a.charCodeAt(d),f=d+1<a.length?a.charCodeAt(d+1):0,55296<=e&&56319>=e&&56320<=f&&57343>=f&&(e=65536+((e&1023)<<10)+(f&1023),d++),127>=e?c+=String.fromCharCode(e):2047>=e?c+=String.fromCharCode(192|e>>>6&31,128|e&63):65535>=e?c+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|e&63):2097151>=e&&(c+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|e&63));return c}
function str2rstr_utf16le(a){for(var c="",d=0;d<a.length;d++)c+=String.fromCharCode(a.charCodeAt(d)&255,a.charCodeAt(d)>>>8&255);return c}function str2rstr_utf16be(a){for(var c="",d=0;d<a.length;d++)c+=String.fromCharCode(a.charCodeAt(d)>>>8&255,a.charCodeAt(d)&255);return c}function rstr2binl(a){for(var c=Array(a.length>>2),d=0;d<c.length;d++)c[d]=0;for(d=0;d<8*a.length;d+=8)c[d>>5]|=(a.charCodeAt(d/8)&255)<<d%32;return c}
function binl2rstr(a){for(var c="",d=0;d<32*a.length;d+=8)c+=String.fromCharCode(a[d>>5]>>>d%32&255);return c}
function binl_md5(a,c){a[c>>5]|=128<<c%32;a[(c+64>>>9<<4)+14]=c;for(var d=1732584193,e=-271733879,f=-1732584194,g=271733878,h=0;h<a.length;h+=16)var r=d,l=e,z=f,n=g,d=md5_ff(d,e,f,g,a[h+0],7,-680876936),g=md5_ff(g,d,e,f,a[h+1],12,-389564586),f=md5_ff(f,g,d,e,a[h+2],17,606105819),e=md5_ff(e,f,g,d,a[h+3],22,-1044525330),d=md5_ff(d,e,f,g,a[h+4],7,-176418897),g=md5_ff(g,d,e,f,a[h+5],12,1200080426),f=md5_ff(f,g,d,e,a[h+6],17,-1473231341),e=md5_ff(e,f,g,d,a[h+7],22,-45705983),d=md5_ff(d,e,f,g,a[h+8],7,
1770035416),g=md5_ff(g,d,e,f,a[h+9],12,-1958414417),f=md5_ff(f,g,d,e,a[h+10],17,-42063),e=md5_ff(e,f,g,d,a[h+11],22,-1990404162),d=md5_ff(d,e,f,g,a[h+12],7,1804603682),g=md5_ff(g,d,e,f,a[h+13],12,-40341101),f=md5_ff(f,g,d,e,a[h+14],17,-1502002290),e=md5_ff(e,f,g,d,a[h+15],22,1236535329),d=md5_gg(d,e,f,g,a[h+1],5,-165796510),g=md5_gg(g,d,e,f,a[h+6],9,-1069501632),f=md5_gg(f,g,d,e,a[h+11],14,643717713),e=md5_gg(e,f,g,d,a[h+0],20,-373897302),d=md5_gg(d,e,f,g,a[h+5],5,-701558691),g=md5_gg(g,d,e,f,a[h+
10],9,38016083),f=md5_gg(f,g,d,e,a[h+15],14,-660478335),e=md5_gg(e,f,g,d,a[h+4],20,-405537848),d=md5_gg(d,e,f,g,a[h+9],5,568446438),g=md5_gg(g,d,e,f,a[h+14],9,-1019803690),f=md5_gg(f,g,d,e,a[h+3],14,-187363961),e=md5_gg(e,f,g,d,a[h+8],20,1163531501),d=md5_gg(d,e,f,g,a[h+13],5,-1444681467),g=md5_gg(g,d,e,f,a[h+2],9,-51403784),f=md5_gg(f,g,d,e,a[h+7],14,1735328473),e=md5_gg(e,f,g,d,a[h+12],20,-1926607734),d=md5_hh(d,e,f,g,a[h+5],4,-378558),g=md5_hh(g,d,e,f,a[h+8],11,-2022574463),f=md5_hh(f,g,d,e,a[h+
11],16,1839030562),e=md5_hh(e,f,g,d,a[h+14],23,-35309556),d=md5_hh(d,e,f,g,a[h+1],4,-1530992060),g=md5_hh(g,d,e,f,a[h+4],11,1272893353),f=md5_hh(f,g,d,e,a[h+7],16,-155497632),e=md5_hh(e,f,g,d,a[h+10],23,-1094730640),d=md5_hh(d,e,f,g,a[h+13],4,681279174),g=md5_hh(g,d,e,f,a[h+0],11,-358537222),f=md5_hh(f,g,d,e,a[h+3],16,-722521979),e=md5_hh(e,f,g,d,a[h+6],23,76029189),d=md5_hh(d,e,f,g,a[h+9],4,-640364487),g=md5_hh(g,d,e,f,a[h+12],11,-421815835),f=md5_hh(f,g,d,e,a[h+15],16,530742520),e=md5_hh(e,f,g,
d,a[h+2],23,-995338651),d=md5_ii(d,e,f,g,a[h+0],6,-198630844),g=md5_ii(g,d,e,f,a[h+7],10,1126891415),f=md5_ii(f,g,d,e,a[h+14],15,-1416354905),e=md5_ii(e,f,g,d,a[h+5],21,-57434055),d=md5_ii(d,e,f,g,a[h+12],6,1700485571),g=md5_ii(g,d,e,f,a[h+3],10,-1894986606),f=md5_ii(f,g,d,e,a[h+10],15,-1051523),e=md5_ii(e,f,g,d,a[h+1],21,-2054922799),d=md5_ii(d,e,f,g,a[h+8],6,1873313359),g=md5_ii(g,d,e,f,a[h+15],10,-30611744),f=md5_ii(f,g,d,e,a[h+6],15,-1560198380),e=md5_ii(e,f,g,d,a[h+13],21,1309151649),d=md5_ii(d,
e,f,g,a[h+4],6,-145523070),g=md5_ii(g,d,e,f,a[h+11],10,-1120210379),f=md5_ii(f,g,d,e,a[h+2],15,718787259),e=md5_ii(e,f,g,d,a[h+9],21,-343485551),d=safe_add(d,r),e=safe_add(e,l),f=safe_add(f,z),g=safe_add(g,n);return[d,e,f,g]}function md5_cmn(a,c,d,e,f,g){return safe_add(bit_rol(safe_add(safe_add(c,a),safe_add(e,g)),f),d)}function md5_ff(a,c,d,e,f,g,h){return md5_cmn(c&d|~c&e,a,c,f,g,h)}function md5_gg(a,c,d,e,f,g,h){return md5_cmn(c&e|d&~e,a,c,f,g,h)}
function md5_hh(a,c,d,e,f,g,h){return md5_cmn(c^d^e,a,c,f,g,h)}function md5_ii(a,c,d,e,f,g,h){return md5_cmn(d^(c|~e),a,c,f,g,h)}function safe_add(a,c){var d=(a&65535)+(c&65535);return(a>>16)+(c>>16)+(d>>16)<<16|d&65535}function bit_rol(a,c){return a<<c|a>>>32-c}
function utf8t2d(a){a=a.replace(/\r\n/g,"\n");var c=[];if(0>String.fromCharCode(237).charCodeAt(0))for(var d=0;d<a.length;d++){var e=a.charCodeAt(d);0<e?c[c.length]=e:(c[c.length]=256+e>>6|192,c[c.length]=256+e&63|128)}else for(d=0;d<a.length;d++)e=a.charCodeAt(d),128>e?c[c.length]=e:(127<e&&2048>e?c[c.length]=e>>6|192:(c[c.length]=e>>12|224,c[c.length]=e>>6&63|128),c[c.length]=e&63|128);return c}
function utf8d2t(a){for(var c=[],d=0;d<a.length;)128>a[d]?(c[c.length]=String.fromCharCode(a[d]),d++):191<a[d]&&224>a[d]?(c[c.length]=String.fromCharCode((a[d]&31)<<6|a[d+1]&63),d+=2):(c[c.length]=String.fromCharCode((a[d]&15)<<12|(a[d+1]&63)<<6|a[d+2]&63),d+=3);return c.join("")}
function b64arrays(){b64=[];f64=[];for(var a=0;64>a;a++)b64[a]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a),f64["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a)]=a}
function b64d2t(a){var c=[],d=0,e=a.length;1==e%3&&(a[a.length]=0,a[a.length]=0);for(2==e%3&&(a[a.length]=0);d<a.length;)c[c.length]=b64[a[d]>>2],c[c.length]=b64[(a[d]&3)<<4|a[d+1]>>4],c[c.length]=b64[(a[d+1]&15)<<2|a[d+2]>>6],c[c.length]=b64[a[d+2]&63],d+=3;1==e%3&&(c[c.length-1]=c[c.length-2]="=");2==e%3&&(c[c.length-1]="=");return c.join("")}
function b64t2d(a){var c=[],d=0;a=a.replace(/\n|\r/g,"");for(a=a.replace(/=/g,"");d<a.length;)c[c.length]=f64[a.charAt(d)]<<2|f64[a.charAt(d+1)]>>4,c[c.length]=(f64[a.charAt(d+1)]&15)<<4|f64[a.charAt(d+2)]>>2,c[c.length]=(f64[a.charAt(d+2)]&3)<<6|f64[a.charAt(d+3)],d+=4;2==a.length%4&&(c=c.slice(0,c.length-2));3==a.length%4&&(c=c.slice(0,c.length-1));return c}"undefined"!=typeof atob&&"undefined"!=typeof btoa||b64arrays();
"undefined"==typeof atob?(b64decode=function(a){return utf8d2t(b64t2d(a))},b64decode_bin=function(a){a=b64t2d(a);for(var c="",d=0;d<a.length;d++)c+=String.fromCharCode(a[d]);return c}):(b64decode=function(a){return decodeURIComponent(escape(atob(a)))},b64decode_bin=atob);b64encode="undefined"==typeof btoa?function(a){return b64d2t(utf8t2d(a))}:function(a){return btoa(unescape(encodeURIComponent(a)))};
function createXHR(){var a;if("undefined"!=typeof ActiveXObject)for(var c=["Microsoft.XMLHTTP","Msxml2.XMLHttp.6.0","Msxml2.XMLHttp.5.0","Msxml2.XMLHttp.4.0","Msxml2.XMLHttp.3.0"],d=0;d<c.length;d++)try{a=new ActiveXObject(c[d])}catch(e){}else"undefined"!=typeof XMLHttpRequest&&(a=new XMLHttpRequest);return a}
if(window.XDomainRequest){window.ieXDRToXHR=function(a){var c=a.XMLHttpRequest;a.XMLHttpRequest=function(){this.onreadystatechange=Object;this.xdr=this.xhr=null;this.readyState=0;this.status="";this.send=this.abort=this.setRequestHeader=this.getAllResponseHeaders=this.getResponseHeader=this.responseText=this.statusText=null;this.isxdr=!1;var a=this;a.xdrLoadedBinded=function(){a.xdrLoaded()};a.xdrErrorBinded=function(){a.xdrError()};a.xdrProgressBinded=function(){a.xdrProgress()};a.xhrReadyStateChangedBinded=
function(){a.xhrReadyStateChanged()}};XMLHttpRequest.prototype.open=function(d,e,f,g,h){var r=document.createElement("a");r.href=e;r.hostname!=document.domain?(null===this.xdr&&(this.xdr=new a.XDomainRequest),this.isxdr=!0,this.setXDRActive(),this.xdr.open(d,e)):(null===this.xhr&&(this.xhr=new c),this.isxdr=!1,this.setXHRActive(),this.xhr.open(d,e,f,g,h))};XMLHttpRequest.prototype.xdrGetResponseHeader=function(a){return"Content-Type"===a&&""<this.xdr.contentType?this.xdr.contentType:""};XMLHttpRequest.prototype.xdrGetAllResponseHeaders=
function(){return""<this.xdr.contentType?"Content-Type: "+this.xdr.contentType:""};XMLHttpRequest.prototype.xdrSetRequestHeader=function(a,c){};XMLHttpRequest.prototype.xdrLoaded=function(){if(null!==this.onreadystatechange){this.readyState=4;this.status=200;this.statusText="OK";this.responseText=this.xdr.responseText;if(a.ActiveXObject){var c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";c.loadXML(this.responseText);this.responseXML=c}this.onreadystatechange()}};XMLHttpRequest.prototype.xdrError=
function(){null!==this.onreadystatechange&&(this.readyState=4,this.status=0,this.responseText=this.statusText="",this.onreadystatechange())};XMLHttpRequest.prototype.xdrProgress=function(){null!==this.onreadystatechange&&3!==this.status&&(this.status=this.readyState=3,this.statusText="",this.onreadystatechange())};XMLHttpRequest.prototype.finalXDRRequest=function(){var a=this.xdr;delete a.onload;delete a.onerror;delete a.onprogress};XMLHttpRequest.prototype.sendXDR=function(a){var c=this.xdr;c.onload=
this.xdrLoadedBinded;c.onerror=this.xdr.ontimeout=this.xdrErrorBinded;c.onprogress=this.xdrProgressBinded;this.responseText=null;this.xdr.send(a)};XMLHttpRequest.prototype.abortXDR=function(){this.finalXDRRequest();this.xdr.abort()};XMLHttpRequest.prototype.setXDRActive=function(){this.send=this.sendXDR;this.abort=this.abortXDR;this.getResponseHeader=this.xdrGetResponseHeader;this.getAllResponseHeaders=this.xdrGetAllResponseHeaders;this.setRequestHeader=this.xdrSetRequestHeader};XMLHttpRequest.prototype.xhrGetResponseHeader=
function(a){return this.xhr.getResponseHeader(a)};XMLHttpRequest.prototype.xhrGetAllResponseHeaders=function(){return this.xhr.getAllResponseHeaders()};XMLHttpRequest.prototype.xhrSetRequestHeader=function(a,c){return this.xhr.setRequestHeader(a,c)};XMLHttpRequest.prototype.xhrReadyStateChanged=function(){if(null!==this.onreadystatechange&&this.readyState!==this.xhr.readyState){var a=this.xhr;this.readyState=a.readyState;4===this.readyState&&(this.status=a.status,this.statusText=a.statusText,this.responseText=
a.responseText,this.responseXML=a.responseXML);this.onreadystatechange()}};XMLHttpRequest.prototype.finalXHRRequest=function(){delete this.xhr.onreadystatechange};XMLHttpRequest.prototype.abortXHR=function(){this.finalXHRRequest();this.xhr.abort()};XMLHttpRequest.prototype.sendXHR=function(a){this.xhr.onreadystatechange=this.xhrReadyStateChangedBinded;this.xhr.send(a)};XMLHttpRequest.prototype.setXHRActive=function(){this.send=this.sendXHR;this.abort=this.abortXHR;this.getResponseHeader=this.xhrGetResponseHeader;
this.getAllResponseHeaders=this.xhrGetAllResponseHeaders;this.setRequestHeader=this.xhrSetRequestHeader};a.ieXDRToXHR=void 0};var isWebsocketSupport=function(){if(-1<navigator.userAgent.indexOf("Safari")&&1>navigator.userAgent.indexOf("Chrome"))return!1;window.WebSocket=window.WebSocket||window.MozWebSocket;return window.WebSocket?!0:!1}();isWebsocketSupport||window.ieXDRToXHR(window)}
String.prototype.htmlEnc=function(){if(!this)return this;var a=this.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=a.replace(/\"/g,"&quot;");return a=a.replace(/\n/g,"<br />")};String.prototype.revertHtmlEnc=function(){if(!this)return this;var a=this.replace(/&amp;/gi,"&"),a=a.replace(/&lt;/gi,"<"),a=a.replace(/&gt;/gi,">"),a=a.replace(/&quot;/gi,'"');return a=a.replace(/<br( )?(\/)?>/gi,"\n")};
Date.jab2date=function(a){var c=new Date(Date.UTC(a.substr(0,4),a.substr(5,2)-1,a.substr(8,2),a.substr(11,2),a.substr(14,2),a.substr(17,2)));if("Z"!=a.substr(a.length-6,1)){var d=new Date;d.setTime(0);d.setUTCHours(a.substr(a.length-5,2));d.setUTCMinutes(a.substr(a.length-2,2));"+"==a.substr(a.length-6,1)?c.setTime(c.getTime()-d.getTime()):"-"==a.substr(a.length-6,1)&&c.setTime(c.getTime()+d.getTime())}return c};Date.hrTime=function(a){return Date.jab2date(a).toLocaleString()};
Date.prototype.jabberDate=function(){var a=function(a){return 10>a?"0"+a:a},c=this.getUTCFullYear()+"-",c=c+(a(this.getUTCMonth()+1)+"-"),c=c+(a(this.getUTCDate())+"T"),c=c+(a(this.getUTCHours())+":"),c=c+(a(this.getUTCMinutes())+":");return c+=a(this.getUTCSeconds())+"Z"};Number.max=function(a,c){return a>c?a:c};Number.min=function(a,c){return a<c?a:c};var browserSys={},browserUa=navigator.userAgent.toLowerCase(),b;
(b=browserUa.match(/msie ([\d.]+)/))?browserSys.ie=b[1]:(b=browserUa.match(/firefox\/([\d.]+)/))?browserSys.firefox=b[1]:(b=browserUa.match(/chrome\/([\d.]+)/))?browserSys.chrome=b[1]:(b=browserUa.match(/version\/([\d.]+).*safari/))?browserSys.safari=b[1]:0;var isFormDataSupport=!!window.FormData&&"[object Function]"===Object.prototype.toString.call(FormData);jQuery.fn._Huploadify=!0===isFormDataSupport?snsimUploadUseXHR:function(){};
var SNSFile=function(a,c,d){this.path=c;this.name=a;this.size=d;a?(c=a.lastIndexOf("."),a=-1!=c?a.substring(c+1).toLowerCase():"unknown"):a=void 0;this.type=a};SNSFile.prototype.renderSize=function(){return SNSFile.renderSize(this.size)};SNSFile.roundFun=function(a,c){if(0<=a){var d=parseInt(a*Math.pow(10,c)+.5)/Math.pow(10,c);return d}numberRound1=-a;d=parseInt(numberRound1*Math.pow(10,c)+.5)/Math.pow(10,c);return-d};
SNSFile.renderSize=function(a){if(null==a||""==a)return"";var c=0;a=parseFloat(a);return SNSFile.roundFun(a/Math.pow(1024,c=Math.floor(Math.log(a)/Math.log(1024))),0)+"Bytes KB MB GB TB PB EB ZB YB".split(" ")[c]};var FileUpload=function(a){this.inputId=a;this.fileObj};FileUpload.getInstance=function(a,c){FileUpload.list||(FileUpload.list=new SNSBaseList);var d=FileUpload.list.get(a);d||(d=new FileUpload(a),FileUpload.list.add(a,d));c&&jQuery("#"+a)._Huploadify(c);return d};
FileUpload.getInstanceByInputId=function(a){return FileUpload.list.get(a)};FileUpload.prototype.sendFile=function(a){this.fileObj.funSendFile(a)};FileUpload.formatFileSize=function(a,c){return a=1048576<a&&!c?(Math.round(100*a/1048576)/100).toString()+"MB":(Math.round(100*a/1024)/100).toString()+"KB"};FileUpload.getFile=function(a,c){for(var d=0;d<c.length;d++)if(c[d].index==a)return c[d];return!1};
if(!1===isFormDataSupport){var SNSIMUploadUseFlash=function(){this.swfUploadList=new SNSBaseList};SNSIMUploadUseFlash.getInstance=function(){SNSIMUploadUseFlash._instance||(SNSIMUploadUseFlash._instance=new SNSIMUploadUseFlash);return SNSIMUploadUseFlash._instance};SNSIMUploadUseFlash.prototype.addUploader=function(a){if(!this.swfUploadList.get(a.button_placeholder_id)){var c=new SWFUpload({upload_url:"",flash_url:a.flash_url,button_placeholder_id:a.button_placeholder_id,button_image_url:a.button_image_url,
button_width:a.button_width,button_height:a.button_height,button_text:a.button_text,button_text_style:a.button_text_style,button_text_left_padding:a.button_text_left_padding,button_text_top_padding:a.button_text_top_padding,button_disabled:a.button_disabled,button_cursor:a.button_cursor,button_window_mode:a.button_window_mode,file_size_limit:"30000",file_types:"image"==a.contentType||"avatar"==a.contentType?"*.jpg;*.gif;*.jpeg;*.png;*.bmp":"*.*",file_types_description:"Image Files",file_queue_limit:"1",
chat_info:{},content_type:"avatar"==a.contentType?"avatar":"image"==a.contentType?8:4,file_dialog_start_handler:function(){},file_queued_handler:function(c){var e=a.getChatInfo&&a.getChatInfo()||{},f=YYIMChat.getServletPath().FILE_UPLOAD_SERVLET,g,h,r,l=e.to||YYIMChat.getUserNode();YYIMChat.isAnonymous()?(g=YYIMChat.getUserFullJID(),r="anonymous"):(g=YYIMChat.getUserNode(),r=YYIMChat.getToken());h=e.resource&&"anonymous"==e.resource.toLowerCase()?YYIMChat.getJIDUtil().buildUserJID(YYIMChat.getJIDUtil().getID(l),
"ANONYMOUS"):YYIMChat.getJIDUtil().getNode(l);f=f+"?fileName="+encodeURI(c.name,"utf-8")+"&uploadedSize=0&fileSize="+c.size+"&fromUser="+g+"&toUser="+h+"&token="+r+"&muc=1";"avatar"===a.contentType&&(f+="&isAvatar=true");this.settings.chat_info={to:YYIMChat.getJIDUtil().getNode(l),type:e.type?e.type:"chat",resource:e.resource};this.setUploadURL(f)},file_queue_error_handler:function(){a.error&&a.error(arguments)},file_dialog_complete_handler:function(){this.startUpload()},upload_start_handler:function(){},
upload_progress_handler:function(){},upload_error_handler:function(){a.error&&a.error(arguments)},upload_success_handler:function(c,e){var f=this.settings;if("200"==JSON.parse(e).code){var g=JSON.parse(e).result.attachId;"avatar"===a.contentType?a.success&&a.success(g):(g={id:Math.uuid(),body:{content:new SNSFile(c.name,g,c.size),contentType:f.content_type,dateline:(new Date).getTime()},to:f.chat_info.to,type:f.chat_info.type,success:function(c){var d=Object.clone(c);d.to=YYIMChat.getJIDUtil().getID(c.to);
d.body.content.path=YYIMChat.getFileUrl(d.body.content.path);a.success&&a.success(d)}},f.chat_info.resource&&(g.resource=f.chat_info.resource),YYIMChat.sendMessage(g))}},upload_complete_handler:function(){}});this.swfUploadList.add(a.button_placeholder_id,c)}}}var isDelete=!1,filesIndex="",deletefilesIndex="",FILE_TYPES=["rar","zip","pdf","txt","html"],IMAGE_TYPES=["png","gif","jpg","jpeg","bmp"],UPLOAD_AVATAR="snsim_upload_avatar";
function snsimUploadUseXHR(a){var c=jQuery.extend({fileTypeExts:"*",uploader:"",auto:!0,method:"post",formData:{},fileObjName:"file",fileSizeLimit:2048,showUploadedPercent:!0,showUploadedSize:!0,buttonText:"",removeTimeout:100,itemTemplate:'<div id="${fileID}" class="uploadify-queue-item"><div class="upload_file_icon"><img src="${fileTypeIcon}" /></div><div class="uploadify-progress"><div id="udn_uploadify_progress_bar" class="uploadify-progress-bar"></div></div><span class="up_filename">${fileName}</span><span class="uploadbtn" style="display:none;">\u4e0a\u4f20</span><button id="btnstop" style="display:none;" >stop</button><button id="${continueUpload}" style="display:none;">\u7eed\u4f20</button><span class="delfilebtn" ></span></div>',
breakPoints:!0,fileSplitSize:10485760,getUploadedSize:null,saveUploadedSize:null,saveInfoLocal:!0,onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null,onSelect:null,uploadIdPrefix:"file_upload_",inputId:null,to:null,type:4,chatType:"chat",showProcess:!1,processId:null,resource:null},a),d=function(a,d,g,h,r,l){var z=parseInt(SNSStorage.getLocalVal(g.name))||0,n,p;YYIMChat.isAnonymous()?(n=YYIMChat.getUserFullJID(),p="anonymous"):(n=YYIMChat.getUserNode(),
p=YYIMChat.getToken());l=c.resource&&"anonymous"==c.resource.toLowerCase()?YYIMChat.getJIDUtil().buildUserJID(YYIMChat.getJIDUtil().getID(l),"ANONYMOUS"):"groupchat"==c.chatType?YYIMChat.getJIDUtil().buildChatGroupJID(YYIMChat.getJIDUtil().getNode(l)):YYIMChat.getJIDUtil().buildUserJID(YYIMChat.getJIDUtil().getNode(l));a=a+"?fileName="+encodeURI(g.name,"utf-8")+"&uploadedSize="+z+"&fileSize="+r+"&fromUser="+n+"&toUser="+l+"&token="+p+"&muc=1";c.type==UPLOAD_AVATAR&&(a+="&isAvatar=true");YYIMChat.log("file upload url",
2,a);d.open(c.method,a,!0);d.withCredentials=!0;d.setRequestHeader("X-Requested-With","XMLHttpRequest");a=new FormData;a.append(c.fileObjName,g);if(h)for(key in h)a.append(key,h[key]);d.send(a)};this.each(function(){var a=jQuery(this),f=jQuery(".uploadify").length+1,g='<span id="'+c.uploadIdPrefix+f+'-queue" class="uploadify-queue"></span>',h=jQuery("#"+c.processId);0>=jQuery("#"+c.uploadIdPrefix+f+"-queue").length&&c.showProcess&&(h.append(g),jQuery("#"+c.processId).perfectScrollbar({suppressScrollX:!0}));
FileUpload.getInstanceByInputId(c.inputId).fileObj={uploadAllowed:!0,fileInput:a,uploadFileList:h.find("#"+c.uploadIdPrefix+f+"-queue"),url:c.uploader,fileFilter:[],uploadOver:!1,filter:function(a){for(var d=[],e=c.fileTypeExts.split(";"),f=0,g=a.length;f<g;f++){var h=a[f];parseInt(FileUpload.formatFileSize(h.size,!0))>c.fileSizeLimit?alert("\u6587\u4ef6"+h.name+"\u5927\u5c0f\u8d85\u51fa\u9650\u5236\uff01"):"*"==c.fileTypeExts||0<=jQuery.inArray(h.name.split(".").pop().toLowerCase(),e)?d.push(h):
alert("\u6587\u4ef6"+h.name+"\u7c7b\u578b\u4e0d\u5141\u8bb8\uff01")}return d},funSelect:function(d){for(var g=0,h=d.length;g<h;g++){var n=d[g];filesIndex+=","+n.index;var p="unknown";n.name&&(p=n.name.substr(n.name.lastIndexOf(".")+1));p=jQuery(c.itemTemplate.replace(/\${fileID}/g,"fileupload_"+f+"_"+n.index).replace(/\${fileTypeIcon}/g,"res/skin/default/icons/filetype/"+p+".png").replace(/\${fileName}/g,n.name).replace(/\${fileSize}/g,FileUpload.formatFileSize(n.size)).replace(/\${instanceID}/g,
a.attr("id")).replace(/\${continueUpload}/g,"continueUpload_"+f+"_"+n.index));c.auto&&p.find(".uploadbtn").remove();var y=0,w="0KB",x="0%";c.breakPoints&&(x=this.funGetUploadedSize(n),y=x/n.size*100+"%",w=FileUpload.formatFileSize(x),x=(x/n.size*100).toFixed(2)+"%",p.find(".uploadify-progress-bar").css("width",y));this.uploadFileList.append(p);c.showUploadedSize&&(y='<span class="progressnum"><span id="isUploadingFileSize_'+f+"_"+n.index+'" class="uploadedsize">'+w+'</span>/<span class="totalsize">${fileSize}</span></span>'.replace(/\${fileSize}/g,
FileUpload.formatFileSize(n.size)),p.find(".uploadify-progress").after(y));c.showUploadedPercent&&(y='<span class="up_percent" style="display:none">'+x+"</span>",p.find(".uploadify-progress").after(y));c.onSelect&&c.onSelect(d);c.auto?this.funUploadFile(n):p.find(".uploadbtn").click(function(a){return function(){FileUpload.getInstanceByInputId(c.inputId).fileObj.funUploadFile(a)}}(n));p.find(".delfilebtn").click(function(a){return function(){FileUpload.getInstanceByInputId(c.inputId).fileObj.funDeleteFile(a)}}(n));
p.find("#btnstop").click(function(a){return function(){deletefilesIndex+=","+a.index}}(n));p.find("#continueUpload_"+f+"_"+n.index).click(function(a){var d=a.index;return function(){if(0<deletefilesIndex.length&&-1<deletefilesIndex.indexOf(","+d)){for(var a=deletefilesIndex.split(","),e="",f=0;f<a.length;f++)a[f]!=d&&""!=a[f]&&(e+=","+a[f]);deletefilesIndex=e}(a=FileUpload.getFile(d,FileUpload.getInstanceByInputId(c.inputId).fileObj.fileFilter))&&FileUpload.getInstanceByInputId(c.inputId).fileObj.funUploadFile(a)}}(n))}},
onProgress:function(a,d,e){var g=h.find("#fileupload_"+f+"_"+a.index+" .uploadify-progress"),p=d,y=g.attr("lastLoaded")||0;d<y&&(y=0);d-=parseInt(y);y=(d/e).toFixed(4);y=1<y?1:y;c.onUploadProgress&&c.onUploadProgress({percent:y,loaded:d,total:e});var y=g.children(".uploadify-progress-bar"),w=parseFloat(y.get(0).style.width||0),w=(d/e*100+w).toFixed(2),x=100<w?"99.99%":w+"%";c.showUploadedSize&&(g.nextAll(".progressnum .uploadedsize").text(FileUpload.formatFileSize(d)),g.nextAll(".progressnum .totalsize").text(FileUpload.formatFileSize(e)));
c.showUploadedPercent&&(g.nextAll(".up_percent").text(x),d=FileUpload.formatFileSize(w*e/100),w*e/100>e&&(d=FileUpload.formatFileSize(e)),document.getElementById("isUploadingFileSize_"+f+"_"+a.index).innerHTML=d);y.css("width",x);p<c.fileSplitSize?g.attr("lastLoaded",p):g.removeAttr("lastLoaded")},funGetProgressWidth:function(a){return h.find("#fileupload_"+f+"_"+a+" .uploadify-progress-bar").get(0).style.width||""},funGetUploadedSize:function(a){if(c.getUploadedSize)return c.getUploadedSize(a);if(c.saveInfoLocal)return parseInt(SNSStorage.getLocalVal(a.name))||
0},funSaveUploadedSize:function(a,d,e){c.saveUploadedSize?c.saveUploadedSize(a,d):c.saveInfoLocal&&!e&&SNSStorage.setLocal(a.name,d)},funSendFile:function(a){a=a.files;a=this.filter(a);for(var c=0,d=a.length;c<d;c++)this.fileFilter.push(a[c]);this.funDealFiles(a);return this},funDealFiles:function(a){for(var c=h.find(".uploadify-queue .uploadify-queue-item").length,d=0,e=a.length;d<e;d++)a[d].index=++c,a[d].id="fileupload_"+f+"_"+a[d].index;this.funSelect(a);return this},funDeleteFile:function(a){c.breakPoints&&
(deletefilesIndex+=","+a.index);h.find("#fileupload_"+f+"_"+a.index).fadeOut();FileUpload.getInstanceByInputId(c.inputId).fileObj.fileInput.val("");c.onCancel&&c.onCancel(a);var d=YYIMChat.getServletPath().FILE_DELETE_SERVLET,e={fileName:a.name,toUser:c.to,fromUser:YYIMChat.getUserNode(),token:YYIMChat.getToken(),muc:1};$.ajax({url:d,async:!1,type:"POST",data:e,dataType:"text",success:function(c){"success"==c&&(SNSStorage.removeLocal(a.name),isDelete=!0)},error:function(){SNSStorage.removeLocal(a.name);
isDelete=!0}});return this},funUploadFile:function(a){var e=!1,g=a,n=h.find("#fileupload_"+f+"_"+a.index),p=function(){FileUpload.getInstanceByInputId(c.inputId).fileObj.uploadOver&&(n.find(".uploadify-progress-bar").css("width","100%"),c.showUploadedSize&&n.find(".uploadedsize").text(n.find(".totalsize").text()),c.showUploadedPercent&&n.find(".up_percent").text("100%"))};try{e=new XMLHttpRequest}catch(y){e=ActiveXobject("Msxml12.XMLHTTP")}if("undefined"==e)alert("\u6d4f\u89c8\u5668\u7248\u672c\u4e0d\u652f\u6301\uff0c\u8bf7\u66f4\u65b0\u7248\u672c");
else{31457280>=g.size||-1<g.type.indexOf("image/")?c.breakPoints=!1:c.breakPoints=!0;if(c.breakPoints){var w=a.name,x=a.id,u=a.index,B=a.size,q=parseInt(this.funGetUploadedSize(g));if(browserSys.firefox){var C=browserSys.firefox.split(".");a=6<C[0]&&15>C[0]?g.mozSlice(q,q+c.fileSplitSize):g.slice(q,q+c.fileSplitSize)}else browserSys.chrome?(C=browserSys.chrome.split("."),a=10<C[0]&&21>C[0]?g.webkitSlice(q,q+c.fileSplitSize):g.slice(q,q+c.fileSplitSize)):a=g.slice(q,q+c.fileSplitSize);a.name=w;a.id=
x;a.index=u}e.upload&&!1!==q&&e.upload.addEventListener("progress",function(d){FileUpload.getInstanceByInputId(c.inputId).fileObj.onProgress(a,d.loaded,g.size)},!1);var A=c.to;g.userJid=A;e.onreadystatechange=function(n){if(4==e.readyState){FileUpload.getInstanceByInputId(c.inputId).fileObj.uploadOver=!0;if(200==e.status){n=JSON.parse(e.responseText);"success"==n.status&&(setTimeout(function(){h.find("#fileupload_"+f+"_"+g.index).fadeOut()},100),SNSStorage.removeLocal(a.name));var v=g.index;c.breakPoints?
(q+=c.fileSplitSize,"success"==n.status||isDelete?(FileUpload.getInstanceByInputId(c.inputId).fileObj.funSaveUploadedSize(g,q,!0),isDelete=!1):FileUpload.getInstanceByInputId(c.inputId).fileObj.funSaveUploadedSize(g,q,!1),-1<deletefilesIndex.indexOf(v)&&SNSStorage.removeLocal(g.name),q<B?(FileUpload.getInstanceByInputId(c.inputId).fileObj.uploadOver=!1,-1<filesIndex.indexOf(","+v)&&-1==deletefilesIndex.indexOf(v)&&(browserSys.firefox?(v=browserSys.firefox.split("."),a=6<v[0]&&15>v[0]?g.mozSlice(q,
q+c.fileSplitSize):g.slice(q,q+c.fileSplitSize)):browserSys.chrome?(v=browserSys.chrome.split("."),a=10<v[0]&&21>v[0]?g.webkitSlice(q,q+c.fileSplitSize):g.slice(q,q+c.fileSplitSize)):a=g.slice(q,q+c.fileSplitSize),a.name=w,a.id=x,a.index=u,a.size=B,d(FileUpload.getInstanceByInputId(c.inputId).fileObj.url,e,a,c.formData,g.size,A))):p()):p();FileUpload.getInstanceByInputId(c.inputId).fileObj.uploadOver&&(c.type==UPLOAD_AVATAR?c.onUploadSuccess&&c.onUploadSuccess(n.result):(n=n.result,n={id:Math.uuid(),
body:{content:new SNSFile(a.name,n.attachId,a.size),contentType:c.type,dateline:(new Date).getTime()},to:c.to,type:c.chatType,success:function(a){var d=Object.clone(a);d.to=YYIMChat.getJIDUtil().getID(a.to);d.body.content.path=YYIMChat.getFileUrl(d.body.content.path);c.onUploadSuccess&&c.onUploadSuccess(d)}},c.resource&&(n.resource=c.resource),YYIMChat.sendMessage(n)),setTimeout(function(){h.find("#fileupload_"+f+"_"+g.index).fadeOut()},c.removeTimeout))}else FileUpload.getInstanceByInputId(c.inputId).fileObj.uploadOver&&
c.onUploadError&&c.onUploadError(g,e.responseText),setTimeout(function(){h.find("#fileupload_"+f+"_"+g.index).fadeOut()},100),SNSStorage.removeLocal(a.name);FileUpload.getInstanceByInputId(c.inputId).fileObj.uploadOver&&(c.onUploadComplete&&c.onUploadComplete(g,e.responseText),FileUpload.getInstanceByInputId(c.inputId).fileObj.fileInput.val(""))}};c.onUploadStart&&c.onUploadStart();FileUpload.getInstanceByInputId(c.inputId).fileObj.uploadAllowed=!0;d(this.url,e,a,c.formData,g.size,A)}}};c.onInit&&
c.onInit()})}
if(!1===isFormDataSupport){var SWFUpload;void 0==SWFUpload&&(SWFUpload=function(a){this.initSWFUpload(a)});SWFUpload.prototype.initSWFUpload=function(a){try{this.customSettings={},this.settings=a,this.eventQueue=[],this.movieName="SWFUpload_"+SWFUpload.movieCount++,this.movieElement=null,SWFUpload.instances[this.movieName]=this,this.initSettings(),this.loadFlash(),this.displayDebugInfo()}catch(c){throw delete SWFUpload.instances[this.movieName],c;}};SWFUpload.instances={};SWFUpload.movieCount=0;SWFUpload.version=
"2.2.0 2009-03-25";SWFUpload.QUEUE_ERROR={QUEUE_LIMIT_EXCEEDED:-100,FILE_EXCEEDS_SIZE_LIMIT:-110,ZERO_BYTE_FILE:-120,INVALID_FILETYPE:-130};SWFUpload.UPLOAD_ERROR={HTTP_ERROR:-200,MISSING_UPLOAD_URL:-210,IO_ERROR:-220,SECURITY_ERROR:-230,UPLOAD_LIMIT_EXCEEDED:-240,UPLOAD_FAILED:-250,SPECIFIED_FILE_ID_NOT_FOUND:-260,FILE_VALIDATION_FAILED:-270,FILE_CANCELLED:-280,UPLOAD_STOPPED:-290};SWFUpload.FILE_STATUS={QUEUED:-1,IN_PROGRESS:-2,ERROR:-3,COMPLETE:-4,CANCELLED:-5};SWFUpload.BUTTON_ACTION={SELECT_FILE:-100,
SELECT_FILES:-110,START_UPLOAD:-120};SWFUpload.CURSOR={ARROW:-1,HAND:-2};SWFUpload.WINDOW_MODE={WINDOW:"window",TRANSPARENT:"transparent",OPAQUE:"opaque"};SWFUpload.completeURL=function(a){if("string"!==typeof a||a.match(/^https?:\/\//i)||a.match(/^\//))return a;var c=window.location.pathname.lastIndexOf("/");path=0>=c?"/":window.location.pathname.substr(0,c)+"/";return path+a};SWFUpload.prototype.initSettings=function(){this.ensureDefault=function(a,c){this.settings[a]=void 0==this.settings[a]?c:
this.settings[a]};this.ensureDefault("upload_url","");this.ensureDefault("preserve_relative_urls",!1);this.ensureDefault("file_post_name","Filedata");this.ensureDefault("post_params",{});this.ensureDefault("use_query_string",!1);this.ensureDefault("requeue_on_error",!1);this.ensureDefault("http_success",[]);this.ensureDefault("assume_success_timeout",0);this.ensureDefault("file_types","*.*");this.ensureDefault("file_types_description","All Files");this.ensureDefault("file_size_limit",0);this.ensureDefault("file_upload_limit",
0);this.ensureDefault("file_queue_limit",0);this.ensureDefault("flash_url","swfupload.swf");this.ensureDefault("prevent_swf_caching",!0);this.ensureDefault("button_image_url","");this.ensureDefault("button_width",1);this.ensureDefault("button_height",1);this.ensureDefault("button_text","");this.ensureDefault("button_text_style","color: #000000; font-size: 16pt;");this.ensureDefault("button_text_top_padding",0);this.ensureDefault("button_text_left_padding",0);this.ensureDefault("button_action",SWFUpload.BUTTON_ACTION.SELECT_FILES);
this.ensureDefault("button_disabled",!1);this.ensureDefault("button_placeholder_id","");this.ensureDefault("button_placeholder",null);this.ensureDefault("button_cursor",SWFUpload.CURSOR.ARROW);this.ensureDefault("button_window_mode",SWFUpload.WINDOW_MODE.OPAQUE);this.ensureDefault("debug",!1);this.settings.debug_enabled=this.settings.debug;this.settings.return_upload_start_handler=this.returnUploadStart;this.ensureDefault("swfupload_loaded_handler",null);this.ensureDefault("file_dialog_start_handler",
null);this.ensureDefault("file_queued_handler",null);this.ensureDefault("file_queue_error_handler",null);this.ensureDefault("file_dialog_complete_handler",null);this.ensureDefault("upload_start_handler",null);this.ensureDefault("upload_progress_handler",null);this.ensureDefault("upload_error_handler",null);this.ensureDefault("upload_success_handler",null);this.ensureDefault("upload_complete_handler",null);this.ensureDefault("debug_handler",this.debugMessage);this.ensureDefault("custom_settings",{});
this.customSettings=this.settings.custom_settings;this.settings.prevent_swf_caching&&(this.settings.flash_url=this.settings.flash_url+(0>this.settings.flash_url.indexOf("?")?"?":"&")+"preventswfcaching="+(new Date).getTime());this.settings.preserve_relative_urls||(this.settings.upload_url=SWFUpload.completeURL(this.settings.upload_url),this.settings.button_image_url=SWFUpload.completeURL(this.settings.button_image_url));delete this.ensureDefault};SWFUpload.prototype.loadFlash=function(){var a,c;if(null!==
document.getElementById(this.movieName))throw"ID "+this.movieName+" is already in use. The Flash Object could not be added";a=document.getElementById(this.settings.button_placeholder_id)||this.settings.button_placeholder;if(void 0==a)throw"Could not find the placeholder element: "+this.settings.button_placeholder_id;c=document.createElement("div");c.innerHTML=this.getFlashHTML();a.parentNode.replaceChild(c.firstChild,a);void 0==window[this.movieName]&&(window[this.movieName]=this.getMovieElement())};
SWFUpload.prototype.getFlashHTML=function(){var a="",c,d=navigator.userAgent.toLowerCase();window.ActiveXObject&&(c=d.match(/msie ([\d.]+)/)[1]);c&&"9"==c.substring(0,1)&&(a="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000");return['<object id="',this.movieName,'" classid="',a,'"  type="application/x-shockwave-flash" data="',this.settings.flash_url,'" width="',this.settings.button_width,'" height="',this.settings.button_height,'" class="swfupload"><param name="wmode" value="',this.settings.button_window_mode,
'" /><param name="movie" value="',this.settings.flash_url,'" /><param name="quality" value="high" /><param name="menu" value="false" /><param name="allowScriptAccess" value="always" />','<param name="flashvars" value="'+this.getFlashVars()+'" />',"</object>"].join("")};SWFUpload.prototype.getFlashVars=function(){var a=this.buildParamString(),c=this.settings.http_success.join(",");return["movieName=",encodeURIComponent(this.movieName),"&amp;uploadURL=",encodeURIComponent(this.settings.upload_url),
"&amp;useQueryString=",encodeURIComponent(this.settings.use_query_string),"&amp;requeueOnError=",encodeURIComponent(this.settings.requeue_on_error),"&amp;httpSuccess=",encodeURIComponent(c),"&amp;assumeSuccessTimeout=",encodeURIComponent(this.settings.assume_success_timeout),"&amp;params=",encodeURIComponent(a),"&amp;filePostName=",encodeURIComponent(this.settings.file_post_name),"&amp;fileTypes=",encodeURIComponent(this.settings.file_types),"&amp;fileTypesDescription=",encodeURIComponent(this.settings.file_types_description),
"&amp;fileSizeLimit=",encodeURIComponent(this.settings.file_size_limit),"&amp;fileUploadLimit=",encodeURIComponent(this.settings.file_upload_limit),"&amp;fileQueueLimit=",encodeURIComponent(this.settings.file_queue_limit),"&amp;debugEnabled=",encodeURIComponent(this.settings.debug_enabled),"&amp;buttonImageURL=",encodeURIComponent(this.settings.button_image_url),"&amp;buttonWidth=",encodeURIComponent(this.settings.button_width),"&amp;buttonHeight=",encodeURIComponent(this.settings.button_height),
"&amp;buttonText=",encodeURIComponent(this.settings.button_text),"&amp;buttonTextTopPadding=",encodeURIComponent(this.settings.button_text_top_padding),"&amp;buttonTextLeftPadding=",encodeURIComponent(this.settings.button_text_left_padding),"&amp;buttonTextStyle=",encodeURIComponent(this.settings.button_text_style),"&amp;buttonAction=",encodeURIComponent(this.settings.button_action),"&amp;buttonDisabled=",encodeURIComponent(this.settings.button_disabled),"&amp;buttonCursor=",encodeURIComponent(this.settings.button_cursor)].join("")};
SWFUpload.prototype.getMovieElement=function(){void 0==this.movieElement&&(this.movieElement=document.getElementById(this.movieName));if(null===this.movieElement)throw"Could not find Flash element";return this.movieElement};SWFUpload.prototype.buildParamString=function(){var a=this.settings.post_params,c=[];if("object"===typeof a)for(var d in a)a.hasOwnProperty(d)&&c.push(encodeURIComponent(d.toString())+"="+encodeURIComponent(a[d].toString()));return c.join("&amp;")};SWFUpload.prototype.destroy=
function(){try{this.cancelUpload(null,!1);var a=null;if((a=this.getMovieElement())&&"unknown"===typeof a.CallFunction){for(var c in a)try{"function"===typeof a[c]&&(a[c]=null)}catch(d){}try{a.parentNode.removeChild(a)}catch(e){}}window[this.movieName]=null;SWFUpload.instances[this.movieName]=null;delete SWFUpload.instances[this.movieName];this.movieName=this.eventQueue=this.customSettings=this.settings=this.movieElement=null;return!0}catch(f){return!1}};SWFUpload.prototype.displayDebugInfo=function(){this.debug(["---SWFUpload Instance Info---\nVersion: ",
SWFUpload.version,"\nMovie Name: ",this.movieName,"\nSettings:\n\tupload_url:               ",this.settings.upload_url,"\n\tflash_url:                ",this.settings.flash_url,"\n\tuse_query_string:         ",this.settings.use_query_string.toString(),"\n\trequeue_on_error:         ",this.settings.requeue_on_error.toString(),"\n\thttp_success:             ",this.settings.http_success.join(", "),"\n\tassume_success_timeout:   ",this.settings.assume_success_timeout,"\n\tfile_post_name:           ",this.settings.file_post_name,
"\n\tpost_params:              ",this.settings.post_params.toString(),"\n\tfile_types:               ",this.settings.file_types,"\n\tfile_types_description:   ",this.settings.file_types_description,"\n\tfile_size_limit:          ",this.settings.file_size_limit,"\n\tfile_upload_limit:        ",this.settings.file_upload_limit,"\n\tfile_queue_limit:         ",this.settings.file_queue_limit,"\n\tdebug:                    ",this.settings.debug.toString(),"\n\tprevent_swf_caching:      ",this.settings.prevent_swf_caching.toString(),
"\n\tbutton_placeholder_id:    ",this.settings.button_placeholder_id.toString(),"\n\tbutton_placeholder:       ",this.settings.button_placeholder?"Set":"Not Set","\n\tbutton_image_url:         ",this.settings.button_image_url.toString(),"\n\tbutton_width:             ",this.settings.button_width.toString(),"\n\tbutton_height:            ",this.settings.button_height.toString(),"\n\tbutton_text:              ",this.settings.button_text.toString(),"\n\tbutton_text_style:        ",this.settings.button_text_style.toString(),
"\n\tbutton_text_top_padding:  ",this.settings.button_text_top_padding.toString(),"\n\tbutton_text_left_padding: ",this.settings.button_text_left_padding.toString(),"\n\tbutton_action:            ",this.settings.button_action.toString(),"\n\tbutton_disabled:          ",this.settings.button_disabled.toString(),"\n\tcustom_settings:          ",this.settings.custom_settings.toString(),"\nEvent Handlers:\n\tswfupload_loaded_handler assigned:  ",("function"===typeof this.settings.swfupload_loaded_handler).toString(),
"\n\tfile_dialog_start_handler assigned: ",("function"===typeof this.settings.file_dialog_start_handler).toString(),"\n\tfile_queued_handler assigned:       ",("function"===typeof this.settings.file_queued_handler).toString(),"\n\tfile_queue_error_handler assigned:  ",("function"===typeof this.settings.file_queue_error_handler).toString(),"\n\tupload_start_handler assigned:      ",("function"===typeof this.settings.upload_start_handler).toString(),"\n\tupload_progress_handler assigned:   ",("function"===
typeof this.settings.upload_progress_handler).toString(),"\n\tupload_error_handler assigned:      ",("function"===typeof this.settings.upload_error_handler).toString(),"\n\tupload_success_handler assigned:    ",("function"===typeof this.settings.upload_success_handler).toString(),"\n\tupload_complete_handler assigned:   ",("function"===typeof this.settings.upload_complete_handler).toString(),"\n\tdebug_handler assigned:             ",("function"===typeof this.settings.debug_handler).toString(),"\n"].join(""))};
SWFUpload.prototype.addSetting=function(a,c,d){return void 0==c?this.settings[a]=d:this.settings[a]=c};SWFUpload.prototype.getSetting=function(a){return void 0!=this.settings[a]?this.settings[a]:""};SWFUpload.prototype.callFlash=function(a,c){c=c||[];var d=this.getMovieElement(),e,f;try{f=d.CallFunction('<invoke name="'+a+'" returntype="javascript">'+__flash__argumentsToXML(c,0)+"</invoke>"),e=eval(f)}catch(g){throw"Call to "+a+" failed";}void 0!=e&&"object"===typeof e.post&&(e=this.unescapeFilePostParams(e));
return e};SWFUpload.prototype.selectFile=function(){this.callFlash("SelectFile")};SWFUpload.prototype.selectFiles=function(){this.callFlash("SelectFiles")};SWFUpload.prototype.startUpload=function(a){this.callFlash("StartUpload",[a])};SWFUpload.prototype.cancelUpload=function(a,c){!1!==c&&(c=!0);this.callFlash("CancelUpload",[a,c])};SWFUpload.prototype.stopUpload=function(){this.callFlash("StopUpload")};SWFUpload.prototype.getStats=function(){return this.callFlash("GetStats")};SWFUpload.prototype.setStats=
function(a){this.callFlash("SetStats",[a])};SWFUpload.prototype.getFile=function(a){return"number"===typeof a?this.callFlash("GetFileByIndex",[a]):this.callFlash("GetFile",[a])};SWFUpload.prototype.addFileParam=function(a,c,d){return this.callFlash("AddFileParam",[a,c,d])};SWFUpload.prototype.removeFileParam=function(a,c){this.callFlash("RemoveFileParam",[a,c])};SWFUpload.prototype.setUploadURL=function(a){this.settings.upload_url=a.toString();this.callFlash("SetUploadURL",[a])};SWFUpload.prototype.setPostParams=
function(a){this.settings.post_params=a;this.callFlash("SetPostParams",[a])};SWFUpload.prototype.addPostParam=function(a,c){this.settings.post_params[a]=c;this.callFlash("SetPostParams",[this.settings.post_params])};SWFUpload.prototype.removePostParam=function(a){delete this.settings.post_params[a];this.callFlash("SetPostParams",[this.settings.post_params])};SWFUpload.prototype.setFileTypes=function(a,c){this.settings.file_types=a;this.settings.file_types_description=c;this.callFlash("SetFileTypes",
[a,c])};SWFUpload.prototype.setFileSizeLimit=function(a){this.settings.file_size_limit=a;this.callFlash("SetFileSizeLimit",[a])};SWFUpload.prototype.setFileUploadLimit=function(a){this.settings.file_upload_limit=a;this.callFlash("SetFileUploadLimit",[a])};SWFUpload.prototype.setFileQueueLimit=function(a){this.settings.file_queue_limit=a;this.callFlash("SetFileQueueLimit",[a])};SWFUpload.prototype.setFilePostName=function(a){this.settings.file_post_name=a;this.callFlash("SetFilePostName",[a])};SWFUpload.prototype.setUseQueryString=
function(a){this.settings.use_query_string=a;this.callFlash("SetUseQueryString",[a])};SWFUpload.prototype.setRequeueOnError=function(a){this.settings.requeue_on_error=a;this.callFlash("SetRequeueOnError",[a])};SWFUpload.prototype.setHTTPSuccess=function(a){"string"===typeof a&&(a=a.replace(" ","").split(","));this.settings.http_success=a;this.callFlash("SetHTTPSuccess",[a])};SWFUpload.prototype.setAssumeSuccessTimeout=function(a){this.settings.assume_success_timeout=a;this.callFlash("SetAssumeSuccessTimeout",
[a])};SWFUpload.prototype.setDebugEnabled=function(a){this.settings.debug_enabled=a;this.callFlash("SetDebugEnabled",[a])};SWFUpload.prototype.setButtonImageURL=function(a){void 0==a&&(a="");this.settings.button_image_url=a;this.callFlash("SetButtonImageURL",[a])};SWFUpload.prototype.setButtonDimensions=function(a,c){this.settings.button_width=a;this.settings.button_height=c;var d=this.getMovieElement();void 0!=d&&(d.style.width=a+"px",d.style.height=c+"px");this.callFlash("SetButtonDimensions",[a,
c])};SWFUpload.prototype.setButtonText=function(a){this.settings.button_text=a;this.callFlash("SetButtonText",[a])};SWFUpload.prototype.setButtonTextPadding=function(a,c){this.settings.button_text_top_padding=c;this.settings.button_text_left_padding=a;this.callFlash("SetButtonTextPadding",[a,c])};SWFUpload.prototype.setButtonTextStyle=function(a){this.settings.button_text_style=a;this.callFlash("SetButtonTextStyle",[a])};SWFUpload.prototype.setButtonDisabled=function(a){this.settings.button_disabled=
a;this.callFlash("SetButtonDisabled",[a])};SWFUpload.prototype.setButtonAction=function(a){this.settings.button_action=a;this.callFlash("SetButtonAction",[a])};SWFUpload.prototype.setButtonCursor=function(a){this.settings.button_cursor=a;this.callFlash("SetButtonCursor",[a])};SWFUpload.prototype.queueEvent=function(a,c){void 0==c?c=[]:c instanceof Array||(c=[c]);var d=this;if("function"===typeof this.settings[a])this.eventQueue.push(function(){this.settings[a].apply(this,c)}),setTimeout(function(){d.executeNextEvent()},
0);else if(null!==this.settings[a])throw"Event handler "+a+" is unknown or is not a function";};SWFUpload.prototype.executeNextEvent=function(){var a=this.eventQueue?this.eventQueue.shift():null;"function"===typeof a&&a.apply(this)};SWFUpload.prototype.unescapeFilePostParams=function(a){var c=/[$]([0-9a-f]{4})/i,d={},e;if(void 0!=a){for(var f in a.post)if(a.post.hasOwnProperty(f)){e=f;for(var g;null!==(g=c.exec(e));)e=e.replace(g[0],String.fromCharCode(parseInt("0x"+g[1],16)));d[e]=a.post[f]}a.post=
d}return a};SWFUpload.prototype.testExternalInterface=function(){try{return this.callFlash("TestExternalInterface")}catch(a){return!1}};SWFUpload.prototype.flashReady=function(){var a=this.getMovieElement();a?(this.cleanUp(a),this.queueEvent("swfupload_loaded_handler")):this.debug("Flash called back ready but the flash movie can't be found.")};SWFUpload.prototype.cleanUp=function(a){try{if(this.movieElement&&"unknown"===typeof a.CallFunction){this.debug("Removing Flash functions hooks (this should only run in IE and should prevent memory leaks)");
for(var c in a)try{"function"===typeof a[c]&&"A"<=c[0]&&"Z">=c[0]&&(a[c]=null)}catch(d){}}}catch(e){}window.__flash__removeCallback=function(a,c){try{a&&(a[c]=null)}catch(d){}}};SWFUpload.prototype.fileDialogStart=function(){this.queueEvent("file_dialog_start_handler")};SWFUpload.prototype.fileQueued=function(a){a=this.unescapeFilePostParams(a);this.queueEvent("file_queued_handler",a)};SWFUpload.prototype.fileQueueError=function(a,c,d){a=this.unescapeFilePostParams(a);this.queueEvent("file_queue_error_handler",
[a,c,d])};SWFUpload.prototype.fileDialogComplete=function(a,c,d){this.queueEvent("file_dialog_complete_handler",[a,c,d])};SWFUpload.prototype.uploadStart=function(a){a=this.unescapeFilePostParams(a);this.queueEvent("return_upload_start_handler",a)};SWFUpload.prototype.returnUploadStart=function(a){var c;if("function"===typeof this.settings.upload_start_handler)a=this.unescapeFilePostParams(a),c=this.settings.upload_start_handler.call(this,a);else if(void 0!=this.settings.upload_start_handler)throw"upload_start_handler must be a function";
void 0===c&&(c=!0);this.callFlash("ReturnUploadStart",[!!c])};SWFUpload.prototype.uploadProgress=function(a,c,d){a=this.unescapeFilePostParams(a);this.queueEvent("upload_progress_handler",[a,c,d])};SWFUpload.prototype.uploadError=function(a,c,d){a=this.unescapeFilePostParams(a);this.queueEvent("upload_error_handler",[a,c,d])};SWFUpload.prototype.uploadSuccess=function(a,c,d){a=this.unescapeFilePostParams(a);this.queueEvent("upload_success_handler",[a,c,d])};SWFUpload.prototype.uploadComplete=function(a){a=
this.unescapeFilePostParams(a);this.queueEvent("upload_complete_handler",a)};SWFUpload.prototype.debug=function(a){this.queueEvent("debug_handler",a)};SWFUpload.prototype.debugMessage=function(a){if(this.settings.debug){var c=[];if("object"===typeof a&&"string"===typeof a.name&&"string"===typeof a.message){for(var d in a)a.hasOwnProperty(d)&&c.push(d+": "+a[d]);a=c.join("\n")||"";c=a.split("\n");a="EXCEPTION: "+c.join("\nEXCEPTION: ")}SWFUpload.Console.writeLine(a)}};SWFUpload.Console={};SWFUpload.Console.writeLine=
function(a){var c,d;try{c=document.getElementById("SWFUpload_Console"),c||(d=document.createElement("form"),document.getElementsByTagName("body")[0].appendChild(d),c=document.createElement("textarea"),c.id="SWFUpload_Console",c.style.fontFamily="monospace",c.setAttribute("wrap","off"),c.wrap="off",c.style.overflow="auto",c.style.width="700px",c.style.height="350px",c.style.margin="5px",d.appendChild(c)),c.value+=a+"\n",c.scrollTop=c.scrollHeight-c.clientHeight}catch(e){alert("Exception: "+e.name+
" Message: "+e.message)}}}var PACKET_HEADER_SIZE=13,OPCODE_MAP={RECV:new SNSBaseList,SEND:new SNSBaseList};function _Range(a,c){this.START=a;this.END=c;this.SIZE=c-a}function _Opcode(a,c,d){this.KEY=a;this.SEND=c;this.RECV=d?d:c;OPCODE_MAP.SEND.add(this.SEND,this.KEY);OPCODE_MAP.RECV.add(this.RECV,this.KEY)}
var OPCODE={AUTH:new _Opcode("auth",1),PING:new _Opcode("ping",2),STREAMEND:new _Opcode("streamend",4),RECEIPTS:new _Opcode("receipts",4098),USER_MESSAGE:new _Opcode("userMessage",4112),CHATGROUP_MESSAGE:new _Opcode("chatGroupMessage",4144),PUBACCOUNT_MESSAGE:new _Opcode("pubaccountMessage",4176),SYNC_MESSAGE:new _Opcode("syncMessage",4208),RECEIPTS:new _Opcode("receipts",4098),NOTIFY_MESSAGE:new _Opcode("notifyMessage",4099),INVITE_USERS:new _Opcode("inviteUsers",4865),VCARD:new _Opcode("vcard",
8209),VCARDS:new _Opcode("vcards",8209,8210),IQ_RESULT:new _Opcode("iqResult",8225),QUERY_USER:new _Opcode("queryUser",8464,8465),QUERY_CHATGROUP:new _Opcode("queryChatGroup",8496,8497),QUERY_PUBACCOUNT:new _Opcode("queryPubaccount",8528,8529),ROSTER_LIST:new _Opcode("rosterList",8736,8737),CHATGROUP_LIST:new _Opcode("chatGroupList",8752,8753),CHATGROUP_MEMBER_LIST:new _Opcode("chatGroupMemberList",8768,8769),PUBACCOUNT_LIST:new _Opcode("pubaccountList",8784,8785),CHATGROUP_INFO:new _Opcode("chatGroupInfo",
9008,9009),CHATGROUP_SHARED_FILES:new _Opcode("chatGroupSharedFiles",9010,9011),UPDATE_ROSTER:new _Opcode("updateRoster",9504),CONFIG_CHATGROUP:new _Opcode("chatGroupConfig",9520,9521),CREATE_GROUP:new _Opcode("createGroup",9522,9012),INVITE_GROUP_MEMBER:new _Opcode("inviteGroupMember",9523,9012),MODIFY_GROUP_INFO:new _Opcode("modifyGroupInfo",9524,9012),KICK_GROUP_MEMBER:new _Opcode("kickGroupMember",9525,9012),DISMISS_GROUP:new _Opcode("dismissgtoup",9528,9013),TRANSFER_GROUP:new _Opcode("transferGroup",
9529,8771),EXIT_GROUP:new _Opcode("exitGroup",9526,9013),ON_GROUP_TRANSFER:new _Opcode("groupOwnerTransfer",8771),ON_GROUP_UPDATE:new _Opcode("groupUpdate",9012),KICKED_GROUP:new _Opcode("kickedByGroup",9013),COLLECT_GROUP:new _Opcode("collectGroup",9527),FULL_SYNC_ROSTER:new _Opcode("fullSyncRoster",10016),DELTA_SYNC_ROSTER:new _Opcode("deltaSyncRoster",10018),FULL_SYNC_CHATGROUP:new _Opcode("fullSyncChatGroup",10032),DELTA_SYNC_CHATGROUP:new _Opcode("deltaSyncChatGroup",10034),PRESENCE:new _Opcode("presence",
12289),CHATGROUP:new _Opcode("chatGroup",13057,13058),DEL_GROUPMEMBER:new _Opcode("delGroupMember",9792),PACKET_ERROR:new _Opcode("packetError",16384),STREAM_ERROR:new _Opcode("streamError",16640),MESSAGE_RANGE:new _Range(4096,8192),IQ_RANGE:new _Range(8192,12288),PRESENCE_RANGE:new _Range(12288,16384)},PACKET_STRUCT={CONSOLE_FRAME:new _Range(0,1),OPCODE:new _Range(1,3),PACKET_LEN:new _Range(3,7),VERSION:new _Range(7,9),SEQ_ID:new _Range(9,13)};
function shallowClone(a){function c(){}c.prototype=a;return new c}function inheritPrototype(a,c){var d=shallowClone(c.prototype);d.constructor=a;a.prototype=d}function JumpPacket(a,c){this.sFrame=0;this.version=256;this.packetLen=this.seqId=0;this.content=a;this.opcode=c}
var YYIMChat=function(){function a(){}function c(){this._inited=!1}function d(){this.daemon=new a;this.eventHandler=new c;this.connection=this.getConnection();this.connectArg;this.waitingList=[];this.sending=!1;this.lastSendTime=0}function e(a){this.url=a.url;this.data=a.data;this.sCallback=a.successCallback;this.eCallback=a.errorCallback;a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");this.xhr=a;this.timeout=1E4;this.timeoutIndex;this.loop=!1}var f={getBareJID:function(a){var c=
k.getInstance().getUserBareJID();if(a){if(a instanceof JSJaCJID)return a.getBareJID()==c?a.toString():a.getBareJID();if("string"==typeof a)return a=new JSJaCJID(a),a.getBareJID()==c?a.toString():a.getBareJID();if(a.jid&&a.jid instanceof JSJaCJID)return a=a.jid,a.getBareJID()==c?a.toString():a.getBareJID()}throw new JSJaCJIDInvalidException("invalid jid: "+a);},getID:function(a){var c,d,e;return YYIMCommonUtil.isStringAndNotEmpty(a)?(c=k.getInstance().getAppkey(),e=a.indexOf("@"),-1!=e?(d=a.substring(0,
e),0<d.indexOf(c)?d.replace(c,""):d):0<a.indexOf(c)?a.replace(c,""):a):null},getNode:function(a){var c;return YYIMCommonUtil.isStringAndNotEmpty(a)?(c=k.getInstance().getAppkey(),-1!=a.indexOf("@")?a.substring(0,a.indexOf("@")):0<a.indexOf(c)?a:a+c):null},getResource:function(a){return YYIMCommonUtil.isStringAndNotEmpty(a)?-1!=a.indexOf("/")?a.substring(a.indexOf("/")+1):null:null},buildUserJID:function(a,c){return YYIMCommonUtil.isStringAndNotEmpty(a)?-1!=a.indexOf("@")?a:a+"@"+g+(c?"/"+c:""):null},
getDomain:function(a){return YYIMCommonUtil.isStringAndNotEmpty(a)?-1!=a.indexOf("@")?a.substring(a.indexOf("@")+1):null:null},buildChatGroupJID:function(a){return YYIMCommonUtil.isStringAndNotEmpty(a)?-1!=a.indexOf("@")?a:a+"@"+l.DOMAIN.CHATROOM:null},buildPubAccountJID:function(a){return YYIMCommonUtil.isStringAndNotEmpty(a)?-1!=a.indexOf("@")?a:a+"@"+l.DOMAIN.PUBACCOUNT:null}},g="im.yyuap.com";jQuery.support.cors=!0;var h;-1<navigator.userAgent.indexOf("Safari")&&1>navigator.userAgent.indexOf("Chrome")?
h=!1:(window.WebSocket=window.WebSocket||window.MozWebSocket,h=window.WebSocket?!0:!1);var r;r=window.localStorage?!0:!1;var l={RESOURCE:"web-v2.3",IS_ANONYMOUS:!0,MULTI_TENANCY:{ENABLE:!0,ETP_KEY:"etp",APP_KEY:"app",SEPARATOR:"."},RECEIPTSPACKET_AUTO:!0,CLEAROFFLINEMESSAGE_AUTO:!0,SENDINTERVAL:30,PACKETTYPE:{LONGCONNECT:"long connection",SHORTCONNECT:"short connection"},MULTIPARTYCALL:{ADDRESS:"http://dudu.yonyoutelecom.cn/httpIntf/createConference.do",RESTADDRESS:"https://im.yyuap.com/sysadmin/rest/user/voip/make",
ACCOUNT:"",KEY:"",PHONESMAXLENGTH:200,PARTYMAXLENGTH:12},SUPPORT:{isWebSocketSupport:h,isLocalConnectionSupport:r},CONNECTION:{TIMERVAL:2E3,WAIT:300,SECURE:!1,ALLOW_PLAIN:!0,ENABLE_WEBSOCKET:!0,ENABLE_LOCAL_CONNECTION:!0,USE_HTTPS:!1,SERVER_NAME:g,HTTP_BASE:"stellar.yyuap.com",HTTP_BIND_PORT:7075,WS_PORT:5227},PING:{INTERVAL:3E4,DURATION:3E4,TIMEOUT:3E4},SERVLET:{FILE_UPLOAD_URL:"http://im.yyuap.com/sysadmin/rest/resource/",FILE_UPLOAD_SERVLET:"http://im.yyuap.com/sysadmin/fileUpload",FILE_DOWNLOAD_SERVLET:"http://im.yyuap.com/sysadmin/download",
FILE_DELETE_SERVLET:"http://im.yyuap.com/sysadmin/cancel",AVATAR_SERVLET:"http://im.yyuap.com/sysadmin/avatar",HISTORY_MESSAGE_SERVLET:"http://im.yyuap.com/sysadmin/rest/history/",OFFLINE_MESSAGE_SERVLET:"http://im.yyuap.com/sysadmin/rest/version/",GROUP_LIST_SERVLET:"http://im.yyuap.com/sysadmin/rest/user/"},DOMAIN:{CHATROOM:"conference."+g,SEARCH:"search."+g,PUBACCOUNT:"pubaccount."+g},MESSAGE:{SEND_TIMEOUT:3E4,MAX_CHARACHER:1E3,REQUEST_RECEIPTS:!0},LOG:{ENABLE:!0,FILTER_LEVEL:3},BROWSER:function(){var a=
navigator.userAgent.toLowerCase();return{version:(a.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[])[1],safari:/webkit/.test(a),opera:/opera/.test(a),msie:/msie/.test(a)&&!/opera/.test(a),mozilla:/mozilla/.test(a)&&!/(compatible|webkit)/.test(a)}}(),getHttpBindUrl:function(){return(this.CONNECTION.USE_HTTPS?"https://":"http://")+this.CONNECTION.HTTP_BASE+":"+this.CONNECTION.HTTP_BIND_PORT+"/http-bind/"},getWebSocketUrl:function(){return(this.CONNECTION.USE_HTTPS?"wss://":"ws://")+this.CONNECTION.HTTP_BASE+
":"+this.CONNECTION.WS_PORT},useWebSocket:function(){return this.SUPPORT.isWebSocketSupport&&this.CONNECTION.ENABLE_WEBSOCKET},useLocalConnection:function(){return this.SUPPORT.isLocalConnectionSupport&&this.CONNECTION.ENABLE_LOCAL_CONNECTION},getConnectionArgObj:function(){var a={domain:this.CONNECTION.SERVER_NAME,resource:this.RESOURCE,allow_plain:this.CONNECTION.ALLOW_PLAIN,secure:this.CONNECTION.SECURE,register:!1};this.IS_ANONYMOUS&&(a.authtype="saslanon");return a}},z={CHAT:"chat",AWAY:"away",
XA:"xa",DND:"dnd",UNAVAILABLE:"unavailable"},n={MIXED:"mixed",SIMPLE:"simple",TEXT:2,FILE:4,IMAGE:8,SYSTEM:16,PUBLIC:32,AUDO:64,LOCATION:128,SHARE:256,WHITEBOARD:1024},p=function(){var a=function(){return{getVCard:function(a){var c={type:"get"};YYIMCommonUtil.isStringAndNotEmpty(a.jid)?c.to=a.jid:null;d.getInstance().send(new JumpPacket(c,OPCODE.VCARD.SEND),function(a,c){c.complete&&c.complete();var d=a.vcard||{};c.success&&c.success({email:d.email,mobile:d.mobile,nickname:d.nickname,photo:d.photo,
telephone:d.telephone,userId:f.getID(d.username)})},a)},setVCard:function(a){d.getInstance().send(new JumpPacket({type:"set",vcard:a.vcard},OPCODE.VCARD.SEND),function(a,c){c.complete&&c.complete();c.success&&c.success()},a)},getVCards:function(a){d.getInstance().send(new JumpPacket({type:"roster"},OPCODE.VCARDS.SEND),function(a,c){var d=a.vcards||[];vcards=[];for(i=d.length;i--;){var m=d[i];vcards.push({email:m.email,mobile:m.mobile,nickname:m.nickname,photo:m.photo,userId:f.getID(m.username)})}c.complete&&
c.complete();c.success&&c.success(vcards)},a)},getRostersPresence:function(a){jQuery.ajax({url:l.SERVLET.GROUP_LIST_SERVLET+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/"+k.getInstance().getUserID()+"/presence/detail?token="+k.getInstance().getToken()+"&username="+a.username,type:"get",dataType:"json",cache:!1,success:function(c){a.success&&a.success(c)},error:function(){a.error&&a.error()},complete:function(){a.complete&&a.complete()}})}}}(),c=function(){return{getRosterItems:function(a){var c=
new JumpPacket({},OPCODE.ROSTER_LIST.SEND);d.getInstance().send(c,function(a,c){if(c){c.complete&&c.complete();var d=a.items;if(0!==(d&&d.length||0)){for(var m=[],e=d.length,g={};e--;){var s=d[e],h=s.jid,s={id:f.getID(h),resource:f.getResource(h),ask:s.ask,recv:s.recv,name:s.name,photo:s.photo,subscription:s.subscription,group:s.groups};f.getDomain(h)!==l.DOMAIN.PUBACCOUNT&&(m.push(s),g[s.id]||"none"!==s.subscription||1!==s.recv||(g[s.id]=s))}for(var F in g)k.getInstance().onSubscribe({from:g[F].id,
type:"subscribe"});c.success&&c.success(JSON.stringify(m))}}},a)},deleteRosterItem:function(a){var c={type:"set",ns:NS_ROSTER,item:{jid:a.jid,subscription:"remove"}};d.getInstance().send(new JumpPacket(c,OPCODE.UPDATE_ROSTER.SEND),function(a,c){c.complete&&c.complete();c.success&&c.success(f.getID(c.jid))},a)},queryRosterItem:function(a){var c={start:YYIMCommonUtil.isNumber(a.start)?a.start:0,size:YYIMCommonUtil.isNumber(a.size)?a.size:20,fields:["Username","Name"],search:a.keyword};d.getInstance().send(new JumpPacket(c,
OPCODE.QUERY_USER.SEND),function(a,c){for(var d=a.items||[],m=[],e=d.length;e--;){var g=d[e],s=g.jid;s!==k.getInstance().getUserBareJID()&&m.push({id:f.getID(s),name:YYIMCommonUtil.isStringAndNotEmpty(g.name)?g.name:f.getID(s),photo:g.photo,email:g.email})}c.complete&&c.complete();c.success&&c.success({start:a.start,total:a.total,items:m})},a)},updateRosterItem:function(a){for(var c=a.roster,m={item:{jid:c.jid,name:YYIMCommonUtil.isStringAndNotEmpty(c.name)?c.name:f.getID(c.jid),groups:[]}},e=(c=
c.groups)?c.length:0;e--&&YYIMCommonUtil.isStringAndNotEmpty(c[e]);)m.item.groups=m.item.groups.concat(c[e]);d.getInstance().send(new JumpPacket(m,OPCODE.UPDATE_ROSTER.SEND),function(a,c){c.complete&&c.complete();c.success&&c.success()},a)}}}(),e=function(){function a(c){if(c){for(var d=c.members.length,m=[];d--;){var e=c.members[d];e.id=f.getID(e.jid);m.push(e)}return{id:f.getID(c.from),name:c.naturalLanguageName||c.name,photo:c.photo,numberOfMembers:c.numberOfMembers,superLarge:c.superLarge,collected:c.collected,
type:c.type,creationdate:c.creationdate,creater:f.getID(c.operator),members:m,owners:c.owners}}}function c(a){if(a){for(var d=a.memberItems.length,m=[];d--;){var e=a.memberItems[d];e.id=f.getID(e.jid);m.push(e)}return{id:f.getID(a.from),members:m}}}return{queryChatGroup:function(a){var c={start:YYIMCommonUtil.isNumber(a.start)?a.start:0,size:YYIMCommonUtil.isNumber(a.size)?a.size:20,search:a.keyword};d.getInstance().send(new JumpPacket(c,OPCODE.QUERY_CHATGROUP.SEND),function(a,c){for(var d=a.items||
[],m=[],e=d.length;e--;){var g=d[e],s=g.jid;m.push({id:f.getID(s),name:YYIMCommonUtil.isStringAndNotEmpty(g.name)?g.name:f.getID(s)})}c.complete&&c.complete();c.success&&c.success({start:a.start,total:a.total,items:m})},a)},configChatGroup:function(a){var c={to:a.jid,roomname:a.name,roomdesc:a.desc,persistent:1,owners:[k.getInstance().getUserBareJID()],etp:l.MULTI_TENANCY.ETP_KEY,app:l.MULTI_TENANCY.APP_KEY};YYIMCommonUtil.isStringAndNotEmpty(a.photo)&&(c.photo=a.photo);d.getInstance().send(new JumpPacket(c,
OPCODE.CONFIG_CHATGROUP.SEND),function(a,c){c.complete&&c.complete();c.success&&c.success()},a)},getChatGroups:function(c){jQuery.ajax({url:l.SERVLET.GROUP_LIST_SERVLET+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/rooms?token="+k.getInstance().getToken()+"&username="+k.getInstance().getUserID(),type:"get",dataType:"json",cache:!1,success:function(d){d=d.items;if(0!==(d&&d.length||0)){for(var m=[],e=d.length;e--;){var f=d[e];f.from=f.jid;(f=a(f))&&m.push(f)}c.success&&c.success(JSON.stringify(m))}},
error:function(){c.error&&c.error()},complete:function(){c.complete&&c.complete()}})},getChatGroupInfo:function(a){var c={to:a.jid,type:"get",ns:NS_DISCO_INFO};d.getInstance().send(new JumpPacket(c,OPCODE.CHATGROUP_INFO.SEND),function(a,c){c.complete&&c.complete();var d=a.roomname?a.roomname:f.getID(c.jid),m=a.description;c.success&&c.success({name:d,desc:m})},a)},getSharedFiles:function(a){var c={to:a.jid,start:a.start,size:a.size};d.getInstance().send(new JumpPacket(c,OPCODE.CHATGROUP_SHARED_FILES.SEND),
function(a,c){c.complete&&c.complete();var d={start:a.start,total:a.total,files:[]};files=a.files||[];for(i=files.length;i--;){var m=files[i];d.files.push({attachId:m.id,name:m.name,type:m.type,size:m.size,createTime:m.createTime,creator:f.getID(m.creator),downloads:m.downloads})}c.success&&c.success(d)},a)},createChatGroup:function(c){var m={id:c.id,naturalLanguageName:c.name,from:k.getInstance().getUserBareJID(),invitees:c.members};d.getInstance().send(new JumpPacket(m,OPCODE.CREATE_GROUP.SEND),
function(c,d){d.complete&&d.complete();d.success&&d.success(a(c))},c)},inviteGroupMember:function(c){var m={id:c.id,to:c.to,from:k.getInstance().getUserBareJID(),invitees:c.members};d.getInstance().send(new JumpPacket(m,OPCODE.INVITE_GROUP_MEMBER.SEND),function(c,d){d.complete&&d.complete();d.success&&d.success(a(c))},c)},modifyChatGroupInfo:function(c){var m={id:c.id,naturalLanguageName:c.name,from:k.getInstance().getUserBareJID(),to:c.to};d.getInstance().send(new JumpPacket(m,OPCODE.MODIFY_GROUP_INFO.SEND),
function(c,d){d.complete&&d.complete();d.success&&d.success(a(c))},c)},kickGroupMember:function(c){var m={id:c.id,member:c.member,from:k.getInstance().getUserBareJID(),to:c.to};d.getInstance().send(new JumpPacket(m,OPCODE.KICK_GROUP_MEMBER.SEND),function(c,d){d.complete&&d.complete();d.success&&d.success(a(c))},c)},exitChatGroup:function(a){var c={id:a.id,from:k.getInstance().getUserBareJID(),to:a.to};d.getInstance().send(new JumpPacket(c,OPCODE.EXIT_GROUP.SEND),function(a,c){c.complete&&c.complete();
c.success&&c.success({from:f.getID(a.from),id:a.id,to:f.getID(a.to)})},a)},handleChatGroup:a,transferChatGroupOwner:c,collectChatGroup:function(a){var c={id:a.id,from:k.getInstance().getUserBareJID(),to:a.to,type:a.type};d.getInstance().send(new JumpPacket(c,OPCODE.COLLECT_GROUP.SEND),function(a,c){c.complete&&c.complete();c.success&&c.success({from:f.getID(c.to),id:a.id,to:k.getInstance().getUserID(),type:c.type,code:a.code,message:a.message})},a)},transferChatGroup:function(a){var m={id:a.id,to:a.to,
from:k.getInstance().getUserBareJID(),newOwner:a.newOwner};d.getInstance().send(new JumpPacket(m,OPCODE.TRANSFER_GROUP.SEND),function(a,d){d.complete&&d.complete();d.success&&d.success(c(a))},a)},dismissChatGroup:function(a){var c={id:a.id,to:a.to,from:k.getInstance().getUserBareJID()};d.getInstance().send(new JumpPacket(c,OPCODE.DISMISS_GROUP.SEND),function(a,c){c.complete&&c.complete();c.success&&c.success({id:a.id,from:f.getID(a.from),to:f.getID(a.to)})},a)}}}(),g=function(){return{getGroupMembers:function(a){d.getInstance().send(new JumpPacket({type:"get",
ns:NS_DISCO_ITEMS,to:a.jid},OPCODE.CHATGROUP_MEMBER_LIST.SEND),function(a,c){if(c){c.complete&&c.complete();var d=a.items;if(0!==(d&&d.length||0)){for(var m=[],e=-1,g=d.length;++e<g;){var s=d[e];m.push({id:f.getID(s.jid),name:s.name,photo:s.photo,affiliation:s.affiliation})}c.success&&c.success(JSON.stringify(m))}}},a)}}}(),h=function(){return{getPubAccountItems:function(a){var c=new JumpPacket({type:"get",ns:NS_PUBACCOUNT,to:l.DOMAIN.PUBACCOUNT},OPCODE.PUBACCOUNT_LIST.SEND);d.getInstance().send(c,
function(a,c){if(c){c.complete&&c.complete();var d=a.items;if(0!==(d&&d.length||0)){for(var m=[],e=d.length;e--;){var g=d[e],s=g.jid,g={id:f.getID(s),name:YYIMCommonUtil.isStringAndNotEmpty(g.name)?g.name:f.getID(s),type:g.type};m.push(g)}c.success&&c.success(JSON.stringify(m))}}},a)},queryPubaccount:function(a){var c={start:YYIMCommonUtil.isNumber(a.start)?a.start:0,size:YYIMCommonUtil.isNumber(a.size)?a.size:20,fields:["Accountname","Name"],search:a.keyword};d.getInstance().send(new JumpPacket(c,
OPCODE.QUERY_PUBACCOUNT.SEND),function(a,c){for(var d=a.items||[],m=[],e=d.length;e--;){var g=d[e],s=g.jid;m.push({id:f.getID(s),name:YYIMCommonUtil.isStringAndNotEmpty(g.name)?g.name:f.getID(s),type:g.type})}c.complete&&c.complete();c.success&&c.success({start:a.start,total:a.total,items:m})},a)}}}(),n=function(){return{fullSyncRoster:function(a){d.getInstance().send(new JumpPacket({submits:a},OPCODE.FULL_SYNC_ROSTER.SEND))},deltaSyncRoster:function(a,c){var m={};0<a.length&&(m.removes=a);0<c.length&&
(m.sets=c);(0<a.length||0<c.length)&&d.getInstance().send(new JumpPacket(m,OPCODE.DELTA_SYNC_ROSTER.SEND))},fullSyncChatGroup:function(a){d.getInstance().send(new JumpPacket({submits:a},OPCODE.FULL_SYNC_CHATGROUP.SEND))},deltaSyncChatGroup:function(a,c){var m={};0<a.length&&(m.removes=a);0<c.length&&(m.sets=c);(0<a.length||0<c.length)&&d.getInstance().send(new JumpPacket(m,OPCODE.DELTA_SYNC_CHATGROUP.SEND))}}}();return{monitor:function(){var a=d.getInstance();a.registerHandler(OPCODE.UPDATE_ROSTER.KEY,
function(a){var c=a.item;a=f.getID(a.item.jid);"both"===c.subscription?(D.log("update or add: "+JSON.stringify(c)),k.getInstance().onRosterUpdateded({id:a,name:c.name,groups:c.groups})):"none"===c.subscription&&(D.log("delete: "+JSON.stringify(c)),k.getInstance().onRosterDeleted(a))});a.registerHandler(OPCODE.ON_GROUP_UPDATE.KEY,function(a){if(a=e.handleChatGroup(a))k.getInstance().onGroupUpdate(a)});a.registerHandler(OPCODE.ON_GROUP_TRANSFER.KEY,function(a){if(a=e.transferChatGroupOwner(a))k.getInstance().onTransferGroupOwner(a)});
a.registerHandler(OPCODE.KICKED_GROUP.KEY,function(a){a={id:a.id,from:f.getID(a.from),to:f.getID(a.to)};k.getInstance().onKickedOutGroup(a)});a.registerHandler(OPCODE.PUBACCOUNT_LIST.KEY,function(a){a=a.items;if(0!==(a&&a.length||0)){for(var c=[],d=a.length;d--;){var m=a[d],e=m.jid,m={id:f.getID(e),name:YYIMCommonUtil.isStringAndNotEmpty(m.name)?m.name:f.getID(e),type:m.type};c.push(m)}k.getInstance().onPubaccountUpdate(c)}})},getVCard:a.getVCard,setVCard:a.setVCard,getVCards:a.getVCards,getRostersPresence:a.getRostersPresence,
getRosterItems:c.getRosterItems,deleteRosterItem:c.deleteRosterItem,queryRosterItem:c.queryRosterItem,updateRosterItem:c.updateRosterItem,queryChatGroup:e.queryChatGroup,configChatGroup:e.configChatGroup,getChatGroups:e.getChatGroups,getChatGroupInfo:e.getChatGroupInfo,getSharedFiles:e.getSharedFiles,createChatGroup:e.createChatGroup,inviteGroupMember:e.inviteGroupMember,modifyChatGroupInfo:e.modifyChatGroupInfo,kickGroupMember:e.kickGroupMember,exitChatGroup:e.exitChatGroup,collectChatGroup:e.collectChatGroup,
transferChatGroup:e.transferChatGroup,dismissChatGroup:e.dismissChatGroup,getGroupMembers:g.getGroupMembers,getPubAccountItems:h.getPubAccountItems,queryPubaccount:h.queryPubaccount,fullSyncRoster:n.fullSyncRoster,deltaSyncRoster:n.deltaSyncRoster,fullSyncChatGroup:n.fullSyncChatGroup,deltaSyncChatGroup:n.deltaSyncChatGroup}}(),y=function(){function a(d,m){if(!0!==q.get(d.id)&&(q.add(d.id,!0),d.from!==k.getInstance().getUserFullJID())){var e;try{e=JSON.parse(d.content)}catch(g){e=d.content}var h=
{content:e.content,contentType:d.contentType,dateline:d.dateline,extend:e.extend},t="groupchat"!=m?f.getID(d.from):{room:f.getID(d.from),roster:f.getID(f.getResource(d.from))},t={id:d.id,type:m,from:t,data:h};"chat"==m?(t.resource=f.getResource(d.from),t.to=f.getID(d.receiver||d.to)):t.to=k.getInstance().getUserID();!0===d.receipts&&(h.receiptsbody={type:l.PACKETTYPE.LONGCONNECT,receipts:d.receipts,arg:{to:d.from,id:d.id}},!0===l.RECEIPTSPACKET_AUTO&&c(h.receiptsbody.arg));if(h.contentType)switch(h.contentType){case n.TEXT:e.style&&
(t.data.style=e.style);try{k.getInstance().onTextMessage(t)}catch(p){YYIMChat.log("textMessHandleError:",0,t)}break;case n.IMAGE:t.data&&t.data.content&&t.data.content.path&&(t.data.content.path=YYIMChat.getFileUrl(t.data.content.path));try{k.getInstance().onPictureMessage(t)}catch(r){YYIMChat.log("imageMessHandleError:",0,t)}break;case n.FILE:t.data&&t.data.content&&t.data.content.path&&(t.data.content.path=YYIMChat.getFileUrl(t.data.content.path));try{k.getInstance().onFileMessage(t)}catch(G){YYIMChat.log("fileMessHandleError:",
0,t)}break;case n.SHARE:try{k.getInstance().onShareMessage(t)}catch(u){YYIMChat.log("shareMessHandleError:",0,t)}break;case n.SYSTEM:t.data.content=e;t.data&&t.data.content&&t.data.content.path&&(t.data.content.path=YYIMChat.getFileUrl(t.data.content.path));try{k.getInstance().onSystemMessage(t)}catch(v){YYIMChat.log("systemMessHandleError:",0,t)}break;case n.PUBLIC:!e.content&&e.length&&(t.data.content=e);try{k.getInstance().onPublicMessage(t)}catch(w){YYIMChat.log("publicMessHandleError:",0,t)}break;
case n.AUDO:t.data&&t.data.content&&t.data.content.path&&(t.data.content.path=YYIMChat.getFileUrl(t.data.content.path));try{k.getInstance().onAudoMessage(t)}catch(x){YYIMChat.log("AudoMessHandleError:",0,t)}break;case n.LOCATION:t.data&&t.data.content&&t.data.content.path&&(t.data.content.path=YYIMChat.getFileUrl(t.data.content.path));try{k.getInstance().onLocationMessage(t)}catch(y){YYIMChat.log("LocationMessHandleError:",0,t)}break;case n.WHITEBOARD:try{k.getInstance().onWhiteBoardMessage(t)}catch(z){YYIMChat.log("WhiteBoardMessHandleError:",
0,t)}break;default:YYIMChat.log("unhandlePacketError:",0,t)}}}function c(a){a=new JumpPacket({from:k.getInstance().getUserFullJID(),to:a.to,dateline:(new Date).getTime(),id:a.id},OPCODE.RECEIPTS.SEND);d.getInstance().send(a)}function e(a,c){if(l.CLEAROFFLINEMESSAGE_AUTO){var d=l.SERVLET.OFFLINE_MESSAGE_SERVLET+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/"+c.id+"/ack?oldversion="+c.version+"&version="+a.version+"&resource="+l.RESOURCE+"&token="+k.getInstance().getToken();jQuery.ajax({url:d,
dataType:"json",type:"put",cache:!1,statusCode:{200:function(){YYIMCookieUtil.setcookie("offline_version_"+c.id,a.version,1440,"/")}}})}}function g(a){a.start||(a.start=0);a.size||(a.size=100);a.version||(a.version=-1);jQuery.ajax({url:l.SERVLET.OFFLINE_MESSAGE_SERVLET+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/"+a.id+"?version="+a.version+"&start="+a.start+"&size="+a.size+"&resource="+l.RESOURCE+"&token="+k.getInstance().getToken(),dataType:"json",cache:!1,success:function(c){if(c.packets&&
c.packets.length){for(var d in c.packets){for(var m=c.packets[d],e=b64decode(m.opcode),f="0x",s=0;s<e.length;s++)var k=e[s].charCodeAt().toString(16),f=f+(1==k.length?"0"+k:k);m=JSON.parse(m.body);m.opcode=f;p.unshift(m)}p.sort(YYIMCookieUtil.createComparisonFunction("dateline"));c.packets.length>=c.size?(a.start+=a.size,g(a)):h(c,a)}else c.packets&&c.packets.length||h(c,a)},error:function(a){k.getInstance().log("getOfflineMessage_error:",0,a.statusText)}})}function h(c,d){if(p.length){for(var g in p)switch(p[g].opcode){case "0x"+
OPCODE.PRESENCE.SEND.toString(16):k.getInstance().onSubscribe({from:f.getID(p[g].from),type:p[g].type});break;case "0x"+OPCODE.USER_MESSAGE.SEND.toString(16):case "0x"+OPCODE.CHATGROUP_MESSAGE.SEND.toString(16):a(p[g],p[g].type);break;case "0x"+OPCODE.PUBACCOUNT_MESSAGE.SEND.toString(16):a(p[g],"chat");break;default:k.getInstance().log("unHandle_Packet:",3,p[g])}d.version=c.version-p.length;p=[];e(c,d)}}var q=new SNSBaseList,p=[];return{monitor:function(){var c=d.getInstance();c.registerHandler(OPCODE.USER_MESSAGE.KEY,
function(c){a(c,c.type)});c.registerHandler(OPCODE.CHATGROUP_MESSAGE.KEY,function(c){a(c,c.type)});c.registerHandler(OPCODE.PUBACCOUNT_MESSAGE.KEY,function(c){a(c,c.type)});c.registerHandler(OPCODE.RECEIPTS.KEY,function(a){a.from=f.getID(a.from);a.to=f.getID(a.to);k.getInstance().onReceipts(a)});c.registerHandler(OPCODE.SYNC_MESSAGE.KEY,function(c){a(c,c.type)})},sendMessage:function(a){var c,m=a.body||{},m={id:a.id,type:a.type,contentType:m.contentType||n.TEXT,dateline:m.dateline,content:{extend:m.extend,
content:m.content}},e=OPCODE.USER_MESSAGE.SEND;"chat"==a.type?(m.receipts="1",c=a.resource?"anonymous"==a.resource.toLowerCase()?f.buildUserJID(f.getID(a.to),a.resource.toUpperCase()):a.to==YYIMChat.getUserID()?f.buildUserJID(f.getNode(a.to),a.resource):f.buildUserJID(f.getNode(a.to)):f.buildUserJID(f.getNode(a.to))):"groupchat"==a.type?(c=f.buildChatGroupJID(f.getNode(a.to)),e=OPCODE.CHATGROUP_MESSAGE.SEND):"pubaccount"==a.type&&(c=f.buildPubAccountJID(f.getNode(a.to)),e=OPCODE.PUBACCOUNT_MESSAGE.SEND);
m.to=c;a.style&&(m.content.style=a.style);c=new JumpPacket(m,e);d.getInstance().send(c,function(a){k.getInstance().onReceipts(a)});a.success&&a.success(a)},addGroupMember:function(a,c){d.getInstance().send(new JumpPacket({to:a,invites:c},OPCODE.INVITE_USERS.SEND))},getHistoryMessage:function(a){var c=l.SERVLET.HISTORY_MESSAGE_SERVLET+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/"+YYIMChat.getUserID()+"?token="+k.getInstance().getToken()+"&start="+a.start+"&size="+a.num+"&peer=";if("pubaccount"==
a.chatType)c=l.SERVLET.HISTORY_MESSAGE_SERVLET+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/pubaccount/"+a.id+"?token="+k.getInstance().getToken()+"&start="+a.start+"&size="+a.num,a.contentType&&(c+="&contentType="+a.contentType);else if("groupchat"==a.chatType)c=l.SERVLET.HISTORY_MESSAGE_SERVLET+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/historymuc/"+a.id+"?token="+k.getInstance().getToken()+"&start="+a.start+"&size="+a.num;else if("chat"==a.chatType&&(c=a.resource&&"anonymous"==
a.resource?c+a.id:c+f.getNode(a.id),a.contentType))for(var d in n)if(a.contentType==n[d]){c+="&contentType="+a.contentType;break}k.getInstance().log("\u5386\u53f2\u8bb0\u5f55\uff1arequest URL",2,c);jQuery.ajax({url:c,dataType:"json",cache:!1,success:function(c){YYIMChat.log("\u5386\u53f2\u8bb0\u5f55\uff1adata",2,c);for(var d=[],m=0;m<c.result.length;m++){var e={fromId:f.getID(c.result[m].sender||c.result[m].pubaccount),toId:f.getID(c.result[m].receiver||k.getInstance().getUserID()),msgId:c.result[m].packetId||
c.result[m].messageID,contentType:c.result[m].contentType,dateline:c.result[m].dateline||c.result[m].ts,packetId:c.result[m].packetId||c.result[m].messageID,type:a.chatType};a.chatType&&"groupchat"==a.chatType&&(e.messageID=c.result[m].packetId||c.result[m].messageID,e.fromId=f.getID(c.result[m].mucId),e.fromRoster=f.getID(c.result[m].sender));if(c.result[m].content){var g=e,s;if(s=c.result[m].content){s=JSON.parse(s);try{isNaN(Number(s.content))&&(s.content=JSON.parse(s.content),s.content.style&&
(s.style=s.content.style,delete s.content.style),s.content.content&&(s.content=s.content.content))}catch(h){}}else s=null;g.body=s;e.body.contentType=c.result[m].contentType;e.body.dateline=c.result[m].dateline||c.result[m].ts;e.body.content&&e.body.contentType&&(e.body.contentType==n.IMAGE||e.body.contentType==n.FILE)&&(e.body.content.path=e.body.content.path?YYIMChat.getFileUrl(e.body.content.path):null);d.push(e)}}YYIMCommonUtil.isFunction(a.success)&&a.success({count:Number(c.count),result:d})},
error:function(c){a.error&&a.error();k.getInstance().log("getHistoryMessage_error:",0,c.statusText)},complete:function(){a.complete&&a.complete()}})},getOfflineMessage:g,sendReceiptsPacket:c,sendReadedReceiptsPacket:function(a){a=new JumpPacket({from:k.getInstance().getUserFullJID(),to:a.to,dateline:(new Date).getTime(),id:a.id,state:2},OPCODE.RECEIPTS.SEND);d.getInstance().send(a)}}}(),w=function(){return{monitor:function(){var a=d.getInstance();a.registerHandler(OPCODE.PRESENCE.KEY,function(a){if(a.type&&
"unavailable"!=a.type)k.getInstance().onSubscribe({from:f.getID(a.from),type:a.type});else{var c={from:f.getID(a.from),resource:f.getResource(a.from),type:a.type,show:a.show,status:a.status};A.getInstance().addToOnline(c.from);a.type&&"unavailable"==a.type&&(c.show=z.UNAVAILABLE,c.status=z.UNAVAILABLE,A.getInstance().removeFromOnline(c.from));YYIMCommonUtil.isStringAndNotEmpty(c.status)||(c.show=z.CHAT,c.status=z.CHAT);k.getInstance().onPresence(c)}});a.registerHandler(OPCODE.CHATGROUP.KEY,function(a){if("unavailable"==
a.type)k.getInstance().onRoomMemerPresence({room:f.getID(a.from),member:{id:f.getID(a.jid)},type:"quit"});else k.getInstance().onRoomMemerPresence({room:f.getID(a.from),member:{id:f.getID(a.jid),nick:a.name?a.name:f.getID(a.jid),affiliation:a.affiliation,role:a.role},type:"join"})})},addRosterItem:function(a){d.getInstance().send(new JumpPacket({type:"subscribe",to:a},OPCODE.PRESENCE.SEND))},approveSubscribe:function(a){d.getInstance().send(new JumpPacket({type:"subscribed",to:a},OPCODE.PRESENCE.SEND))},
rejectSubscribe:function(a){d.getInstance().send(new JumpPacket({type:"unsubscribed",to:a},OPCODE.PRESENCE.SEND))},setPresence:function(a){var c={};YYIMCommonUtil.isStringAndNotEmpty(a.show)&&(c.show=a.show);YYIMCommonUtil.isStringAndNotEmpty(a.status)&&(c.status=a.status);YYIMCommonUtil.isStringAndNotEmpty(a.priority)&&(c.priority=a.priority);YYIMCommonUtil.isStringAndNotEmpty(a.type)&&(c.type=a.type);d.getInstance().send(new JumpPacket(c,OPCODE.PRESENCE.SEND))},addPubAccount:function(a){d.getInstance().send(new JumpPacket({type:"subscribe",
to:a.jid},OPCODE.PRESENCE.SEND),function(a,c){c.complete&&c.complete();a.from=f.getID(a.from);a.to=f.getID(a.to);c.success&&c.success(a)},a)},removePubAccount:function(a){d.getInstance().send(new JumpPacket({id:a.id,type:"unsubscribe",to:a.to},OPCODE.PRESENCE.SEND),function(a,c){c.complete&&c.complete();a.from=f.getID(a.from);a.to=f.getID(a.to)||k.getInstance().getUserID();c.success&&c.success(a)},a)},joinChatGroup:function(a){var c={to:a.jid+"/"+k.getInstance().getUserNode()};d.getInstance().send(new JumpPacket(c,
OPCODE.CHATGROUP.SEND),function(c,d){a.complete&&a.complete();a.success&&a.success({id:f.getID(c.from),affiliation:c.affiliation,role:c.role})},a)},delGroupMember:function(a,c,e){var f=parseInt(1E5+1E5*Math.random());0<c.indexOf("@")&&(c=c.split("@")[0]);d.getInstance().send(new JumpPacket({id:f,to:a,member:c,role:"none"},OPCODE.DEL_GROUPMEMBER.SEND),function(a){e&&e(a)})},quitChatGroup:function(a){d.getInstance().send(new JumpPacket({type:"unavailable",to:a+"/"+k.getInstance().getUserNode()},OPCODE.CHATGROUP.SEND),
function(){})}}}();a.prototype.startPing=function(){d.getInstance().connected()&&(this.pingInterval=setInterval(this.ping.bind(this),l.PING.INTERVAL))};a.prototype.stopPing=function(){clearTimeout(this.pingTimeout);clearInterval(this.pingInterval)};a.prototype.ping=function(){if(!((new Date).getTime()-this.lastPongTime<l.PING.DURATION)){var a=new JumpPacket(null,OPCODE.PING.SEND);try{d.getInstance().send(a),this.pingTimeout=setTimeout(this.timeoutHandler.bind(this),l.PING.TIMEOUT)}catch(c){D.log("SNSConnectService.ping",
0,c),this.stopPing(),k.getInstance().onConnectError({errorCode:408,message:"\u8fde\u63a5\u5931\u8d25"})}}};a.prototype.pong=function(){this.lastPongTime=(new Date).getTime();clearTimeout(this.pingTimeout)};a.prototype.timeoutHandler=function(){this.stopPing();k.getInstance().onConnectError({errorCode:408,message:"\u8fde\u63a5\u5931\u8d25"})};c.prototype._init=function(){D.log("YYIMConnectEventHandler.prototype.registerHandler",3);if(!this._inited){var a=d.getInstance();a.registerHandler("onConnect",
this.onConnected);a.registerHandler("onDisconnect",this.onDisConnect);a.registerHandler("onStatusChanged",this.connectStatusChangeHandler);a.registerHandler(OPCODE.STREAM_ERROR.KEY,this.onStreamError);a.registerHandler(OPCODE.PACKET_ERROR.KEY,this.onPacketError);this._inited=!0}};c.prototype.onConnected=function(){k.getInstance().onOpened();d.getInstance().getDaemon().startPing()};c.prototype.onConnectError=function(a){D.log("YYIMConnectEventHandler.prototype.onConnectError ",0,a);errorCode=a.getAttribute("code");
d.getInstance().getDaemon().stopPing();if(401==errorCode||401==errorCode/10)k.getInstance().onAuthError({errorCode:401,message:"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef"});else k.getInstance().onConnectError({errorCode:errorCode,message:"\u8fde\u63a5\u5931\u8d25"})};c.prototype.onStreamError=function(a){D.log("YYIMConnectEventHandler.prototype.onPacketError ",0,a);d.getInstance().getDaemon().stopPing();if(401==a.code||401==a.code/10)k.getInstance().onAuthError({errorCode:401,message:"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef"});
else k.getInstance().onConnectError({errorCode:a.code,message:a.message})};c.prototype.onPacketError=function(a){D.log("YYIMConnectEventHandler.prototype.onPacketError ",0,a)};c.prototype.onDisConnect=function(){k.getInstance().onClosed();d.getInstance().getDaemon().stopPing()};c.prototype.connectStatusChangeHandler=function(a){D.log("connectStatusChangeHandler",3,a);k.getInstance().onStatusChanged(a)};d.getInstance=function(){d._instance||(d._instance=new d,d._instance._init());return d._instance};
d.prototype.getDaemon=function(){return this.daemon};d.prototype._init=function(){w.monitor();y.monitor();p.monitor();this.eventHandler._init();this.registerHandler(OPCODE.AUTH.KEY,function(a){var c=new JSJaCJID(a.jid);a=f.getID(a.jid);k.getInstance()._user={jid:c,name:a};k.getInstance().onUserBind(a,c.getResource())});this.registerHandler(OPCODE.PING.KEY,this.getDaemon().pong.bind(this.getDaemon()))};d.prototype.registerHandler=function(a,c,d,e){if(this.connection)this.connection.registerHandler.apply(this.connection,
arguments);else throw"connection is undefined!";};d.prototype.connected=function(){return this.connection&&this.connection.connected()?!0:!1};d.prototype.getConnection=function(){this.connection||(l.useWebSocket()?this.connection=new JSJaCWebSocketConnection({httpbase:l.getWebSocketUrl()}):this.connection=new JSJaCHttpBindingConnection({httpbase:l.getHttpBindUrl(),timerval:l.CONNECTION.TIMERVAL,wait:l.CONNECTION.WAIT}));return this.connection};d.prototype.connect=function(a,c,d){this.connectArg||
(this.connectArg=l.getConnectionArgObj());a&&(this.connectArg.username=a,this.connectArg.password=c);k.getInstance()._user={jid:new JSJaCJID(this.connectArg.username+"@"+g+"/"+this.connectArg.resource),name:this.connectArg.username};this.connection.connect(this.connectArg)};d.prototype.disconnect=function(){this.daemon.stopPing();this.connection&&this.connection.disconnect()};d.prototype.send=function(a,c,d,e){this.waitingList.push({packet:a,callback:c,data:d,callbackContext:e});this.sending||this.sendInterval()};
d.prototype.sendInterval=function(){var a=this;if(this.waitingList.length){this.sending=!0;var c=this.waitingList[0],d=(new Date).getTime()-this.lastSendTime;d>=l.SENDINTERVAL?(this.sendJumpPacket(c),this.waitingList.shift(),this.lastSendTime=(new Date).getTime(),this.sendInterval()):setTimeout(function(){a.sendJumpPacket(c);a.waitingList.shift();a.lastSendTime=(new Date).getTime();a.sendInterval()},l.SENDINTERVAL-d)}else this.sending=!1};d.prototype.sendJumpPacket=function(a){return a.callbackContext?
this.connection.sendJumpPacket(a.packet,a.callback.bind(a.callbackContext),a.data):this.connection.sendJumpPacket(a.packet,a.callback,a.data)};e.prototype.get=function(){var a=this.xhr;a.open("GET",this.url,!0);e.prototype._listenFn.call(this);a.send()};e.prototype.post=function(){var a=this.xhr;a.open("POST",this.url,!0);e.prototype._listenFn.call(this);a.setRequestHeader("Content-Type","x-www-form-urlencoded");a.send(this.data)};e.prototype.isLoop=function(a){this.loop=a};e.prototype.stopLoop=function(){clearTimeout(_self.timeoutIndex)};
e.prototype._listenFn=function(){var a=this,c=this.xhr;this.timeoutIndex=setTimeout(function(){a.loop&&e.prototype.get.call(a);a.eCallback(c.responseText)},a.timeout);c.onreadystatechange=function(){4==c.readyState&&(clearTimeout(a.timeoutIndex),200==c.status?a.sCallback(c.responseText):a.eCallback(c.responseText))}};var x=function(){return{multiPartyCall:function(a){if(!0===a.accountMmanaged){var c={etpId:l.MULTI_TENANCY.ETP_KEY,appId:l.MULTI_TENANCY.APP_KEY,caller:a.caller,phones:a.phones,username:k.getInstance().getUserNode()};
jQuery.ajax({url:l.MULTIPARTYCALL.RESTADDRESS+"?token="+k.getInstance().getToken(),type:"post",data:JSON.stringify(c),dataType:"json",cache:!1,processData:!1,contentType:"application/json",headers:{},success:function(c){a.success&&a.success(c)},error:function(c){a.error&&a.error()}})}else c=(new Date).getTime(),c={caller:a.caller,phones:a.phones,account_identify:a.account,userId:k.getInstance().getUserBareJID(),timestamp:c,sign:hex_sha1(a.account+a.key+c)},jQuery.ajax({url:l.MULTIPARTYCALL.ADDRESS,
type:"get",data:c,dataType:"jsonp",cache:!1,jsonp:"callback",success:function(c){a.success&&a.success(c)},error:function(c){a.error&&a.error()}})}}}(),u=function(){this._provider};u.getInstance=function(){u._instance||(u._instance=new u);return u._instance};u.prototype.init=function(a){this._provider=a&&a.provider?a.provider:new B};u.prototype.getProvider=function(){this._provider||(this._provider=new B);return this._provider};u.prototype.getChatGroups=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().getChatGroups)&&
this.getProvider().getChatGroups(a)};u.prototype.addChatGroup=function(a){w.joinChatGroup({jid:f.buildChatGroupJID(f.getNode(a.node)),success:function(){p.configChatGroup({jid:this.jid,name:a.name,desc:a.desc,error:a.error,success:function(){a.success&&a.success({name:a.name,node:a.node,id:a.id,nickname:k.getInstance().getUserID()})},complete:a.complete})},error:function(){a.error&&a.error()}});this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().addChatGroup)&&this.getProvider().addChatGroup(a)};
u.prototype.createChatGroup=function(a){p.createChatGroup({id:Math.uuid(),name:a.name,members:a.members,success:function(c){a.success&&a.success(c)},complete:function(){a.complete&&a.complete()}})};u.prototype.transferChatGroup=function(a){p.transferChatGroup({id:Math.uuid(),to:a.to,newOwner:a.newOwner,success:function(c){a.success&&a.success(c)},complete:function(){a.complete&&a.complete()}})};u.prototype.dismissChatGroup=function(a){p.dismissChatGroup({id:Math.uuid(),to:a.to,success:function(c){a.success&&
a.success(c)},complete:function(){a.complete&&a.complete()}})};u.prototype.inviteGroupMember=function(a){p.inviteGroupMember({id:Math.uuid(),to:a.to,members:a.members,success:function(c){a.success&&a.success(c)},complete:function(){a.complete&&a.complete()}})};u.prototype.modifyChatGroupInfo=function(a){p.modifyChatGroupInfo({id:Math.uuid(),to:a.to,name:a.name,success:function(c){a.success&&a.success(c)},complete:function(){a.complete&&a.complete()}})};u.prototype.kickGroupMember=function(a){p.kickGroupMember({id:Math.uuid(),
to:a.to,member:a.member,success:function(c){a.success&&a.success(c)},complete:function(){a.complete&&a.complete()}})};u.prototype.exitChatGroup=function(a){p.exitChatGroup({id:Math.uuid(),to:a.to,success:function(c){a.success&&a.success(c)},complete:function(){a.complete&&a.complete()}})};u.prototype.collectChatGroup=function(a){p.collectChatGroup({id:Math.uuid(),to:a.to,type:a.type,success:function(c){a.success&&a.success(c)},complete:function(){a.complete&&a.complete()}})};u.prototype.delGroupMember=
function(a,c,d){w.delGroupMember(a,c,d)};u.prototype.quitChatGroup=function(a){w.quitChatGroup(a);this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().quitChatGroup)&&this.getProvider().quitChatGroup(a)};u.prototype.queryChatGroup=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().queryChatGroup)&&this.getProvider().queryChatGroup(a)};u.prototype.joinChatGroup=function(a){w.joinChatGroup(a)};u.prototype.updateChatGroup=function(a){p.configChatGroup(a)};var B=
function(){};B.prototype.getChatGroups=function(a){p.getChatGroups(a)};B.prototype.addChatGroup=function(a){};B.prototype.quitChatGroup=function(a){};B.prototype.queryChatGroup=function(a){p.queryChatGroup(a)};var q=function(){this._provider};q.getInstance=function(){q._instance||(q._instance=new q);return q._instance};q.prototype.init=function(a){this._provider=a&&a.provider?a.provider:new C};q.prototype.getProvider=function(){this._provider||(this._provider=new C);return this._provider};q.prototype.getGroupMembers=
function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().getGroupMembers)&&this.getProvider().getGroupMembers(a)};q.prototype.addGroupMember=function(a,c){y.addGroupMember(a,c);this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().addGroupMember)&&this.getProvider().addGroupMember(a,c)};var C=function(){};C.prototype.getGroupMembers=function(a){p.getGroupMembers(a)};C.prototype.addGroupMember=function(a,c){};var A=function(){this._provider;this._onlineList=new SNSBaseList};
A.getInstance=function(){A._instance||(A._instance=new A);return A._instance};A.prototype.addToOnline=function(a){this._onlineList.add(a,!0)};A.prototype.removeFromOnline=function(a){this._onlineList.remove(a)};A.prototype.init=function(a){this._provider=a&&a.provider?a.provider:new E};A.prototype.getProvider=function(){this._provider||(this._provider=new E);return this._provider};A.prototype.getRosterItems=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().getRosterItems)&&
this.getProvider().getRosterItems(a)};A.prototype.addRosterItem=function(a){w.addRosterItem(a);this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().addRosterItem)&&this.getProvider().addRosterItem(a)};A.prototype.deleteRosterItem=function(a){p.deleteRosterItem(a);this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().deleteRosterItem)&&this.getProvider().deleteRosterItem(a)};A.prototype.queryRosterItem=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().queryRosterItem)&&
this.getProvider().queryRosterItem(a)};A.prototype.getRostersPresence=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().getRostersPresence)&&this.getProvider().getRostersPresence(a)};var E=function(){};E.prototype.getRosterItems=function(a){p.getRosterItems(a)};E.prototype.addRosterItem=function(a){};E.prototype.deleteRosterItem=function(a){};E.prototype.queryRosterItem=function(a){p.queryRosterItem(a)};E.prototype.getRostersPresence=function(a){p.getRostersPresence(a)};
var v=function(){},D=new function(a){this.level=a?a:0==a?0:3;this.start=function(){};this.log=function(a,c,d,e){if(l.LOG.ENABLE&&(c=c?c:0==c?0:3,!(c>this.level)&&"undefined"!=typeof console&&"undefined"!=typeof console.group))try{console.group(a);switch(c){case 0:console.error(a);console.trace();break;case 1:console.warn(a);console.trace();break;case 2:console.info(a);break;case 4:console.debug(a);break;default:console.log(a)}var m=arguments.length;if(2<m)for(var f=2;f<m;f++){var g=arguments[f];g&&
(g instanceof JSJaCPacket?console.info(g.doc.xml):console.debug(g))}console.groupEnd()}catch(h){try{console.error(h)}catch(k){}}};this.logParam=function(a){this.log("arguments:",a||3,this.logParam.caller.arguments)};this.setLevel=function(a){this.level=a;return this};this.getLevel=function(){return this.level}}(l.LOG.FILTER_LEVEL),k=function(){this._user;this.init();this._token={};this._anonymousUser=!1;this.appkey;this.version="2.0"};k.getInstance=function(){k._instance||(k._instance=new k);return k._instance};
k.prototype.log=function(a,c,d,e){D.log(a,c,d,e)};k.prototype.init=function(a){a=a||{};this.onOpened=a.onOpened||v;this.onClosed=a.onClosed||v;this.onAuthError=a.onAuthError||v;this.onStatusChanged=a.onStatusChanged||v;this.onConnectError=a.onConnectError||v;this.onUserBind=a.onUserBind||v;this.onPresence=a.onPresence||v;this.onSubscribe=a.onSubscribe||v;this.onRosterDeleted=a.onRosterDeleted||v;this.onRosterUpdateded=a.onRosterUpdateded||v;this.onGroupUpdate=a.onGroupUpdate||v;this.onTransferGroupOwner=
a.onTransferGroupOwner||v;this.onKickedOutGroup=a.onKickedOutGroup||v;this.onPubaccountUpdate=a.onPubaccountUpdate||v;this.onRoomMemerPresence=a.onRoomMemerPresence||v;this.onMessage=a.onMessage||v;this.onReceipts=a.onReceipts||v;this.onTextMessage=a.onTextMessage||v;this.onPictureMessage=a.onPictureMessage||v;this.onFileMessage=a.onFileMessage||v;this.onShareMessage=a.onShareMessage||v;this.onSystemMessage=a.onSystemMessage||v;this.onPublicMessage=a.onPublicMessage||v;this.onDeviceMessage=a.onDeviceMessage||
v;this.onAudoMessage=a.onAudoMessage||v;this.onLocationMessage=a.onLocationMessage||v;this.onWhiteBoardMessage=a.onWhiteBoardMessage||v;this.onMessageOut=a.onMessageout||v};k.prototype.initUpload=function(){if(arguments&&SNSIMUploadUseFlash&&"function"==typeof SNSIMUploadUseFlash.prototype.addUploader)for(i=0;i<arguments.length;i++){var a=arguments[i];"string"==typeof a.button_placeholder_id&&SNSIMUploadUseFlash.getInstance().addUploader(a)}};k.prototype.initSDK=function(a,c){var d=l.MULTI_TENANCY;
d.ENABLE=!0;d.APP_KEY=a;d.ETP_KEY=c;this.appkey=d.SEPARATOR+d.APP_KEY+d.SEPARATOR+d.ETP_KEY};k.prototype.getTenancy=function(){return l.MULTI_TENANCY};k.prototype.getAppkey=function(){return this.appkey};k.prototype.setRosterProvider=function(a){A.getInstance().init({provider:a||new E})};k.prototype.setChatGroupProvider=function(a){u.getInstance().init({provider:a||new B})};k.prototype.setChatGroupMemberProvider=function(a){q.getInstance().init({provider:a||new C})};k.prototype.setServer=function(a,
c){l.CONNECTION.SERVER_NAME=a;l.CONNECTION.HTTP_BASE=c?c:a};k.prototype.disConnect=function(){d.getInstance().disconnect()};k.prototype.connect=function(){d.getInstance().connect()};k.prototype.getToken=function(){return this._token.token};k.prototype.getTokenExpiration=function(){return this._token.expiration};k.prototype.login=function(a,c,e){this._token={token:c,expiration:e};!YYIMCommonUtil.isStringAndNotEmpty(a)&&l.IS_ANONYMOUS&&(this._anonymousUser=!0);!this.isAnonymous()&&l.MULTI_TENANCY.ENABLE&&
(a=f.getNode(a));d.getInstance().connect(a,c)};k.prototype.logout=function(){d.getInstance().disconnect()};k.prototype.getUserBareJID=function(){return this._user.jid.getBareJID()};k.prototype.getUserFullJID=function(){return this._user.jid.toString()};k.prototype.getUserNode=function(){return f.getNode(this.getUserBareJID())};k.prototype.getUserID=function(){return f.getID(this.getUserBareJID())};k.prototype.getUserResource=function(){return l.RESOURCE};k.prototype.fullSyncRoster=function(a){if(YYIMArrayUtil.isArray(a)){for(var c=
a.length,d=[];c--;)YYIMCommonUtil.isStringAndNotEmpty(a[c].id)&&d.push({jid:f.buildUserJID(f.getNode(a[c].id)),name:a[c].name?a[c].name:a[c].id});p.fullSyncRoster(d)}};k.prototype.deltaSyncRoster=function(a,c){var d=-2,e=-2,g=[],h=[];if(YYIMArrayUtil.isArray(a))for(d=a.length;d--;)YYIMCommonUtil.isStringAndNotEmpty(a[d])&&g.push(f.buildUserJID(f.getNode(a[d])));if(YYIMArrayUtil.isArray(c))for(e=c.length;e--;)YYIMCommonUtil.isStringAndNotEmpty(c[e].id)&&h.push({jid:f.buildUserJID(f.getNode(c[e].id)),
name:c[e].name?c[e].name:c[e].id});-2===d&&-2===e||p.deltaSyncRoster(g,h)};k.prototype.fullSyncChatGroup=function(a){if(YYIMArrayUtil.isArray(a)){for(var c=a.length,d=[];c--;)YYIMCommonUtil.isStringAndNotEmpty(a[c].id)&&d.push({id:f.getID(a[c].id),name:a[c].name?a[c].name:a[c].id});p.fullSyncChatGroup(d)}};k.prototype.deltaSyncChatGroup=function(a,c){var d=-2,e=-2,g=[],h=[];if(YYIMArrayUtil.isArray(a))for(d=a.length;d--;)YYIMCommonUtil.isStringAndNotEmpty(a[d])&&g.push(f.getID(a[d]));if(YYIMArrayUtil.isArray(c))for(e=
c.length;e--;)YYIMCommonUtil.isStringAndNotEmpty(c[e].id)&&h.push({id:f.getID(c[e].id),name:c[e].name?c[e].name:c[e].id});-2===d&&-2===e||p.deltaSyncChatGroup(g,h)};k.prototype.setPresence=function(a){var c={};if(a){if(a.show)for(var d in z)if(z[d]===a.show){c.show=z[d];break}if(!c.show&&a.status)for(d in z)if(z[d]===a.status){c.show=z[d];break}c.status=a.status}c.show=c.show?c.show:z.AVAILABLE;w.setPresence(c)};k.prototype.getVCard=function(a){var c={success:a.success,error:a.error,complete:a.complete};
YYIMCommonUtil.isStringAndNotEmpty(a.id)&&(c.jid=f.buildUserJID(f.getNode(a.id)));p.getVCard(c)};k.prototype.getVCards=function(a){p.getVCards({success:a.success,error:a.error,complete:a.complete})};k.prototype.setVCard=function(a){p.setVCard({vcard:{nickname:a.vcard.nickname,photo:a.vcard.photo,email:a.vcard.email,mobile:a.vcard.mobile,telephone:a.vcard.telephone},success:a.success,error:a.error})};k.prototype.getRosterItems=function(a){A.getInstance().getRosterItems(a)};k.prototype.addRosterItem=
function(a){YYIMCommonUtil.isStringAndNotEmpty(a)&&A.getInstance().addRosterItem(f.buildUserJID(f.getNode(a)))};k.prototype.approveSubscribe=function(a){YYIMCommonUtil.isStringAndNotEmpty(a)&&w.approveSubscribe(f.buildUserJID(f.getNode(a)))};k.prototype.rejectSubscribe=function(a){YYIMCommonUtil.isStringAndNotEmpty(a)&&w.rejectSubscribe(f.buildUserJID(f.getNode(a)))};k.prototype.deleteRosterItem=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.id)&&A.getInstance().deleteRosterItem({jid:f.buildUserJID(f.getNode(a.id)),
success:a.success,error:a.error,complete:a.complete})};k.prototype.queryRosterItem=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.keyword)&&A.getInstance().queryRosterItem(a)};k.prototype.getRostersPresence=function(a){a.username instanceof Array&&(a.username=JSON.stringify(a.username),A.getInstance().getRostersPresence(a))};k.prototype.updateRosterItem=function(a){a&&a.roster&&YYIMCommonUtil.isStringAndNotEmpty(a.roster.id)&&p.updateRosterItem({roster:{jid:f.buildUserJID(f.getNode(a.roster.id)),
name:a.roster.name,groups:a.roster.groups},success:a.success,error:a.error})};k.prototype.queryChatGroup=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.keyword)&&u.getInstance().queryChatGroup(a)};k.prototype.quitChatGroup=function(a){YYIMCommonUtil.isStringAndNotEmpty(a)&&u.getInstance().quitChatGroup(f.buildChatGroupJID(f.getNode(a)))};k.prototype.delGroupMember=function(a,c,d){YYIMCommonUtil.isStringAndNotEmpty(c)&&u.getInstance().delGroupMember(f.buildChatGroupJID(f.getNode(a)),f.buildUserJID(f.getNode(c)),
d)};k.prototype.joinChatGroup=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.id)&&u.getInstance().joinChatGroup({jid:f.buildChatGroupJID(f.getNode(a.id)),success:a.success,error:a.error})};k.prototype.getChatGroupInfo=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.id)&&p.getChatGroupInfo({jid:f.buildChatGroupJID(f.getNode(a.id)),success:a.success,error:a.error})};k.prototype.getSharedFiles=function(a){if(YYIMCommonUtil.isStringAndNotEmpty(a.id)){var c=0,d=20;!isNaN(a.start)&&0<Number(a.start)&&
(c=Number(a.start));!isNaN(a.size)&&0<Number(a.size)&&(d=Number(a.size));p.getSharedFiles({jid:f.buildChatGroupJID(f.getNode(a.id)),start:c,size:d,success:a.success,error:a.error})}};k.prototype.getPubAccount=function(a){p.getPubAccountItems(a)};k.prototype.addPubaccount=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.id)?w.addPubAccount({jid:f.buildPubAccountJID(f.getNode(a.id)),success:a.success,error:a.error}):a.error&&a.error()};k.prototype.removePubaccount=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.id)?
w.removePubAccount({id:Math.uuid(),to:f.buildPubAccountJID(f.getNode(a.id)),success:a.success,error:a.error}):a.error&&a.error()};k.prototype.queryPubaccount=function(a){p.queryPubaccount(a)};k.prototype.getChatGroups=function(a){u.getInstance().getChatGroups(a)};k.prototype.addGroupMember=function(a){if(YYIMCommonUtil.isStringAndNotEmpty(a.roomId)&&YYIMArrayUtil.isArray(a.ids)){var c=f.buildChatGroupJID(f.getNode(a.roomId));a=a.ids.slice();for(var d=0,e=a.length;d<e;d++)a[d]=f.buildUserJID(f.getNode(a[d]));
q.getInstance().addGroupMember(c,a)}};k.prototype.addChatGroup=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.node)&&u.getInstance().addChatGroup(a)};k.prototype.createChatGroup=function(a){a.members instanceof Array||delete a.members;a.name?u.getInstance().createChatGroup(a):a.error&&a.error()};k.prototype.transferChatGroup=function(a){a&&"string"==typeof a.newOwner&&a.to?(a.to=f.buildChatGroupJID(f.getNode(a.to)),u.getInstance().transferChatGroup(a)):a.error&&a.error()};k.prototype.dismissChatGroup=
function(a){a&&a.to?(a.to=f.buildChatGroupJID(f.getNode(a.to)),u.getInstance().dismissChatGroup(a)):a.error&&a.error()};k.prototype.inviteGroupMember=function(a){a.members&&a.members instanceof Array&&a.members.length&&a.to?(a.to=f.buildChatGroupJID(f.getNode(a.to)),u.getInstance().inviteGroupMember(a)):a.error&&a.error()};k.prototype.modifyChatGroupInfo=function(a){a.name&&a.to?(a.to=f.buildChatGroupJID(f.getNode(a.to)),u.getInstance().modifyChatGroupInfo(a)):a.error&&a.error()};k.prototype.kickGroupMember=
function(a){a.member&&"string"==typeof a.member&&a.to?(a.to=f.buildChatGroupJID(f.getNode(a.to)),u.getInstance().kickGroupMember(a)):a.error&&a.error()};k.prototype.exitChatGroup=function(a){a.to?(a.to=f.buildChatGroupJID(f.getNode(a.to)),u.getInstance().exitChatGroup(a)):a.error&&a.error()};k.prototype.collectGroup=function(a){a.to?(a.to=f.buildChatGroupJID(f.getNode(a.to)),a.type="add",u.getInstance().collectChatGroup(a)):a.error&&a.error()};k.prototype.removeCollectGroup=function(a){a.to?(a.to=
f.buildChatGroupJID(f.getNode(a.to)),a.type="remove",u.getInstance().collectChatGroup(a)):a.error&&a.error()};k.prototype.updateChatGroup=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.id)&&u.getInstance().updateChatGroup({jid:f.buildChatGroupJID(f.getNode(a.id)),name:a.name,desc:a.desc,photo:a.photo,error:a.error,success:a.success,complete:a.complete})};k.prototype.getGroupMembers=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.id)&&q.getInstance().getGroupMembers({jid:f.buildChatGroupJID(f.getNode(a.id)),
success:a.success,error:a.error,complete:a.complete})};k.prototype.getHistoryMessage=function(a){if(!a.start||isNaN(a.start))a.start=0;if(!a.num||isNaN(a.num))a.num=100;y.getHistoryMessage(a)};k.prototype.getOfflineMessage=function(){var a={};a.id=this.getUserID();y.getOfflineMessage(a)};k.prototype.sendReceiptsPacket=function(a){y.sendReceiptsPacket(a)};k.prototype.sendReadedReceiptsPacket=function(a){y.sendReadedReceiptsPacket(a)};k.prototype.sendMessage=function(a){y.sendMessage(a)};k.prototype.sendAccessoryMessage=
function(a){a.id=Math.uuid();var c=new SNSFile(a.body.content.name,a.body.content.attachId,a.body.content.size);a.body={content:c,contentType:a.contentType||n.FILE,dateline:(new Date).getTime()};YYIMChat.sendMessage(a)};k.prototype.sendFormMessage=function(a){var c={token:this.getToken(),creator:this.getUserID()+"."+l.MULTI_TENANCY.APP_KEY+"."+l.MULTI_TENANCY.ETP_KEY,receiver:a.to+"."+l.MULTI_TENANCY.APP_KEY+"."+l.MULTI_TENANCY.ETP_KEY,mediaType:a.mediaType||2,randomId:Math.uuid(),name:a.file.name,
size:a.file.size},d=l.SERVLET.FILE_UPLOAD_URL+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/upload",d=d+("?"+jQuery.param(c));jQuery.ajax({url:d,type:"post",dataType:"json",data:a.data,processData:!1,contentType:!1,success:function(d){d&&d.attachId?(d={to:a.to,body:{content:{name:a.file.name,size:a.file.size,attachId:d.attachId}},type:a.type,success:function(c){var d={name:c.body.content.name,size:c.body.content.size,type:c.body.content.type,path:YYIMChat.getFileUrl(c.body.content.path)};
c.body.content=d;c.to=YYIMChat.getJIDUtil(c.to);a.success&&a.success(c)}},d.contentType=1===c.mediaType?n.IMAGE:n.FILE,k.getInstance().sendAccessoryMessage(d)):a.error&&a.error()},error:function(c,d){a.error&&a.error()},complete:function(c,d){a.complete&&a.complete()}})};k.prototype.sendShareMessage=function(a){a.content=a.sharebody||a.content;a.contentType=n.SHARE;this.postMessage(a)};k.prototype.sendWhiteBoardMessage=function(a){a.contentType=n.WHITEBOARD;this.postMessage(a)};k.prototype.sendTextMessage=
function(a){a.content=a.msg||a.content;a.contentType=n.TEXT;this.postMessage(a)};k.prototype.postMessage=function(a){a.id=Math.uuid();a.body={extend:a.extend,content:a.content,contentType:a.contentType,dateline:(new Date).getTime()};a.style&&"string"!=typeof a.style&&(a.body.style=JSON.stringify(a.style));this.sendMessage(a)};k.prototype.sendPic=function(a){var c=f.getNode(a.to),c="groupchat"==a.type?f.buildChatGroupJID(c):f.buildUserJID(c),c={fileTypeExts:"jpg;jpeg;png;bmp;gif",fileSizeLimit:5120,
breakPoints:!1,saveInfoLocal:!1,removeTimeout:100,uploader:l.SERVLET.FILE_UPLOAD_SERVLET,uploadIdPrefix:"image_upload_",inputId:a.fileInputId,to:c,type:n.IMAGE,chatType:a.type,onUploadSuccess:a.success,onUploadProgress:a.progress,onUploadError:a.error,showProcess:!1,processId:"udnProcessBar"};a.resource&&(c.resource=a.resource);FileUpload.getInstance(a.fileInputId,c);FileUpload.getInstance(a.fileInputId).sendFile(document.getElementById(a.fileInputId))};k.prototype.sendFile=function(a){var c=f.getNode(a.to),
c="groupchat"==a.type?f.buildChatGroupJID(c):f.buildUserJID(c),c={fileTypeExts:"*",fileSizeLimit:99999999,breakPoints:!0,saveInfoLocal:!0,removeTimeout:100,uploader:l.SERVLET.FILE_UPLOAD_SERVLET,uploadIdPrefix:"bp_upload_",inputId:a.fileInputId,to:c,type:n.FILE,chatType:a.type,onUploadSuccess:a.success,onUploadProgress:a.progress,onUploadError:a.error,showProcess:!0,processId:"udnProcessBar"};a.resource&&(c.resource=a.resource);FileUpload.getInstance(a.fileInputId,c);FileUpload.getInstance(a.fileInputId).sendFile(document.getElementById(a.fileInputId))};
k.prototype.uploadAvatar=function(a){var c=f.getNode(a.to),c="groupchat"==a.type?f.buildChatGroupJID(c):f.buildUserJID(c);FileUpload.getInstance(a.fileInputId,{fileTypeExts:"jpg;jpeg;png;bmp;gif",fileSizeLimit:5120,breakPoints:!1,saveInfoLocal:!1,removeTimeout:100,uploader:l.SERVLET.FILE_UPLOAD_SERVLET,uploadIdPrefix:"user_avatar_upload_",inputId:a.fileInputId,to:c,type:UPLOAD_AVATAR,onUploadSuccess:a.success,onUploadError:a.error,showProcess:!1,processId:"udnProcessBar"});FileUpload.getInstance(a.fileInputId).sendFile(document.getElementById(a.fileInputId))};
k.prototype.getServerName=function(){return l.CONNECTION.SERVER_NAME};k.prototype.getFileUrl=function(a,c){var d,e;this.isAnonymous()?(d=this.getUserFullJID(),e="anonymous"):(d=this.getUserNode(),e=this.getToken());d={token:e,attachId:a,downloader:d};"undefined"!==typeof c&&(d.mediaType=2===c?2:1);e=l.SERVLET.FILE_UPLOAD_URL+l.MULTI_TENANCY.ETP_KEY+"/"+l.MULTI_TENANCY.APP_KEY+"/download";return e+="?"+jQuery.param(d)};k.prototype.getServletPath=function(){return l.SERVLET};k.prototype.getJIDUtil=
function(){return f};k.prototype.getArrayUtil=function(){return YYIMArrayUtil};k.prototype.isAnonymous=function(){return this._anonymousUser};k.prototype.enableAnonymous=function(){return l.IS_ANONYMOUS};k.prototype.getBrowser=function(){return l.BROWSER};k.prototype.isOnline=function(a){return!0==A.getInstance()._onlineList.get(a)};k.prototype.defaultImg=function(a){var c=a.src;a.src="res/skin/default/icons/avatar.gif";a.setAttribute("data-url",c)};k.prototype.multiPartyCall=function(a){if("undefined"===
typeof a||"undefined"===typeof a.caller||!a.phones instanceof Array||!a.phones.length)a.error&&a.error();else if(YYIMRegularUtil.phone.test(a.caller)){var c=[],d;for(d in a.phones){var e=a.phones[d].toString();if(YYIMRegularUtil.phone.test(e)&&-1===c.indexOf(e)&&(c.push(e),e=c.join(","),c.length>l.MULTIPARTYCALL.PARTYMAXLENGTH||e.length>l.MULTIPARTYCALL.PHONESMAXLENGTH)){c.pop();break}}if(c.length){a.caller=a.caller.toString();a.phones=c;if(!0!==a.accountMmanaged&&(a.phones=c.join(","),a.account=
a.account?a.account:l.MULTIPARTYCALL.ACCOUNT,a.key=a.key?a.key:l.MULTIPARTYCALL.KEY,"undefined"===typeof a.account||"undefined"===typeof a.key)){a.error&&a.error();return}x.multiPartyCall(a)}else a.error&&a.error()}else a.error&&a.error()};return k.getInstance()}();
